var xe={wsUrl:(()=>{let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,s=location.pathname.replace(/\/+$/,"");return s&&s!=="/"?`${t}${s}`:t})(),silenceMs:1500,maxFileSize:10485760};var je=new Set,Rs=50;function Xt(e){let t=(e||"").trim().slice(0,200),s=0;for(let n=0;n<t.length;n++)s=(s<<5)-s+t.charCodeAt(n),s=s&s;return s.toString(36)}function ce(e){let t=Xt(e);if(je.add(t),je.size>Rs){let s=je.values();for(let n=0;n<10;n++)je.delete(s.next().value)}}function It(e){return je.has(Xt(e))}function lt(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function le(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^(.*)$/,"<p>$1</p>").replace(/<p><\/p>/g,"")}function W(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function Bt(e){return e?.content?typeof e.content=="string"?e.content:Array.isArray(e.content)&&e.content.find(s=>s.type==="text")?.text||null:null}function Qt(){let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,s=location.pathname.replace(/\/+$/,"");return s&&s!=="/"?`${t}${s}/realtime`:`${t}/realtime`}function Zt(e){let t=new Int16Array(e.length);for(let o=0;o<e.length;o++){let i=Math.max(-1,Math.min(1,e[o]));t[o]=i<0?i*32768:i*32767}let s=new Uint8Array(t.buffer),n="";for(let o=0;o<s.length;o++)n+=String.fromCharCode(s[o]);return btoa(n)}function es(e){let t=atob(e),s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);let n=new Int16Array(s.buffer),o=new Float32Array(n.length);for(let i=0;i<n.length;i++)o[i]=n[i]/(n[i]<0?32768:32767);return o}var l=document.getElementById("messages"),bt=document.getElementById("welcome"),p=document.getElementById("text-input"),be=document.getElementById("send-btn"),Fe=document.getElementById("voice-btn"),Ws=document.getElementById("notes-btn"),At=document.getElementById("status"),Yn=document.getElementById("timer"),$t=document.getElementById("toast"),Os=document.getElementById("upload-btn"),pt=document.getElementById("file-input"),se=document.getElementById("bottom"),re=document.getElementById("spark-status"),de=document.getElementById("session-status-indicator");function ze(e){re&&(re.classList.remove("connected","connecting"),e==="connected"?(re.classList.add("connected"),re.title="Clawdbot Gateway: Connected"):e==="connecting"?(re.classList.add("connecting"),re.title="Clawdbot Gateway: Connecting..."):re.title="Clawdbot Gateway: Disconnected"),de&&(de.classList.remove("connected","connecting"),e==="connected"?(de.classList.add("connected"),de.title="Connected"):e==="connecting"?(de.classList.add("connecting"),de.title="Connecting..."):de.title="Disconnected")}var ds=document.getElementById("voice-bar"),qs=document.getElementById("close-voice-btn"),jn=document.getElementById("waveform"),T=document.getElementById("voice-content"),ts=document.getElementById("voice-status"),zn=document.getElementById("notes-content"),wt=document.getElementById("notes-timer"),Jn=document.getElementById("notes-bar"),Us=document.getElementById("close-notes-btn"),_s=document.getElementById("delete-notes-btn"),Gn=document.getElementById("notes-recording"),Kn=document.getElementById("notes-results"),O=document.getElementById("notes-status"),Ae=document.getElementById("notes-transcription-msg"),$e=document.getElementById("notes-transcription"),Ne=document.getElementById("notes-summary-msg"),De=document.getElementById("notes-summary"),Vs=document.getElementById("notes-save-btn"),Ys=document.getElementById("notes-delete-btn"),js=document.getElementById("notes-back-btn"),q={transcription:"",summary:""},zs=document.getElementById("close-btn"),et=document.getElementById("history-btn"),Js=document.getElementById("theme-btn");function Gs(){let e=localStorage.getItem("theme");e&&document.documentElement.setAttribute("data-theme",e)}Gs();Js?.addEventListener("click",()=>{let e=document.documentElement.getAttribute("data-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,s;e==="dark"?s="light":e==="light"?s="dark":s=t?"light":"dark",document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s)});var u=null,we="chat",A="intro",us=!1,ke=!1,Te=0,Nt=5,V=!1,Je=null,Ce=null,B=null,Et=[],Ot=null,qt=null,kt=null,K=null,ms={},gt={},ps={dev:{name:"Dev Mode",icon:"\u{1F468}\u200D\u{1F4BB}",notifyWhatsApp:!0},research:{name:"Research Mode",icon:"\u{1F52C}",notifyWhatsApp:!0},plan:{name:"Plan Mode",icon:"\u{1F4CB}",notifyWhatsApp:!0},articulate:{name:"Articulate Mode",icon:"\u270D\uFE0F",notifyWhatsApp:!1},dailyreports:{name:"Daily Reports",icon:"\u{1F4CA}",notifyWhatsApp:!0},videogen:{name:"Video Gen",icon:"\u{1F3AC}",notifyWhatsApp:!0}};async function Ks(){try{gt=(await(await fetch("/api/modes")).json()).modes||{},console.log("\u{1F4E6} Loaded mode configs:",Object.keys(gt))}catch(e){console.error("Failed to load mode configs:",e),gt=ps}}function gs(e){return gt[e]||ps[e]||{name:e,icon:"\u{1F4E6}"}}function Xs(){let e=document.getElementById("mode-indicator");if(K){let t=gs(K);e||(e=document.createElement("div"),e.id="mode-indicator",e.className="mode-indicator",document.querySelector(".top-bar")?.appendChild(e)),e.innerHTML=`
      <span class="mode-icon">${t.icon}</span>
      <span class="mode-name">${t.name}</span>
      <button class="mode-exit-btn" onclick="exitMode()">\u2715</button>
    `,e.style.display="flex"}else e&&(e.style.display="none")}function Qs(e){let t=ms[e]||[];if(l.querySelectorAll(".msg, .mode-empty-state").forEach(s=>s.remove()),t.length===0){let s=gs(e),n=document.createElement("div");n.className="mode-empty-state",n.innerHTML=`
      <div class="mode-empty-icon">${s.icon}</div>
      <div class="mode-empty-title">${s.name}</div>
      <div class="mode-empty-desc">Start a conversation in this mode.</div>
    `,l.appendChild(n)}else for(let s of t){let n=Bt(s);n&&addMessage(s.role==="assistant"?"bot":"user",n)}scrollToBottom()}Ks();var f=null,D=null,He=!1;function Ut(e=!1){return D&&!e||(D=fetch("/api/messages/all").then(t=>t.json()).then(t=>{if(f=t.messages||[],console.log(`\u{1F4DC} Pre-loaded ${f.length} messages`),f.length>0){let s=f[f.length-1];s.timestamp&&s.timestamp>U&&(U=s.timestamp,console.log(`\u{1F4DC} Set lastMessageTimestamp to ${U}`))}return f}).catch(t=>(console.error("Failed to preload history:",t),f=[],[]))),D}function ss(){D=null,He=!1,Ut(!0)}function _t(){He||!f||f.length===0||(He=!0,f.forEach(e=>{let t=document.createElement("div");if(t.className=`msg ${e.role==="user"?"user":"bot"}`,e.role==="user"?t.textContent=e.text:t.innerHTML=le(e.text),e.timestamp){let s=document.createElement("span");s.className="msg-time",s.textContent=xt(e.timestamp),t.appendChild(s)}l.appendChild(t)}),l.scrollTop=l.scrollHeight)}var Ie=!1;function hs(){if(Ie){console.log("showIntroPage blocked - transition in progress");return}Ie=!0,console.log("showIntroPage called"),requestAnimationFrame(()=>{A="intro",K=null,Xs(),us=!1,p&&(p.placeholder="Talk to me"),document.body.classList.remove("chatfeed-mode"),bt&&(bt.style.display=""),l?.querySelectorAll(".msg").forEach(e=>e.remove()),X(),He=!1,et&&et.classList.remove("hidden"),l&&(l.scrollTop=0,l.style.overflow="hidden"),Ie=!1})}function Re(e={}){if(Ie){console.log("showChatFeedPage blocked - transition in progress");return}Ie=!0,console.log("showChatFeedPage called"),requestAnimationFrame(()=>{A="chatfeed",document.body.classList.add("chatfeed-mode"),bt&&(bt.style.display="none"),et&&et.classList.add("hidden"),l&&(l.style.overflow="auto"),!e.skipHistory&&f&&f.length>0&&_t(),Ie=!1})}et?.addEventListener("click",async()=>{if(f===null&&D&&await D,Re(),!f||f.length===0){let e=document.createElement("div");e.className="msg system",e.textContent="No chat history yet",l.appendChild(e)}});zs?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("Close button clicked"),hs()});var Zs=document.getElementById("close-chat-btn");Zs?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),document.body.classList.add("slide-out"),setTimeout(()=>{document.body.classList.remove("slide-out"),hs()},250)});var fs=50,vs=0,Ht=!1;l?.addEventListener("touchstart",e=>{A==="intro"&&(vs=e.touches[0].clientY,Ht=!1)},{passive:!0});l?.addEventListener("touchmove",e=>{if(A!=="intro"||Ht)return;e.touches[0].clientY-vs>=fs&&(Ht=!0,ys())},{passive:!0});l?.addEventListener("wheel",e=>{A==="intro"&&e.deltaY<-fs&&ys()},{passive:!0});async function ys(){Y();try{f===null&&D?await Promise.race([D,new Promise((e,t)=>setTimeout(()=>t("timeout"),3e3))]):f===null&&await Promise.race([Ut(!0),new Promise((e,t)=>setTimeout(()=>t("timeout"),3e3))])}catch(e){console.log("History load timeout or error:",e)}if(X(),document.body.classList.add("slide-in"),Re(),setTimeout(()=>document.body.classList.remove("slide-in"),400),!f||f.length===0){let e=document.createElement("div");e.className="msg system",e.textContent="No chat history yet",l.appendChild(e)}}function bs(e=100){if(!l)return!0;let{scrollTop:t,scrollHeight:s,clientHeight:n}=l;return s-t-n<e}function st(){bs()&&(l.scrollTop=l.scrollHeight)}function Pt(e,t,s={}){if(A==="intro")if(s.userInitiated)f&&f.length>0&&!He&&_t(),Re({skipHistory:!0});else return t==="bot"&&r("New message from Spark"),null;ce(e);let n=document.createElement("div");n.className=`msg ${t}`,t==="bot"?n.innerHTML=le(e):n.textContent=e;let o=s.timestamp;if(o){let i=document.createElement("span");i.className="msg-time",i.textContent=xt(o),n.appendChild(i)}return l.appendChild(n),t==="user"?l.scrollTop=l.scrollHeight:st(),n}function Y(){if(A==="intro")return;X();let e=document.createElement("div");e.className="msg bot thinking",e.id="thinking-indicator",e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div>',l.appendChild(e),st()}function X(){document.getElementById("thinking-indicator")?.remove()}function ws(e){let t=document.getElementById("thinking-indicator");if(!t)return Y(),ws(e);t.innerHTML=`
    <div class="thinking-content">
      <span class="thinking-status">${lt(e)}</span>
      <div class="thinking-dots"><span></span><span></span><span></span></div>
    </div>
  `,st()}function Be(e){At&&(At.textContent=e,At.classList.toggle("show",!!e))}function r(e,t=!1){$t.textContent=e,$t.className=t?"show error":"show",setTimeout(()=>$t.className="",3e3)}var I=null,S=null,Qe=null,pe=null,z=null,Q=[],Z=!1;var Ze=null;function en(){let e=new(window.AudioContext||window.webkitAudioContext),t=e.sampleRate,s=.3,n=s*t,o=e.createBuffer(1,n,t),i=o.getChannelData(0);for(let a=0;a<n;a++){let g=a/t,d=880,m=Math.exp(-8*g/s);i[a]=m*.2*Math.sin(2*Math.PI*d*g)}return{ctx:e,buffer:o}}function rt(){Ze||(console.log("\u{1F50A} Thinking sound started"),ns(),Ze=setInterval(ns,2e3))}function ns(){let e=null;try{let t=en();e=t.ctx;let s=t.buffer,n=e.createBufferSource(),o=e.createGain();n.buffer=s,o.gain.setValueAtTime(.2,e.currentTime),n.connect(o),o.connect(e.destination),n.start(),n.onended=()=>{n.disconnect(),o.disconnect(),e.close().catch(()=>{})}}catch(t){console.error("Thinking sound error:",t),e&&e.state!=="closed"&&e.close().catch(()=>{})}}function F(){Ze&&(clearInterval(Ze),Ze=null,console.log("\u{1F507} Thinking sound stopped"))}var ue=null,y=null;function dt(e,t){if(!T)return null;let s=document.createElement("div");return s.className=`voice-msg ${e}`,s.textContent=t,T.appendChild(s),T.scrollTop=T.scrollHeight,s}function M(e){ts&&(ts.textContent=e)}async function tn(){if(!(Z||Q.length===0)){for(Z=!0;Q.length>0;){let e=Q.shift();try{z||(z=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}));let t=es(e),s=z.createBuffer(1,t.length,24e3);s.getChannelData(0).set(t);let n=z.createBufferSource();n.buffer=s,n.connect(z.destination),await new Promise(o=>{n.onended=o,n.start()})}catch(t){console.error("Audio playback error:",t)}}await new Promise(e=>setTimeout(e,100)),Z=!1}}var ut=[];async function sn(){if(!Z){for(;Q.length>0;)ut.push(Q.shift());if(ut.length>0){Z=!0;let e=null;try{let t=ut.join("");ut=[];let s=atob(t),n=new Uint8Array(s.length);for(let d=0;d<s.length;d++)n[d]=s.charCodeAt(d);let o=new Int16Array(n.buffer),i=new Float32Array(o.length);for(let d=0;d<o.length;d++)i[d]=o[d]/(o[d]<0?32768:32767);e=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});let a=e.createBuffer(1,i.length,24e3);a.getChannelData(0).set(i);let g=e.createBufferSource();g.buffer=a,g.connect(e.destination),await new Promise(d=>{g.onended=()=>{e.close().catch(()=>{}),d()},g.start()}),hybridWs&&hybridWs.readyState===WebSocket.OPEN&&(hybridWs.send(JSON.stringify({type:"audio_playback_ended"})),console.log("\u{1F50A} Notified server: playback ended"))}catch(t){console.error("TTS playback error:",t),e&&e.state!=="closed"&&e.close().catch(()=>{}),hybridWs&&hybridWs.readyState===WebSocket.OPEN&&hybridWs.send(JSON.stringify({type:"audio_playback_ended"}))}await new Promise(t=>setTimeout(t,100)),Z=!1}}}function ks(){Q=[],Z=!1,z&&(z.close().catch(()=>{}),z=null)}var ht=null,ve=null;function nn(){function e(){if(ve){let t=new Uint8Array(ve.frequencyBinCount);ve.getByteFrequencyData(t);let s=0;for(let a=0;a<t.length;a++)s+=t[a];let o=s/t.length/255>.05,i=document.getElementById("voice-bar");i&&i.classList.toggle("speaking",o)}ht=requestAnimationFrame(e)}e()}function on(){ht&&(cancelAnimationFrame(ht),ht=null);let e=document.getElementById("voice-bar");e&&e.classList.remove("speaking")}async function an(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return r("Microphone not supported in this browser",!0),!1;S=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});try{Qe=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:24e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}})}catch(t){return t.name==="NotAllowedError"?r("Microphone permission denied. Please allow access.",!0):t.name==="NotFoundError"?r("No microphone found",!0):r("Microphone error: "+t.message,!0),console.error("Microphone access error:",t),S&&(S.close().catch(()=>{}),S=null),!1}let e=S.createMediaStreamSource(Qe);return ve=S.createAnalyser(),ve.fftSize=256,e.connect(ve),nn(),pe=S.createScriptProcessor(4096,1,1),pe.onaudioprocess=t=>{if(I&&I.readyState===WebSocket.OPEN){let s=t.inputBuffer.getChannelData(0),n=0;for(let a=0;a<s.length;a++)n+=s[a]*s[a];let o=Math.sqrt(n/s.length);if(Z&&o<.04)return;let i=Zt(s);I.send(JSON.stringify({type:"audio",data:i}))}},e.connect(pe),pe.connect(S.destination),console.log("\u{1F3A4} Audio capture started"),!0}catch(e){return console.error("Audio capture error:",e),r("Audio initialization failed: "+e.message,!0),S&&(S.close().catch(()=>{}),S=null),!1}}function cn(){on(),ve=null,pe&&(pe.disconnect(),pe=null),Qe&&(Qe.getTracks().forEach(e=>e.stop()),Qe=null),S&&(S.close().catch(()=>{}),S=null),console.log("\u{1F3A4} Audio capture stopped")}function Ls(){let e=Qt();console.log("\u{1F517} Connecting to realtime:",e),I=new WebSocket(e),I.onopen=async()=>{Te=0,console.log("\u2705 Realtime connected"),Be(""),await an()||tt()},I.onmessage=t=>{try{let s=JSON.parse(t.data);ln(s)}catch(s){console.error("Failed to parse realtime message:",s)}},I.onclose=()=>{if(console.log("\u{1F50C} Realtime disconnected"),ke&&Te<Nt){let t=Math.min(2e3*Math.pow(2,Te),3e4);Te++,Be(`Reconnecting (${Te}/${Nt})...`),setTimeout(Ls,t)}else Te>=Nt&&(r("Voice connection failed. Please try again.",!0),tt())},I.onerror=t=>{console.error("Realtime WebSocket error:",t)}}function ln(e){switch(e.type){case"ready":let t=e.mode==="hybrid"?"Hybrid (Claude)":"Direct";console.log(`\u{1F399}\uFE0F Realtime session ready - Mode: ${t}`),M("Listening");break;case"user_speaking":os(!0),M("Hearing you..."),ks(),F(),ue=null,y=null;break;case"user_stopped":os(!1),M("Processing..."),rt();break;case"interim":case"transcript":if(F(),e.text&&T){if(ue)ue.textContent=e.text;else{let i=document.createElement("div");i.className="voice-msg user",i.textContent=e.text,y&&y.parentNode===T?T.insertBefore(i,y):T.appendChild(i),ue=i}T.scrollTop=T.scrollHeight}rt();break;case"processing":let s=e.engine||"Spark Opus",n=e.message||`Checking with ${s}...`;console.log(`\u{1F9E0} ${n}`),M(n),rt(),y?(y.textContent=n,y.classList.add("thinking")):(y=dt("assistant",n),y.classList.add("thinking"));break;case"text_delta":F(),M("Speaking..."),e.delta&&(y?(y.textContent+=e.delta,y.classList.remove("thinking")):y=dt("assistant",e.delta),T&&(T.scrollTop=T.scrollHeight));break;case"text":F(),e.content&&(y?(y.textContent=e.content,y.classList.remove("thinking")):y=dt("assistant",e.content));break;case"tts_start":console.log("\u{1F50A} Generating speech..."),M("Speaking..."),F();break;case"audio_chunk":F(),M("Speaking..."),e.data&&(Q.push(e.data),sn());break;case"audio_delta":F(),M("Speaking..."),e.data&&(Q.push(e.data),tn());break;case"audio_done":console.log("\u{1F50A} Audio complete");break;case"tool_call":console.log("\u{1F527} Tool call:",e.name);let o=e.name?.replace("get_","").replace("ask_","").replace("_"," ")||"info";M(`Checking ${o}...`),y||(y=dt("assistant",`Checking ${o}...`),y.classList.add("thinking")),rt();break;case"done":F(),ue=null,y=null,M("Listening");break;case"error":F(),console.error("Realtime error:",e.message),r(e.message||"Voice error",!0),M("Error");break;case"disconnected":F(),ke&&r("Disconnected",!0);break}}function Es(){we="voice",ke=!0,document.body.classList.add("voice-mode"),se?.classList.add("voice-active"),ue=null,y=null,M("Connecting..."),Be("Connecting..."),Ls()}function tt(){ke=!1,document.body.classList.remove("voice-mode"),se?.classList.remove("voice-active"),ds?.classList.remove("speaking"),ue=null,y=null,cn(),ks(),I&&(I.send(JSON.stringify({type:"stop"})),I.close(),I=null),we="chat"}function os(e){ds?.classList.toggle("speaking",e)}Fe?.addEventListener("click",Es);qs?.addEventListener("click",tt);p?.addEventListener("input",()=>{let e=p.value.trim().length>0||fe;be?.classList.toggle("show",e),Fe?.classList.toggle("hidden",e),p&&(p.style.height="auto",p.style.height=Math.min(p.scrollHeight,120)+"px")});p?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Vt())});p?.addEventListener("focus",()=>{ke&&tt(),we="chat",se?.classList.add("focused")});p?.addEventListener("blur",()=>{setTimeout(()=>{document.activeElement!==p&&se?.classList.remove("focused")},100)});be?.addEventListener("click",Vt);async function Vt(){let e=p?.value.trim();!e||V||(p.value="",p.style.height="auto",be?.classList.remove("show"),Fe?.classList.remove("hidden"),await We(e,"chat"))}async function rn(){try{return kt=await navigator.mediaDevices.getUserMedia({audio:!0}),B=new MediaRecorder(kt),B.ondataavailable=e=>{e.data.size>0&&Et.push(e.data)},B.onstop=gn,!0}catch{return r("Mic access denied",!0),!1}}function Ss(){kt?.getTracks().forEach(e=>e.stop()),kt=null,B=null}function xs(){if(!B){rn().then(e=>e&&xs());return}Et=[],B.start(),Ot=Date.now(),we="notes",document.body.classList.add("notes-mode"),se?.classList.add("notes-active"),qt=setInterval(is,1e3),is()}function dn(){B?.state==="recording"&&(B.stop(),clearInterval(qt),se?.classList.remove("notes-active"))}function Yt(){document.body.classList.remove("notes-mode"),document.body.classList.remove("notes-results"),se?.classList.remove("notes-active"),Ts(),we="chat"}async function un(){if(!q.transcription&&!q.summary){r("No note to save",!0);return}try{let e=await fetch("/api/notes/save-file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcription:q.transcription,summary:q.summary,timestamp:Date.now()})}),t=await e.json();e.ok?(r("Note saved \u2713"),Yt()):r("Failed to save",!0)}catch{r("Save failed",!0)}}function mn(){q={transcription:"",summary:""},$e&&($e.textContent=""),De&&(De.textContent=""),r("Note deleted"),Yt()}function pn(){B?.state==="recording"&&(B.onstop=()=>{r("Recording discarded"),Ss()},B.stop(),clearInterval(qt),Et=[],document.body.classList.remove("notes-mode"),se?.classList.remove("notes-active"),we="chat")}function is(){let e=Math.floor((Date.now()-Ot)/1e3);wt&&(wt.textContent=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`)}async function gn(){let e=new Blob(Et,{type:"audio/webm"}),t=Math.floor((Date.now()-Ot)/1e3);Ss(),document.body.classList.add("notes-results"),O&&(O.textContent="Transcribing...",O.style.display="block"),Ae&&(Ae.style.display="none"),Ne&&(Ne.style.display="none"),q={transcription:"",summary:""};let s=new FileReader;s.onload=()=>hn(s.result.split(",")[1],t),s.readAsDataURL(e)}function hn(e,t){if(!u||u.readyState!==WebSocket.OPEN){r("Not connected",!0);return}V=!0,u.send(JSON.stringify({type:"voice_note",audio:e,duration:t}))}function Ts(){document.body.classList.remove("notes-results"),wt&&(wt.textContent="0:00"),O&&(O.style.display="block"),Ae&&(Ae.style.display="none"),Ne&&(Ne.style.display="none"),$e&&($e.textContent=""),De&&(De.textContent=""),q={transcription:"",summary:""}}Ws?.addEventListener("click",()=>{ke&&tt(),Ts(),xs()});Us?.addEventListener("click",()=>{B?.state==="recording"&&dn()});_s?.addEventListener("click",pn);Vs?.addEventListener("click",un);Ys?.addEventListener("click",mn);js?.addEventListener("click",Yt);var Ft=localStorage.getItem("spark_session_id"),U=0,Dt=!1;async function as(){if(A==="chatfeed")try{console.log("\u{1F504} Catching up on missed messages since:",U);let e=await fetch(`/api/messages/recent?since=${U}`);if(!e.ok)return;let s=(await e.json()).messages||[];if(s.length===0){console.log("\u{1F504} No missed messages");return}console.log(`\u{1F504} Found ${s.length} missed message(s)`);for(let n of s){if(It(n.text))continue;ce(n.text);let o=document.createElement("div");o.className=`msg ${n.role==="user"?"user":"bot"}`,n.role==="user"?o.textContent=n.text:o.innerHTML=le(n.text),l.appendChild(o),n.timestamp>U&&(U=n.timestamp)}st()}catch(e){console.error("Catch-up failed:",e)}}function Rt(){let e=xe.wsUrl;Ft&&(e+=(e.includes("?")?"&":"?")+`session=${Ft}`),console.log("\u{1F50C} Connecting to:",e),ze("connecting");try{u=new WebSocket(e),u.onopen=()=>{console.log("\u2705 Chat WebSocket connected"),ze("connected"),Dt&&as(),Dt=!1},u.onclose=t=>{console.log("\u{1F50C} Chat WebSocket closed:",t.code,t.reason),ze("disconnected"),Dt=!0,setTimeout(Rt,2e3)},u.onerror=t=>{console.error("\u274C Chat WebSocket error:",t),ze("disconnected")},document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(console.log("\u{1F441}\uFE0F Page visible, checking WebSocket..."),!u||u.readyState!==WebSocket.OPEN?(console.log("\u{1F504} WebSocket stale, reconnecting..."),Rt()):as())}),u.onmessage=t=>{try{let s=JSON.parse(t.data);console.log("\u{1F4E8} WS received:",s.type,s.content?.slice?.(0,50)||""),fn(s)}catch(s){console.error("\u274C WS message error:",s,t.data?.slice?.(0,100))}}}catch(t){console.error("\u274C Failed to create WebSocket:",t),ze("disconnected")}}async function We(e,t){if(!u||u.readyState!==WebSocket.OPEN){r("Not connected",!0);return}if(A==="intro"){if(D)try{await D,console.log("\u{1F4DC} History ready, preloaded:",f?.length||0,"messages")}catch{console.log("History load failed, continuing anyway")}!K&&f&&f.length>0&&!He&&(console.log("\u{1F4DC} Rendering history before first message"),_t()),Re({skipHistory:!0})}V=!0;let s=document.createElement("div");s.className="msg user",s.textContent=e,l.appendChild(s),l.scrollTop=l.scrollHeight,ce(e),Y(),K?(console.log(`\u{1F4E6} Sending to ${K} mode session`),u.send(JSON.stringify({type:"mode_message",sparkMode:K,text:e}))):u.send(JSON.stringify({type:"transcript",text:e,mode:t}))}function fn(e){switch(e.type){case"ready":e.sessionId&&(Ft=e.sessionId,localStorage.setItem("spark_session_id",e.sessionId),console.log("\u{1F4CB} Session:",e.sessionId)),e.pending&&(console.log("\u23F3 Pending request detected - showing loading"),Y()),console.log("\u2705 Chat ready");break;case"sync":if(console.log("\u{1F4E1} Sync message:",e.message?.source,e.message?.text?.slice(0,50)),ss(),e.message&&e.message.text){if(e.message.timestamp&&e.message.timestamp>U&&(U=e.message.timestamp),It(e.message.text)){console.log("\u{1F4E1} Skipping duplicate sync message (hash match)");break}if(A==="chatfeed"){ce(e.message.text);let t=document.createElement("div");t.className=`msg ${e.message.role==="user"?"user":"bot"}`,e.message.role==="user"?t.textContent=e.message.text:t.innerHTML=le(e.message.text),e.message.source==="whatsapp"&&(t.title="From WhatsApp"),l.appendChild(t),st(),e.message.role==="bot"&&X()}else A==="intro"&&e.message.role==="bot"&&r("New message from Spark")}break;case"thinking":console.log("\u{1F914} Server thinking..."),k&&ge.classList.contains("show")?qe():Y();break;case"progress":console.log("\u{1F4CA} Progress:",e.status),k&&ge.classList.contains("show")?As(e.status):ws(e.status);break;case"text":if(console.log("\u2705 Text message received:",e.content?.slice?.(0,100)),document.body.classList.contains("notes-mode")&&De)e.content&&(O&&(O.style.display="none"),De.innerHTML=le(e.content),q.summary=e.content,Ne&&(Ne.style.display="block"));else if(k&&ge.classList.contains("show"))Lt(),e.content&&P("bot",e.content);else{X(),Be("");let t=l?.querySelector(".msg.system:last-child");t?.textContent==="Transcribing..."&&t.remove(),e.content?(Pt(e.content,"bot"),console.log("\u2705 Bot message added to DOM")):console.warn("\u26A0\uFE0F Empty text content received")}break;case"transcription":if(document.body.classList.contains("notes-mode")&&$e)$e.textContent=e.text,q.transcription=e.text,Ae&&(Ae.style.display="block"),O&&(O.textContent="Summarizing...");else{let t=l?.querySelector(".msg.system:last-child");t?.textContent==="Transcribing..."&&t.remove(),Pt("\u{1F4DD} "+e.text,"bot")}break;case"audio":vn(e.data);break;case"done":V=!1,_=!1,Be(""),Pe(),Ms(),ss(),we==="voice"&&!ke&&Es();break;case"error":k&&ge.classList.contains("show")?(Lt(),P("bot",`Error: ${e.message||"Something went wrong"}`),_=!1):X(),r(e.message||"Error",!0),V=!1,Be("");break;case"mode_history":console.log(`\u{1F4E6} Mode history received for ${e.mode}:`,e.messages?.length||0,"messages"),e.mode&&e.messages&&(ms[e.mode]=e.messages,K===e.mode&&Qs(e.mode));break}}async function vn(e){Je||(Je=new(window.AudioContext||window.webkitAudioContext));try{let t=Uint8Array.from(atob(e),n=>n.charCodeAt(0)),s=await Je.decodeAudioData(t.buffer.slice(0));if(Ce)try{Ce.stop()}catch{}Ce=Je.createBufferSource(),Ce.buffer=s,Ce.connect(Je.destination),Ce.start(0)}catch(t){console.error("Audio error:",t)}}var ft=document.getElementById("msg-menu"),yn=document.getElementById("menu-copy"),bn=document.getElementById("menu-edit"),wn=document.getElementById("menu-delete"),H=null,Oe=null;function Cs(e,t,s){H=e,e.classList.add("selected");let n=148,o=60,i=Math.min(t,window.innerWidth-n-10),a=Math.max(s-o-10,10);ft.style.left=i+"px",ft.style.top=a+"px",ft.classList.add("show")}function St(){ft?.classList.remove("show"),H?.classList.remove("selected"),H=null}l?.addEventListener("touchstart",e=>{let t=e.target.closest(".msg");if(!t||t.classList.contains("system")||t.classList.contains("thinking"))return;let s=e.touches[0];Oe=setTimeout(()=>{e.preventDefault(),Cs(t,s.clientX,s.clientY)},500)},{passive:!1});l?.addEventListener("touchend",()=>{clearTimeout(Oe)});l?.addEventListener("touchmove",()=>{clearTimeout(Oe)});document.addEventListener("touchstart",e=>{!e.target.closest("#msg-menu")&&!e.target.closest(".msg")&&St()});yn?.addEventListener("click",()=>{if(!H)return;let e=H.textContent||H.innerText;navigator.clipboard.writeText(e).then(()=>{r("Copied!")}).catch(()=>{r("Failed to copy",!0)}),St()});bn?.addEventListener("click",()=>{if(!H)return;let e=H.textContent||H.innerText;k&&ge?.classList.contains("show")?b&&(b.value=e,b.style.height="auto",b.style.height=Math.min(b.scrollHeight,120)+"px",ee?.classList.add("active"),b.focus()):p&&(p.value=e,p.style.height="auto",p.style.height=Math.min(p.scrollHeight,120)+"px",be?.classList.add("show"),p.focus()),St()});wn?.addEventListener("click",()=>{H&&(H.remove(),r("Deleted"),St())});Rt();Ut();var cs=0;document.addEventListener("touchend",e=>{let t=Date.now();t-cs<=300&&e.preventDefault(),cs=t},{passive:!1});var J=document.getElementById("pc-status");async function ye(){try{let t=await(await fetch("/api/nodes/status")).json();J&&(J.classList.toggle("connected",t.connected),J.title=t.connected?`${t.nodeName||"PC"} connected`:"PC disconnected")}catch(e){console.error("PC status check failed:",e),J&&J.classList.remove("connected")}}ye();var G=setInterval(ye,3e4);document.addEventListener("visibilitychange",()=>{document.hidden?G&&(clearInterval(G),G=null):G||(ye(),G=setInterval(ye,3e4))});var Me=null;J?.addEventListener("click",async()=>{if(Me&&(clearInterval(Me),Me=null),J.classList.contains("connected")){r("PC is already connected");return}r("Waking PC...");try{let t=await(await fetch("/api/nodes/wake",{method:"POST"})).json();if(t.success){r("Wake signal sent! Waiting for PC..."),clearInterval(G);let s=0;Me=setInterval(async()=>{s++,await ye(),J.classList.contains("connected")?(r("PC connected! \u2705"),clearInterval(Me),G=setInterval(ye,3e4)):s>=24&&(r("PC did not respond",!0),clearInterval(Me),G=setInterval(ye,3e4))},5e3)}else r("Wake failed: "+(t.error||"Unknown error"),!0)}catch(e){r("Wake request failed",!0),console.error("WoL error:",e)}});if(window.visualViewport){let e=window.visualViewport.height;window.visualViewport.addEventListener("resize",()=>{let t=e-window.visualViewport.height;document.body.classList.toggle("keyboard-open",t>150)})}document.querySelectorAll(".shortcut").forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.msg;t&&We(t,"chat")})});document.getElementById("articulations-btn")?.addEventListener("click",async()=>{te("articulate")});var me={"spark-dev-mode":null,"spark-research-mode":null,"spark-plan-mode":null,"spark-videogen-mode":null,"spark-articulate-mode":null,"spark-dailyreports-mode":null},kn={"devteam-btn":"spark-dev-mode","researcher-btn":"spark-research-mode","plan-btn":"spark-plan-mode","videogen-btn":"spark-videogen-mode","articulations-btn":"spark-articulate-mode","todays-reports-btn":"spark-dailyreports-mode"};async function Pe(){try{let s=(await(await fetch("/api/mode-sessions")).json()).sessions||{};me["spark-dev-mode"]=null,me["spark-research-mode"]=null,me["spark-plan-mode"]=null,me["spark-videogen-mode"]=null;let n={dev:"spark-dev-mode",research:"spark-research-mode",plan:"spark-plan-mode",videogen:"spark-videogen-mode"};for(let[o,i]of Object.entries(s)){let a=n[o];a&&i.active&&(me[a]={key:i.sessionId,label:i.label,active:i.active,exists:i.exists,lastUpdated:i.lastUpdated})}Ln(),Ms()}catch(e){console.error("Failed to check active sessions:",e)}}function Ln(){for(let[e,t]of Object.entries(kn)){let s=document.getElementById(e);if(s){let n=me[t]!==null;s.classList.toggle("session-active",n);let o=s.querySelector(".shortcut-sub");if(o)if(n){let i=o.dataset.originalText||o.textContent;o.dataset.originalText=i,o.textContent="\u25CF Session active"}else o.dataset.originalText&&(o.textContent=o.dataset.originalText)}}}var ge=document.getElementById("session-page"),v=document.getElementById("session-messages"),b=document.getElementById("session-input"),ee=document.getElementById("session-send-btn"),En=document.getElementById("session-back-btn"),k=null,x=null,_=!1,nt={dev:{name:"Dev Mode",icon:"\u{1F468}\u200D\u{1F4BB}",sessionKey:"spark-dev-mode",placeholder:"Describe what you want to build or fix...",emptyTitle:"Dev Mode",emptyDesc:"Start a coding session. Describe what you want to build or fix."},research:{name:"Research Mode",icon:"\u{1F52C}",sessionKey:"spark-research-mode",placeholder:"What would you like to research?",emptyTitle:"Research Mode",emptyDesc:"Start a deep research session. Ask about any topic."},plan:{name:"Plan Mode",icon:"\u{1F4CB}",sessionKey:"spark-plan-mode",placeholder:"What do you want to plan?",emptyTitle:"Plan Mode",emptyDesc:"Start planning. Describe your project or feature."},videogen:{name:"Video Gen",icon:"\u{1F3AC}",sessionKey:"spark-videogen-mode",placeholder:"Describe the video you want to create...",emptyTitle:"Video Gen",emptyDesc:"Generate AI videos. Describe what you want to create."},articulate:{name:"Articulate",icon:"\u{1F4AC}",sessionKey:"spark-articulate-mode",placeholder:"Type text to refine...",emptyTitle:"Articulate",emptyDesc:"Refine and improve your text. Paste content to polish."},dailyreports:{name:"Daily Reports",icon:"\u{1F4CA}",sessionKey:"spark-dailyreports-mode",placeholder:"Ask about your portfolio or generate a briefing...",emptyTitle:"Daily Reports",emptyDesc:"View portfolio updates and generate market briefings."}};function Ms(){let e={};for(let[t,s]of Object.entries(nt)){let n=s.sessionKey;me[n]&&(e[t]={label:n,lastActive:Date.now(),hasHistory:!0})}localStorage.setItem("sparkgpt-active-sessions",JSON.stringify(e))}function Sn(){try{let e=JSON.parse(localStorage.getItem("sparkgpt-active-sessions")||"{}"),t=Date.now()-1440*60*1e3;for(let[s,n]of Object.entries(e))n.lastActive<t&&delete e[s];return localStorage.setItem("sparkgpt-active-sessions",JSON.stringify(e)),e}catch{return{}}}var vt=null;function xn(){Is(),vt=setInterval(async()=>{k&&Pe()},15e3)}function Is(){vt&&(clearInterval(vt),vt=null)}async function te(e,t){let s=nt[e];if(!s){console.error("Unknown session mode:",e);return}if(k=e,b.placeholder=s.placeholder,v.innerHTML="",t)x=t;else try{let o=await(await fetch(`/api/modes/${e}/sessions`)).json();o.sessions&&o.sessions.length>0?x=o.sessions[0].id:x=(await(await fetch(`/api/modes/${e}/sessions`,{method:"POST",headers:{"Content-Type":"application/json"}})).json()).id}catch(n){console.error("Failed to resolve session ID:",n),x=null}Tn(e),ge.classList.add("show"),await Bs(e,s),xn(),setTimeout(()=>b.focus(),100)}function Tn(e){let t=document.getElementById("session-header-title");if(t){let s=nt[e];t.textContent=s?`${s.icon} ${s.name}`:e}}function Cn(){ge.classList.remove("show"),k=null,x=null,_=!1,Is(),document.getElementById("session-history-panel")?.classList.remove("show")}async function Bs(e,t){try{let s;x?s=`/api/modes/${e}/sessions/${x}/history?limit=50`:s=`/api/modes/${e}/history?limit=50`;let i=(await(await fetch(s)).json()).messages||[];if(i.length===0)v.innerHTML=`
        <div class="session-empty-state">
          <div class="session-empty-icon">${t.icon}</div>
          <div class="session-empty-title">${t.emptyTitle}</div>
          <div class="session-empty-desc">${t.emptyDesc}</div>
        </div>
      `;else{for(let a of i){let g=Bt(a);g&&P(a.role==="assistant"?"bot":"user",g,a.timestamp)}v.scrollTop=v.scrollHeight}}catch(s){console.error("Failed to load session history:",s),v.innerHTML=`
      <div class="session-empty-state">
        <div class="session-empty-icon">${t.icon}</div>
        <div class="session-empty-title">${t.emptyTitle}</div>
        <div class="session-empty-desc">${t.emptyDesc}</div>
      </div>
    `}}function P(e,t,s){let n=v.querySelector(".session-empty-state");n&&n.remove();let o=bs(v),i=document.createElement("div");if(i.className=`msg ${e}`,e==="bot"?i.innerHTML=le(t):i.textContent=t,s){let a=document.createElement("span");a.className="msg-time",a.textContent=xt(s),i.appendChild(a)}return v.appendChild(i),(e==="user"||o)&&(v.scrollTop=v.scrollHeight),i}function xt(e){if(!e)return"";let t=Date.now(),s=typeof e=="number"?e:new Date(e).getTime();if(isNaN(s))return"";let n=Math.floor((t-s)/1e3);if(n<60)return"just now";let o=Math.floor(n/60);if(o<60)return`${o}m ago`;let i=Math.floor(o/60);if(i<24)return`${i}h ago`;let a=Math.floor(i/24);return a===1?"yesterday":a<7?`${a}d ago`:new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function qe(){Lt();let e=document.createElement("div");e.className="msg bot thinking",e.id="session-thinking-indicator",e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div>',v.appendChild(e),v.scrollTop=v.scrollHeight}function Lt(){document.getElementById("session-thinking-indicator")?.remove()}function As(e){let t=document.getElementById("session-thinking-indicator");if(!t)return qe(),As(e);t.innerHTML=`
    <div class="thinking-content">
      <span class="thinking-status">${lt(e)}</span>
      <div class="thinking-dots"><span></span><span></span><span></span></div>
    </div>
  `,v&&(v.scrollTop=v.scrollHeight)}async function $s(){let e=b.value.trim();if(!e&&!he||_)return;let t=e,s=null;if(he){let n=he;try{if(n.type.startsWith("image/"))s=await new Promise((o,i)=>{let a=new FileReader;a.onload=()=>o(a.result),a.onerror=i,a.readAsDataURL(n)}),t=e||"What is this image?";else{let o=await new Promise((a,g)=>{let d=new FileReader;d.onload=()=>a(d.result),d.onerror=g,d.readAsText(n)}),i=o.slice(0,2e3)+(o.length>2e3?"...":"");t=e?`${e}

[File: ${n.name}]
${i}`:`[File: ${n.name}]
${i}`}}catch{r("Failed to read file",!0);return}he=null,jt?.classList.remove("show")}if(t)if(b.value="",b.style.height="auto",ee.classList.remove("active"),ee.classList.remove("show"),_=!0,P("user",s?t+" \u{1F4F7}":t),qe(),u&&u.readyState===WebSocket.OPEN){let n={type:"mode_message",sparkMode:k,sessionId:x,text:t};s&&(n.image=s),u.send(JSON.stringify(n))}else Lt(),P("bot","Not connected. Please try again."),_=!1}b?.addEventListener("input",()=>{let e=b.value.trim().length>0||he;ee?.classList.toggle("show",e),ee?.classList.toggle("active",e),b.style.height="auto",b.style.height=Math.min(b.scrollHeight,120)+"px"});b?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),$s())});ee?.addEventListener("click",$s);En?.addEventListener("click",Cn);document.getElementById("session-new-btn")?.addEventListener("click",async()=>{if(!k||v.querySelectorAll(".msg").length>0&&!confirm("Start a new session? Current session will be saved."))return;try{let n=await(await fetch(`/api/modes/${k}/sessions`,{method:"POST",headers:{"Content-Type":"application/json"}})).json();x=n.id,console.log("Created new session:",n.id)}catch(s){console.error("Failed to create new session:",s)}v.innerHTML="";let t=nt[k];t&&(v.innerHTML=`
      <div class="session-empty-state">
        <div class="session-empty-icon">${t.icon}</div>
        <div class="session-empty-title">${t.emptyTitle}</div>
        <div class="session-empty-desc">${t.emptyDesc}</div>
      </div>
    `),b?.focus()});var Mn=document.getElementById("session-upload-btn"),yt=document.getElementById("session-file-input"),jt=document.getElementById("session-attachment-preview"),Ge=document.getElementById("session-attachment-icon"),ls=document.getElementById("session-attachment-name"),rs=document.getElementById("session-attachment-size"),In=document.getElementById("session-remove-attachment-btn"),he=null;Mn?.addEventListener("click",()=>yt?.click());yt?.addEventListener("change",e=>{let t=e.target.files?.[0];if(t){if(t.size>xe.maxFileSize){r(`File too large (${W(t.size)}). Maximum size is ${W(xe.maxFileSize)}.`,!0),yt.value="";return}he=t,ls&&(ls.textContent=t.name),rs&&(rs.textContent=W(t.size)),Ge&&(t.type.startsWith("image/")?(Ge.classList.add("image"),Ge.innerHTML='<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>'):(Ge.classList.remove("image"),Ge.innerHTML='<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>')),jt?.classList.add("show"),ee?.classList.add("show"),b?.focus(),yt.value=""}});In?.addEventListener("click",()=>{he=null,jt?.classList.remove("show"),b?.value.trim()||ee?.classList.remove("show")});var Wt=document.getElementById("session-history-panel"),Ke=document.getElementById("session-history-list");document.getElementById("session-history-btn")?.addEventListener("click",async()=>{if(k){Wt?.classList.add("show"),Ke.innerHTML='<div class="session-history-empty">Loading...</div>';try{let s=(await(await fetch(`/api/modes/${k}/sessions`)).json()).sessions||[];if(s.length===0){Ke.innerHTML='<div class="session-history-empty">No sessions yet</div>';return}Ke.innerHTML="";for(let n of s){let o=document.createElement("div");o.className="session-history-entry",n.id===x&&o.classList.add("active");let i=n.title||"Untitled",a=xt(n.createdAt),g=n.messageCount?`${n.messageCount} msgs`:"";o.innerHTML=`
        <div class="session-history-entry-title">${lt(i)}</div>
        <div class="session-history-entry-meta">
          <span>${a}</span>
          ${g?`<span>\xB7 ${g}</span>`:""}
        </div>
      `,o.addEventListener("click",()=>{Wt?.classList.remove("show"),x=n.id,v.innerHTML="";let d=nt[k];d&&Bs(k,d)}),Ke.appendChild(o)}}catch(e){console.error("Failed to load sessions:",e),Ke.innerHTML='<div class="session-history-empty">Failed to load sessions</div>'}}});document.getElementById("session-history-close")?.addEventListener("click",()=>{Wt?.classList.remove("show")});v?.addEventListener("touchstart",e=>{let t=e.target.closest(".msg");if(!t||t.classList.contains("system")||t.classList.contains("thinking"))return;let s=e.touches[0];Oe=setTimeout(()=>{e.preventDefault(),Cs(t,s.clientX,s.clientY)},500)},{passive:!1});v?.addEventListener("touchend",()=>{clearTimeout(Oe)});v?.addEventListener("touchmove",()=>{clearTimeout(Oe)});Sn();Pe();var Xe=setInterval(Pe,1e4);document.addEventListener("visibilitychange",()=>{document.hidden?Xe&&(clearInterval(Xe),Xe=null):Xe||(Pe(),Xe=setInterval(Pe,1e4))});function zt({icon:e,title:t,subtitle:s,placeholder:n,submitText:o,onSubmit:i,activeSession:a,onViewSession:g}){let d=document.createElement("div");d.className="bottom-sheet-overlay";let m=document.createElement("div");m.className="bottom-sheet";let Ue=a?`
    <button class="bottom-sheet-active-session">
      <span class="active-dot">\u25CF</span>
      View Active Session
    </button>
  `:"";m.innerHTML=`
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-icon">${e}</span>
      <div class="bottom-sheet-titles">
        <h2 class="bottom-sheet-title">${t}</h2>
        <p class="bottom-sheet-subtitle">${s}</p>
      </div>
    </div>
    ${Ue}
    <textarea class="bottom-sheet-input" placeholder="${n}" rows="1"></textarea>
    <button class="bottom-sheet-submit">${o}</button>
  `,document.body.appendChild(d),document.body.appendChild(m);let C=m.querySelector(".bottom-sheet-input"),$=m.querySelector(".bottom-sheet-submit"),_e=m.querySelector(".bottom-sheet-handle"),ne=m.querySelector(".bottom-sheet-active-session");function R(){m.classList.add("closing"),m.classList.remove("visible"),d.classList.remove("visible"),setTimeout(()=>{d.remove(),m.remove()},200)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{d.classList.add("visible"),m.classList.add("visible"),C.focus()})}),d.addEventListener("click",R);let oe=0,ie=0,ae=!1;function Le(w){let L=w.target;(L===_e||L===m&&m.scrollTop===0)&&(oe=w.touches[0].clientY,ie=oe,ae=!0,m.style.transition="none")}function Tt(w){if(!ae)return;ie=w.touches[0].clientY;let L=ie-oe;L>0&&(window.innerWidth>=520?m.style.transform=`translateX(-50%) translateY(${L}px)`:m.style.transform=`translateY(${L}px)`)}function N(){if(!ae)return;ae=!1,m.style.transition="",ie-oe>100?R():window.innerWidth>=520?m.style.transform="translateX(-50%) translateY(0)":m.style.transform="translateY(0)"}m.addEventListener("touchstart",Le,{passive:!0}),m.addEventListener("touchmove",Tt,{passive:!0}),m.addEventListener("touchend",N);function Ee(w){w.key==="Escape"&&(R(),document.removeEventListener("keydown",Ee))}document.addEventListener("keydown",Ee);function Se(){let w=C.value.trim();if(!w){C.classList.add("error"),setTimeout(()=>C.classList.remove("error"),300);return}R(),i(w)}return $.addEventListener("click",Se),ne&&g&&ne.addEventListener("click",()=>{R(),g(a)}),C.addEventListener("keydown",w=>{w.key==="Enter"&&(w.metaKey||w.ctrlKey)&&(w.preventDefault(),Se())}),C.addEventListener("input",()=>{C.style.height="auto",C.style.height=Math.min(C.scrollHeight,120)+"px"}),{close:R}}document.getElementById("devteam-btn")?.addEventListener("click",async()=>{let e=!1;try{let s=await(await fetch("/api/modes/dev/sessions")).json();e=s.sessions&&s.sessions.length>0}catch{}e?te("dev"):zt({icon:"\u{1F468}\u200D\u{1F4BB}",title:"Dev Mode",subtitle:"Senior engineer \u2014 reads code, writes tests, commits",placeholder:"Describe the task or issue to fix...",submitText:"Start Dev Session",onSubmit:async t=>{await te("dev"),u&&u.readyState===WebSocket.OPEN&&(P("user",t),qe(),_=!0,u.send(JSON.stringify({type:"mode_message",sparkMode:"dev",sessionId:x,text:t})))}})});document.getElementById("researcher-btn")?.addEventListener("click",async()=>{let e=!1;try{let s=await(await fetch("/api/modes/research/sessions")).json();e=s.sessions&&s.sessions.length>0}catch{}e?te("research"):zt({icon:"\u{1F52C}",title:"Research Mode",subtitle:"Deep research with sources and analysis",placeholder:"What topic do you want to research?",submitText:"Start Research",onSubmit:async t=>{await te("research"),u&&u.readyState===WebSocket.OPEN&&(P("user",t),qe(),_=!0,u.send(JSON.stringify({type:"mode_message",sparkMode:"research",sessionId:x,text:t})))}})});document.getElementById("plan-btn")?.addEventListener("click",async()=>{let e=!1;try{let s=await(await fetch("/api/modes/plan/sessions")).json();e=s.sessions&&s.sessions.length>0}catch{}e?te("plan"):zt({icon:"\u{1F4CB}",title:"Plan Mode",subtitle:"Technical specs with phases and risks",placeholder:"What do you want to plan?",submitText:"Start Planning",onSubmit:async t=>{await te("plan"),u&&u.readyState===WebSocket.OPEN&&(P("user",t),qe(),_=!0,u.send(JSON.stringify({type:"mode_message",sparkMode:"plan",sessionId:x,text:t})))}})});document.getElementById("videogen-btn")?.addEventListener("click",()=>{Bn()});function Bn(){let e=document.createElement("div");e.className="bottom-sheet-overlay";let t=document.createElement("div");t.className="bottom-sheet",t.innerHTML=`
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-icon">\u{1F3AC}</span>
      <div class="bottom-sheet-titles">
        <h2 class="bottom-sheet-title">Video Gen</h2>
        <p class="bottom-sheet-subtitle" id="videogen-subtitle">AI video generation</p>
      </div>
    </div>
    
    <div class="bottom-sheet-row">
      <label class="bottom-sheet-label">Workflow</label>
      <div class="option-selector" id="videogen-workflow">
        <button class="option-pill selected" data-value="text2video">Text \u2192 Video</button>
        <button class="option-pill" data-value="image2video">Image \u2192 Video</button>
        <button class="option-pill" data-value="faceswap">Face Swap</button>
      </div>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-prompt-row">
      <label class="bottom-sheet-label">Prompt</label>
      <textarea class="bottom-sheet-input" id="videogen-prompt" placeholder="Describe the video you want to create..." rows="2"></textarea>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-image-row" style="display:none;">
      <label class="bottom-sheet-label" id="videogen-image-label">Reference Image</label>
      <div class="image-upload-area" id="videogen-upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <div class="upload-text">Tap to upload image</div>
        <div class="upload-hint" id="videogen-image-hint">For image-to-video generation</div>
      </div>
      <input type="file" id="videogen-file-input" accept="image/*" style="display:none">
    </div>
    
    <div class="bottom-sheet-row" id="videogen-video-row" style="display:none;">
      <label class="bottom-sheet-label">Target Video</label>
      <div class="image-upload-area" id="videogen-video-upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
        </div>
        <div class="upload-text">Tap to upload video or paste URL</div>
        <div class="upload-hint">YouTube/video URL or upload file</div>
      </div>
      <input type="file" id="videogen-video-file-input" accept="video/*" style="display:none">
      <input type="text" class="bottom-sheet-input" id="videogen-video-url" placeholder="Or paste YouTube/video URL..." style="margin-top:8px; display:none;">
    </div>
    
    <div class="bottom-sheet-row" id="videogen-aspect-row">
      <label class="bottom-sheet-label">Aspect Ratio</label>
      <div class="option-selector" id="videogen-aspect">
        <button class="option-pill selected" data-value="16:9">16:9</button>
        <button class="option-pill" data-value="9:16">9:16</button>
        <button class="option-pill" data-value="1:1">1:1</button>
      </div>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-duration-row">
      <label class="bottom-sheet-label">Duration</label>
      <div class="option-selector" id="videogen-duration">
        <button class="option-pill selected" data-value="5">5 seconds</button>
        <button class="option-pill" data-value="10">10 seconds</button>
      </div>
    </div>
    
    <button class="bottom-sheet-submit" id="videogen-submit">Generate Video</button>
  `,document.body.appendChild(e),document.body.appendChild(t);let s=t.querySelector("#videogen-subtitle"),n=t.querySelector("#videogen-workflow"),o=t.querySelector("#videogen-prompt-row"),i=t.querySelector("#videogen-prompt"),a=t.querySelector("#videogen-image-row"),g=t.querySelector("#videogen-image-label"),d=t.querySelector("#videogen-image-hint"),m=t.querySelector("#videogen-upload-area"),Ue=t.querySelector("#videogen-file-input"),C=t.querySelector("#videogen-video-row"),$=t.querySelector("#videogen-video-upload-area"),_e=t.querySelector("#videogen-video-file-input"),ne=t.querySelector("#videogen-video-url"),R=t.querySelector("#videogen-aspect-row"),oe=t.querySelector("#videogen-aspect"),ie=t.querySelector("#videogen-duration-row"),ae=t.querySelector("#videogen-duration"),Le=t.querySelector("#videogen-submit"),Tt=t.querySelector(".bottom-sheet-handle"),N="text2video",Ee="16:9",Se="5",w=null,L=null,Ve=null,Ye=null,j=null;function ot(){t.classList.add("closing"),t.classList.remove("visible"),e.classList.remove("visible"),setTimeout(()=>{e.remove(),t.remove()},200)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.classList.add("visible"),t.classList.add("visible"),i.focus()})}),e.addEventListener("click",ot);let it=0,at=0,ct=!1;function Ns(h){let c=h.target;(c===Tt||c===t&&t.scrollTop===0)&&(it=h.touches[0].clientY,at=it,ct=!0,t.style.transition="none")}function Ds(h){if(!ct)return;at=h.touches[0].clientY;let c=at-it;c>0&&(window.innerWidth>=520?t.style.transform=`translateX(-50%) translateY(${c}px)`:t.style.transform=`translateY(${c}px)`)}function Hs(){if(!ct)return;ct=!1,t.style.transition="",at-it>100?ot():window.innerWidth>=520?t.style.transform="translateX(-50%) translateY(0)":t.style.transform="translateY(0)"}t.addEventListener("touchstart",Ns,{passive:!0}),t.addEventListener("touchmove",Ds,{passive:!0}),t.addEventListener("touchend",Hs);function Gt(h){h.key==="Escape"&&(ot(),document.removeEventListener("keydown",Gt))}document.addEventListener("keydown",Gt);function Ps(){switch(o.style.display="block",a.style.display="none",C.style.display="none",R.style.display="block",ie.style.display="block",ne.style.display="none",N){case"text2video":s.textContent="Generate video from text prompt",i.placeholder="Describe the video you want to create...",Le.textContent="Generate Video";break;case"image2video":s.textContent="Animate an image into video",i.placeholder="Describe the motion/action (optional)...",a.style.display="block",g.textContent="Source Image",d.textContent="Image to animate",Le.textContent="Generate Video";break;case"faceswap":s.textContent="Swap face in a video",o.style.display="none",a.style.display="block",C.style.display="block",R.style.display="none",ie.style.display="none",g.textContent="Face Image",d.textContent="Photo with the face to use",ne.style.display="block",Le.textContent="Swap Face";break}}n.addEventListener("click",h=>{let c=h.target.closest(".option-pill");c&&(n.querySelectorAll(".option-pill").forEach(E=>E.classList.remove("selected")),c.classList.add("selected"),N=c.dataset.value,Ps())}),oe.addEventListener("click",h=>{let c=h.target.closest(".option-pill");c&&(oe.querySelectorAll(".option-pill").forEach(E=>E.classList.remove("selected")),c.classList.add("selected"),Ee=c.dataset.value)}),ae.addEventListener("click",h=>{let c=h.target.closest(".option-pill");c&&(ae.querySelectorAll(".option-pill").forEach(E=>E.classList.remove("selected")),c.classList.add("selected"),Se=c.dataset.value)});function Fs(){w=null,L=null,m.classList.remove("has-image"),m.innerHTML=`
      <div class="upload-icon">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="upload-text">Tap to upload image</div>
      <div class="upload-hint" id="videogen-image-hint">${N==="faceswap"?"Photo with the face to use":"Image to animate"}</div>
    `,Ue.value=""}function Kt(){Ve=null,Ye=null,j=null,$.classList.remove("has-image"),$.innerHTML=`
      <div class="upload-icon">
        <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
      </div>
      <div class="upload-text">Tap to upload video or paste URL</div>
      <div class="upload-hint">YouTube/video URL or upload file</div>
    `,_e.value="",ne.value=""}m.addEventListener("click",()=>{w||Ue.click()}),Ue.addEventListener("change",async h=>{let c=h.target.files?.[0];if(!c)return;w=c;let E=new FileReader;E.onload=Ct=>{L=Ct.target.result,m.classList.add("has-image"),m.innerHTML=`
        <div class="image-preview-container">
          <img class="image-preview-thumb" src="${L}" alt="Preview">
          <div class="image-preview-info">
            <div class="image-preview-name">${c.name}</div>
            <div class="image-preview-size">${W(c.size)}</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-image">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-image")?.addEventListener("click",Mt=>{Mt.stopPropagation(),Fs()})},E.readAsDataURL(c)}),$.addEventListener("click",()=>{!Ve&&!j&&_e.click()}),_e.addEventListener("change",async h=>{let c=h.target.files?.[0];if(!c)return;Ve=c,j=null;let E=new FileReader;E.onload=Ct=>{Ye=Ct.target.result,$.classList.add("has-image"),$.innerHTML=`
        <div class="image-preview-container">
          <div class="upload-icon" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--msg-bot);border-radius:8px;">
            <svg viewBox="0 0 24 24" style="width:30px;height:30px;stroke:var(--text-secondary);fill:none;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </div>
          <div class="image-preview-info">
            <div class="image-preview-name">${c.name}</div>
            <div class="image-preview-size">${W(c.size)}</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-video">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-video")?.addEventListener("click",Mt=>{Mt.stopPropagation(),Kt()})},E.readAsDataURL(c)}),ne.addEventListener("input",h=>{let c=h.target.value.trim();c&&(c.includes("youtube.com")||c.includes("youtu.be")||c.includes("http"))&&(j=c,Ve=null,Ye=null,$.classList.add("has-image"),$.innerHTML=`
        <div class="image-preview-container">
          <div class="upload-icon" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--msg-bot);border-radius:8px;">
            <svg viewBox="0 0 24 24" style="width:30px;height:30px;stroke:var(--text-secondary);fill:none;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </div>
          <div class="image-preview-info">
            <div class="image-preview-name" style="word-break:break-all;">${c.length>40?c.substring(0,40)+"...":c}</div>
            <div class="image-preview-size">Video URL</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-video">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-video")?.addEventListener("click",E=>{E.stopPropagation(),Kt()}))}),Le.addEventListener("click",()=>{let h=i.value.trim();if(N==="text2video"){if(!h){i.classList.add("error"),setTimeout(()=>i.classList.remove("error"),300);return}}else if(N==="image2video"){if(!L){m.style.borderColor="var(--red)",setTimeout(()=>m.style.borderColor="",300);return}}else if(N==="faceswap"){if(!L){m.style.borderColor="var(--red)",setTimeout(()=>m.style.borderColor="",300);return}if(!Ye&&!j){$.style.borderColor="var(--red)",setTimeout(()=>$.style.borderColor="",300);return}}if(ot(),Re(),N==="text2video"){let c=`/video --ratio ${Ee} --duration ${Se}s ${h}`;We(c,"chat")}else if(N==="image2video"){let c=`/video --ratio ${Ee} --duration ${Se}s`;h&&(c+=` ${h}`),An(c,L)}else if(N==="faceswap"){let c="/faceswap";j&&(c+=` --video-url ${j}`),$n(c,L,Ye,j)}}),i.addEventListener("input",()=>{i.style.height="auto",i.style.height=Math.min(i.scrollHeight,120)+"px"})}function An(e,t){if(!u||u.readyState!==WebSocket.OPEN){r("Not connected",!0);return}V=!0;let s=document.createElement("div");s.className="msg user",s.textContent=e+" \u{1F4F7}",l.appendChild(s),l.scrollTop=l.scrollHeight,ce(e),Y(),u.send(JSON.stringify({type:"transcript",text:e,image:t,mode:"chat"}))}function $n(e,t,s,n){if(!u||u.readyState!==WebSocket.OPEN){r("Not connected",!0);return}V=!0;let o=document.createElement("div");o.className="msg user",o.textContent=e+" \u{1F3AD}\u{1F4F7}\u{1F3AC}",l.appendChild(o),l.scrollTop=l.scrollHeight,ce(e),Y(),u.send(JSON.stringify({type:"transcript",text:e,image:t,video:s,videoUrl:n,mode:"chat"}))}var Nn=We;We=async function(e,t){us?await Dn(e):await Nn(e,t)};async function Dn(e){if(!e.trim())return;A==="intro"&&Re({skipHistory:!0});let t=document.createElement("div");t.className="msg user",t.textContent=e,l.appendChild(t),l.scrollTop=l.scrollHeight,Y();try{let n=await(await fetch("/api/articulate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})})).json();if(X(),n.result){let o=document.createElement("div");o.className="msg bot",o.textContent=n.result,l.appendChild(o),l.scrollTop=l.scrollHeight}}catch{X(),r("Failed to refine text",!0)}}document.getElementById("todays-reports-btn")?.addEventListener("click",async()=>{te("dailyreports");let e=document.createElement("div");e.className="msg system",e.textContent="Loading today's reports...",v.appendChild(e);try{let s=await(await fetch("/api/reports/today")).json();if(e.remove(),!s.reports?.length){P("bot","No reports found for today. Ask me to generate a market briefing!");return}P("system",`\u{1F4CA} Today's Reports (${s.reports.length})`),s.reports.forEach(n=>{P("bot",n.summary)})}catch(t){e.textContent="Failed to load reports",console.error("Failed to load reports:",t)}});var Jt=document.getElementById("attachment-preview"),mt=document.getElementById("attachment-icon"),Hn=document.getElementById("attachment-name"),Pn=document.getElementById("attachment-size"),Fn=document.getElementById("remove-attachment-btn"),fe=null;Os?.addEventListener("click",()=>pt?.click());pt?.addEventListener("change",e=>{let t=e.target.files?.[0];if(t){if(t.size>xe.maxFileSize){r(`File too large (${W(t.size)}). Maximum size is ${W(xe.maxFileSize)}.`,!0),pt.value="";return}fe=t,Hn.textContent=t.name,Pn.textContent=W(t.size),t.type.startsWith("image/")?(mt.classList.add("image"),mt.innerHTML='<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>'):(mt.classList.remove("image"),mt.innerHTML='<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>'),Jt?.classList.add("show"),be?.classList.add("show"),Fe?.classList.add("hidden"),p?.focus(),pt.value=""}});Fn?.addEventListener("click",()=>{fe=null,Jt?.classList.remove("show"),p?.value.trim()||(be?.classList.remove("show"),Fe?.classList.remove("hidden"))});Vt=async function(){let e=p?.value.trim()||"";if(!e&&!fe||V)return;let t=e,s=null;if(fe){let n=fe;try{if(n.type.startsWith("image/"))s=await new Promise((o,i)=>{let a=new FileReader;a.onload=()=>o(a.result),a.onerror=i,a.readAsDataURL(n)}),t=e||"What is this image?";else{let o=await new Promise((a,g)=>{let d=new FileReader;d.onload=()=>a(d.result),d.onerror=g,d.readAsText(n)}),i=o.slice(0,2e3)+(o.length>2e3?"...":"");t=e?`${e}

[File: ${n.name}]
${i}`:`[File: ${n.name}]
${i}`}}catch{r("Failed to read file",!0);return}fe=null,Jt?.classList.remove("show")}t&&(p.value="",p.style.height="auto",be?.classList.remove("show"),Fe?.classList.remove("hidden"),s?Rn(t,s):We(t,"chat"))};function Rn(e,t){if(!u||u.readyState!==WebSocket.OPEN){r("Not connected",!0);return}V=!0;let s=Pt(e+" \u{1F4F7}","user",{userInitiated:!0});Y(),u.send(JSON.stringify({type:"transcript",text:e,image:t,mode:"chat"}))}
