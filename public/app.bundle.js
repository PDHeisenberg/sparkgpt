var Vt={wsUrl:(()=>{let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,n=location.pathname.replace(/\/+$/,"");return n&&n!=="/"?`${t}${n}`:t})(),silenceMs:1500};var Pe=new Set,Tn=50;function Ut(e){let t=(e||"").trim().slice(0,200),n=0;for(let s=0;s<t.length;s++)n=(n<<5)-n+t.charCodeAt(s),n=n&n;return n.toString(36)}function oe(e){let t=Ut(e);if(Pe.add(t),Pe.size>Tn){let n=Pe.values();for(let s=0;s<10;s++)Pe.delete(n.next().value)}}function vt(e){return Pe.has(Ut(e))}function Y(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^(.*)$/,"<p>$1</p>").replace(/<p><\/p>/g,"")}function Ge(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function Yt(e){return e?.content?typeof e.content=="string"?e.content:Array.isArray(e.content)&&e.content.find(n=>n.type==="text")?.text||null:null}function _t(){let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,n=location.pathname.replace(/\/+$/,"");return n&&n!=="/"?`${t}${n}/realtime`:`${t}/realtime`}function zt(e){let t=new Int16Array(e.length);for(let o=0;o<e.length;o++){let i=Math.max(-1,Math.min(1,e[o]));t[o]=i<0?i*32768:i*32767}let n=new Uint8Array(t.buffer),s="";for(let o=0;o<n.length;o++)s+=String.fromCharCode(n[o]);return btoa(s)}function jt(e){let t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);let s=new Int16Array(n.buffer),o=new Float32Array(s.length);for(let i=0;i<s.length;i++)o[i]=s[i]/(s[i]<0?32768:32767);return o}var a=document.getElementById("messages"),st=document.getElementById("welcome"),p=document.getElementById("text-input"),ue=document.getElementById("send-btn"),Ie=document.getElementById("voice-btn"),Mn=document.getElementById("notes-btn"),ht=document.getElementById("status"),Ns=document.getElementById("timer"),yt=document.getElementById("toast"),In=document.getElementById("upload-btn"),kt=document.getElementById("file-input"),Q=document.getElementById("bottom"),x=document.getElementById("spark-status"),Ct={count:0,thinking:!1,sessions:[]};function De(e){x&&(x.classList.remove("connected","connecting"),e==="connected"?(x.classList.add("connected"),x.title="Clawdbot Gateway: Connected",ot()):e==="connecting"?(x.classList.add("connecting"),x.title="Clawdbot Gateway: Connecting..."):x.title="Clawdbot Gateway: Disconnected")}async function ot(){try{Ct=await(await fetch("/api/active-sessions")).json(),Ee()}catch(e){console.error("Failed to fetch active sessions:",e)}}function Ee(){if(!x)return;let e=x.querySelector(".session-count");e||(e=document.createElement("span"),e.className="session-count",x.appendChild(e));let t=(Ct.sessions||[]).filter(n=>n.isSubagent).length;H||t>0?x.classList.add("active"):x.classList.remove("active"),t>0?(e.textContent=t,e.style.display="flex"):e.style.display="none"}x?.addEventListener("click",e=>{e.stopPropagation();let t=document.getElementById("sessions-popup");t?t.remove():($n(),ot().then(()=>{let n=document.getElementById("sessions-popup");n&&nn(n)}))});function Bn(e){let t=(e.label||"").toLowerCase();return t.includes("engineer")?"Implementing fixes...":t.includes("qa")?"Reviewing code...":t.includes("dev")?"Running dev workflow...":t.includes("test")?"Running test...":"Working..."}function An(e){return e.isMain?'<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M13 3L4 14h7v7l9-11h-7V3z"/></svg>':e.isSubagent?'<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>':'<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>'}function nn(e){let n=(Ct.sessions||[]).filter(s=>s.isSubagent);n.length===0?e.innerHTML=`
      <div style="color: var(--text-secondary); font-size: 14px;">
        No background tasks running
      </div>
    `:e.innerHTML=`
      <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px; color: var(--text);">
        Background Tasks (${n.length})
      </div>
      ${n.map(s=>`
        <div style="padding: 10px; background: var(--input-bg); 
          border-radius: 8px; margin-bottom: 8px; display: flex; align-items: flex-start; gap: 10px;">
          <div style="opacity: 0.6; margin-top: 2px;">${An(s)}</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 500; font-size: 13px; color: var(--text);">
              ${s.label||"Task"}
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
              ${Bn(s)}
            </div>
          </div>
        </div>
      `).join("")}
    `}function $n(){document.getElementById("sessions-popup")?.remove();let e=document.createElement("div");e.id="sessions-popup",e.style.cssText=`
    position: fixed; top: 70px; left: 16px;
    background: var(--bg); border-radius: 12px;
    padding: 16px; min-width: 260px; max-width: 320px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    border: 1px solid var(--input-border);
    z-index: 1000;
  `,nn(e),document.body.appendChild(e);let t=n=>{!e.contains(n.target)&&!x.contains(n.target)&&(e.remove(),document.removeEventListener("click",t))};setTimeout(()=>document.addEventListener("click",t),10)}var sn=document.getElementById("voice-bar"),Nn=document.getElementById("close-voice-btn"),Ps=document.getElementById("waveform"),E=document.getElementById("voice-content"),Gt=document.getElementById("voice-status"),Ds=document.getElementById("notes-content"),it=document.getElementById("notes-timer"),Hs=document.getElementById("notes-bar"),Pn=document.getElementById("close-notes-btn"),Dn=document.getElementById("delete-notes-btn"),Ws=document.getElementById("notes-recording"),Rs=document.getElementById("notes-results"),F=document.getElementById("notes-status"),Le=document.getElementById("notes-transcription-msg"),Se=document.getElementById("notes-transcription"),Ce=document.getElementById("notes-summary-msg"),Te=document.getElementById("notes-summary"),Hn=document.getElementById("notes-save-btn"),Wn=document.getElementById("notes-delete-btn"),Rn=document.getElementById("notes-back-btn"),q={transcription:"",summary:""},Fn=document.getElementById("close-btn"),Oe=document.getElementById("history-btn"),qn=document.getElementById("theme-btn");function On(){let e=localStorage.getItem("theme");e&&document.documentElement.setAttribute("data-theme",e)}On();qn?.addEventListener("click",()=>{let e=document.documentElement.getAttribute("data-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,n;e==="dark"?n="light":e==="light"?n="dark":n=t?"light":"dark",document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n)});var m=null,me="chat",M="intro",on=!1,pe=!1,he=0,bt=5,H=!1,He=null,ye=null,T=null,dt=[],Tt=null,Mt=null,at=null,O=null,lt={},Ze={},an={dev:{name:"Dev Mode",icon:"\u{1F468}\u200D\u{1F4BB}",notifyWhatsApp:!0},research:{name:"Research Mode",icon:"\u{1F52C}",notifyWhatsApp:!0},plan:{name:"Plan Mode",icon:"\u{1F4CB}",notifyWhatsApp:!0},articulate:{name:"Articulate Mode",icon:"\u270D\uFE0F",notifyWhatsApp:!1},dailyreports:{name:"Daily Reports",icon:"\u{1F4CA}",notifyWhatsApp:!0},videogen:{name:"Video Gen",icon:"\u{1F3AC}",notifyWhatsApp:!0}};async function Vn(){try{Ze=(await(await fetch("/api/modes")).json()).modes||{},console.log("\u{1F4E6} Loaded mode configs:",Object.keys(Ze))}catch(e){console.error("Failed to load mode configs:",e),Ze=an}}function It(e){return Ze[e]||an[e]||{name:e,icon:"\u{1F4E6}"}}async function ln(e){let t=It(e);console.log(`\u{1F4E6} Entering ${t.name}...`),O=e,Z(),cn(),await Un(e),rn(e)}function cn(){let e=document.getElementById("mode-indicator");if(O){let t=It(O);e||(e=document.createElement("div"),e.id="mode-indicator",e.className="mode-indicator",document.querySelector(".top-bar")?.appendChild(e)),e.innerHTML=`
      <span class="mode-icon">${t.icon}</span>
      <span class="mode-name">${t.name}</span>
      <button class="mode-exit-btn" onclick="exitMode()">\u2715</button>
    `,e.style.display="flex"}else e&&(e.style.display="none")}async function Un(e){try{if(m&&m.readyState===WebSocket.OPEN)m.send(JSON.stringify({type:"mode_history",sparkMode:e}));else{let n=await(await fetch(`/api/modes/${e}/history`)).json();lt[e]=n.messages||[]}}catch(t){console.error(`Failed to load ${e} history:`,t),lt[e]=[]}}function rn(e){let t=lt[e]||[];if(a.querySelectorAll(".msg, .mode-empty-state").forEach(n=>n.remove()),t.length===0){let n=It(e),s=document.createElement("div");s.className="mode-empty-state",s.innerHTML=`
      <div class="mode-empty-icon">${n.icon}</div>
      <div class="mode-empty-title">${n.name}</div>
      <div class="mode-empty-desc">Start a conversation in this mode.</div>
    `,a.appendChild(s)}else for(let n of t){let s=Yt(n);s&&addMessage(n.role==="assistant"?"bot":"user",s)}scrollToBottom()}Vn();var f=null,A=null,Me=!1;function Bt(e=!1){return A&&!e||(A=fetch("/api/messages/all").then(t=>t.json()).then(t=>{if(f=t.messages||[],console.log(`\u{1F4DC} Pre-loaded ${f.length} messages`),f.length>0){let n=f[f.length-1];n.timestamp&&n.timestamp>V&&(V=n.timestamp,console.log(`\u{1F4DC} Set lastMessageTimestamp to ${V}`))}return f}).catch(t=>(console.error("Failed to preload history:",t),f=[],[]))),A}function Jt(){A=null,Me=!1,Bt(!0)}function At(){Me||!f||f.length===0||(Me=!0,f.forEach(e=>{let t=document.createElement("div");t.className=`msg ${e.role==="user"?"user":"bot"}`,e.role==="user"?t.textContent=e.text:t.innerHTML=Y(e.text),a.appendChild(t)}),a.scrollTop=a.scrollHeight)}var we=!1;function dn(){if(we){console.log("showIntroPage blocked - transition in progress");return}we=!0,console.log("showIntroPage called"),requestAnimationFrame(()=>{M="intro",O=null,cn(),on=!1,p&&(p.placeholder="Talk to me"),document.body.classList.remove("chatfeed-mode"),st&&(st.style.display=""),a?.querySelectorAll(".msg").forEach(e=>e.remove()),G(),Me=!1,Oe&&Oe.classList.remove("hidden"),a&&(a.scrollTop=0,a.style.overflow="hidden"),we=!1})}function Z(e={}){if(we){console.log("showChatFeedPage blocked - transition in progress");return}we=!0,console.log("showChatFeedPage called"),requestAnimationFrame(()=>{M="chatfeed",document.body.classList.add("chatfeed-mode"),st&&(st.style.display="none"),Oe&&Oe.classList.add("hidden"),a&&(a.style.overflow="auto"),!e.skipHistory&&f&&f.length>0&&At(),we=!1})}Oe?.addEventListener("click",async()=>{if(f===null&&A&&await A,Z(),!f||f.length===0){let e=document.createElement("div");e.className="msg system",e.textContent="No chat history yet",a.appendChild(e)}});Fn?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("Close button clicked"),dn()});var Yn=document.getElementById("close-chat-btn");Yn?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),document.body.classList.add("slide-out"),setTimeout(()=>{document.body.classList.remove("slide-out"),dn()},250)});var un=50,mn=0,xt=!1;a?.addEventListener("touchstart",e=>{M==="intro"&&(mn=e.touches[0].clientY,xt=!1)},{passive:!0});a?.addEventListener("touchmove",e=>{if(M!=="intro"||xt)return;e.touches[0].clientY-mn>=un&&(xt=!0,pn())},{passive:!0});a?.addEventListener("wheel",e=>{M==="intro"&&e.deltaY<-un&&pn()},{passive:!0});async function pn(){X();try{f===null&&A?await Promise.race([A,new Promise((e,t)=>setTimeout(()=>t("timeout"),3e3))]):f===null&&await Promise.race([Bt(!0),new Promise((e,t)=>setTimeout(()=>t("timeout"),3e3))])}catch(e){console.log("History load timeout or error:",e)}if(G(),document.body.classList.add("slide-in"),Z(),setTimeout(()=>document.body.classList.remove("slide-in"),400),!f||f.length===0){let e=document.createElement("div");e.className="msg system",e.textContent="No chat history yet",a.appendChild(e)}}function _n(e=100){if(!a)return!0;let{scrollTop:t,scrollHeight:n,clientHeight:s}=a;return n-t-s<e}function ut(){_n()&&(a.scrollTop=a.scrollHeight)}function Et(e,t,n={}){if(M==="intro")if(n.userInitiated)f&&f.length>0&&!Me&&At(),Z({skipHistory:!0});else return t==="bot"&&c("New message from Spark"),null;oe(e);let s=document.createElement("div");return s.className=`msg ${t}`,t==="bot"?s.innerHTML=Y(e):s.textContent=e,a.appendChild(s),t==="user"?a.scrollTop=a.scrollHeight:ut(),s}function X(){if(M==="intro")return;G();let e=document.createElement("div");e.className="msg bot thinking",e.id="thinking-indicator",e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div>',a.appendChild(e),ut()}function G(){document.getElementById("thinking-indicator")?.remove()}function ke(e){ht&&(ht.textContent=e,ht.classList.toggle("show",!!e))}function c(e,t=!1){yt.textContent=e,yt.className=t?"show error":"show",setTimeout(()=>yt.className="",3e3)}var C=null,k=null,Re=null,ae=null,_=null,J=[],K=!1;var Fe=null;function zn(){let e=new(window.AudioContext||window.webkitAudioContext),t=e.sampleRate,n=.3,s=n*t,o=e.createBuffer(1,s,t),i=o.getChannelData(0);for(let d=0;d<s;d++){let y=d/t,u=880,r=Math.exp(-8*y/n);i[d]=r*.2*Math.sin(2*Math.PI*u*y)}return{ctx:e,buffer:o}}function Je(){Fe||(console.log("\u{1F50A} Thinking sound started"),Kt(),Fe=setInterval(Kt,2e3))}function Kt(){let e=null;try{let t=zn();e=t.ctx;let n=t.buffer,s=e.createBufferSource(),o=e.createGain();s.buffer=n,o.gain.setValueAtTime(.2,e.currentTime),s.connect(o),o.connect(e.destination),s.start(),s.onended=()=>{s.disconnect(),o.disconnect(),e.close().catch(()=>{})}}catch(t){console.error("Thinking sound error:",t),e&&e.state!=="closed"&&e.close().catch(()=>{})}}function P(){Fe&&(clearInterval(Fe),Fe=null,console.log("\u{1F507} Thinking sound stopped"))}var ie=null,v=null;function Ke(e,t){if(!E)return null;let n=document.createElement("div");return n.className=`voice-msg ${e}`,n.textContent=t,E.appendChild(n),E.scrollTop=E.scrollHeight,n}function S(e){Gt&&(Gt.textContent=e)}async function jn(){if(!(K||J.length===0)){for(K=!0;J.length>0;){let e=J.shift();try{_||(_=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}));let t=jt(e),n=_.createBuffer(1,t.length,24e3);n.getChannelData(0).set(t);let s=_.createBufferSource();s.buffer=n,s.connect(_.destination),await new Promise(o=>{s.onended=o,s.start()})}catch(t){console.error("Audio playback error:",t)}}await new Promise(e=>setTimeout(e,100)),K=!1}}var Xe=[];async function Gn(){if(!K){for(;J.length>0;)Xe.push(J.shift());if(Xe.length>0){K=!0;let e=null;try{let t=Xe.join("");Xe=[];let n=atob(t),s=new Uint8Array(n.length);for(let u=0;u<n.length;u++)s[u]=n.charCodeAt(u);let o=new Int16Array(s.buffer),i=new Float32Array(o.length);for(let u=0;u<o.length;u++)i[u]=o[u]/(o[u]<0?32768:32767);e=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});let d=e.createBuffer(1,i.length,24e3);d.getChannelData(0).set(i);let y=e.createBufferSource();y.buffer=d,y.connect(e.destination),await new Promise(u=>{y.onended=()=>{e.close().catch(()=>{}),u()},y.start()}),hybridWs&&hybridWs.readyState===WebSocket.OPEN&&(hybridWs.send(JSON.stringify({type:"audio_playback_ended"})),console.log("\u{1F50A} Notified server: playback ended"))}catch(t){console.error("TTS playback error:",t),e&&e.state!=="closed"&&e.close().catch(()=>{}),hybridWs&&hybridWs.readyState===WebSocket.OPEN&&hybridWs.send(JSON.stringify({type:"audio_playback_ended"}))}await new Promise(t=>setTimeout(t,100)),K=!1}}}function gn(){J=[],K=!1,_&&(_.close().catch(()=>{}),_=null)}var et=null,re=null;function Jn(){function e(){if(re){let t=new Uint8Array(re.frequencyBinCount);re.getByteFrequencyData(t);let n=0;for(let d=0;d<t.length;d++)n+=t[d];let o=n/t.length/255>.05,i=document.getElementById("voice-bar");i&&i.classList.toggle("speaking",o)}et=requestAnimationFrame(e)}e()}function Kn(){et&&(cancelAnimationFrame(et),et=null);let e=document.getElementById("voice-bar");e&&e.classList.remove("speaking")}async function Xn(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return c("Microphone not supported in this browser",!0),!1;k=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});try{Re=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:24e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}})}catch(t){return t.name==="NotAllowedError"?c("Microphone permission denied. Please allow access.",!0):t.name==="NotFoundError"?c("No microphone found",!0):c("Microphone error: "+t.message,!0),console.error("Microphone access error:",t),k&&(k.close().catch(()=>{}),k=null),!1}let e=k.createMediaStreamSource(Re);return re=k.createAnalyser(),re.fftSize=256,e.connect(re),Jn(),ae=k.createScriptProcessor(4096,1,1),ae.onaudioprocess=t=>{if(C&&C.readyState===WebSocket.OPEN){let n=t.inputBuffer.getChannelData(0),s=0;for(let d=0;d<n.length;d++)s+=n[d]*n[d];let o=Math.sqrt(s/n.length);if(K&&o<.04)return;let i=zt(n);C.send(JSON.stringify({type:"audio",data:i}))}},e.connect(ae),ae.connect(k.destination),console.log("\u{1F3A4} Audio capture started"),!0}catch(e){return console.error("Audio capture error:",e),c("Audio initialization failed: "+e.message,!0),k&&(k.close().catch(()=>{}),k=null),!1}}function Qn(){Kn(),re=null,ae&&(ae.disconnect(),ae=null),Re&&(Re.getTracks().forEach(e=>e.stop()),Re=null),k&&(k.close().catch(()=>{}),k=null),console.log("\u{1F3A4} Audio capture stopped")}function fn(){let e=_t();console.log("\u{1F517} Connecting to realtime:",e),C=new WebSocket(e),C.onopen=async()=>{he=0,console.log("\u2705 Realtime connected"),ke(""),await Xn()||Ve()},C.onmessage=t=>{try{let n=JSON.parse(t.data);Zn(n)}catch(n){console.error("Failed to parse realtime message:",n)}},C.onclose=()=>{if(console.log("\u{1F50C} Realtime disconnected"),pe&&he<bt){let t=Math.min(2e3*Math.pow(2,he),3e4);he++,ke(`Reconnecting (${he}/${bt})...`),setTimeout(fn,t)}else he>=bt&&(c("Voice connection failed. Please try again.",!0),Ve())},C.onerror=t=>{console.error("Realtime WebSocket error:",t)}}function Zn(e){switch(e.type){case"ready":let t=e.mode==="hybrid"?"Hybrid (Claude)":"Direct";console.log(`\u{1F399}\uFE0F Realtime session ready - Mode: ${t}`),S("Listening");break;case"user_speaking":Xt(!0),S("Hearing you..."),gn(),P(),ie=null,v=null;break;case"user_stopped":Xt(!1),S("Processing..."),Je();break;case"interim":case"transcript":if(P(),e.text&&E){if(ie)ie.textContent=e.text;else{let i=document.createElement("div");i.className="voice-msg user",i.textContent=e.text,v&&v.parentNode===E?E.insertBefore(i,v):E.appendChild(i),ie=i}E.scrollTop=E.scrollHeight}Je();break;case"processing":let n=e.engine||"Spark Opus",s=e.message||`Checking with ${n}...`;console.log(`\u{1F9E0} ${s}`),S(s),Je(),v?(v.textContent=s,v.classList.add("thinking")):(v=Ke("assistant",s),v.classList.add("thinking"));break;case"text_delta":P(),S("Speaking..."),e.delta&&(v?(v.textContent+=e.delta,v.classList.remove("thinking")):v=Ke("assistant",e.delta),E&&(E.scrollTop=E.scrollHeight));break;case"text":P(),e.content&&(v?(v.textContent=e.content,v.classList.remove("thinking")):v=Ke("assistant",e.content));break;case"tts_start":console.log("\u{1F50A} Generating speech..."),S("Speaking..."),P();break;case"audio_chunk":P(),S("Speaking..."),e.data&&(J.push(e.data),Gn());break;case"audio_delta":P(),S("Speaking..."),e.data&&(J.push(e.data),jn());break;case"audio_done":console.log("\u{1F50A} Audio complete");break;case"tool_call":console.log("\u{1F527} Tool call:",e.name);let o=e.name?.replace("get_","").replace("ask_","").replace("_"," ")||"info";S(`Checking ${o}...`),v||(v=Ke("assistant",`Checking ${o}...`),v.classList.add("thinking")),Je();break;case"done":P(),ie=null,v=null,S("Listening");break;case"error":P(),console.error("Realtime error:",e.message),c(e.message||"Voice error",!0),S("Error");break;case"disconnected":P(),pe&&c("Disconnected",!0);break}}function vn(){me="voice",pe=!0,document.body.classList.add("voice-mode"),Q?.classList.add("voice-active"),ie=null,v=null,S("Connecting..."),ke("Connecting..."),fn()}function Ve(){pe=!1,document.body.classList.remove("voice-mode"),Q?.classList.remove("voice-active"),sn?.classList.remove("speaking"),ie=null,v=null,Qn(),gn(),C&&(C.send(JSON.stringify({type:"stop"})),C.close(),C=null),me="chat"}function Xt(e){sn?.classList.toggle("speaking",e)}Ie?.addEventListener("click",vn);Nn?.addEventListener("click",Ve);p?.addEventListener("input",()=>{let e=p.value.trim().length>0||ce;ue?.classList.toggle("show",e),Ie?.classList.toggle("hidden",e),p&&(p.style.height="auto",p.style.height=Math.min(p.scrollHeight,120)+"px")});p?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),$t())});p?.addEventListener("focus",()=>{pe&&Ve(),me="chat",Q?.classList.add("focused")});p?.addEventListener("blur",()=>{setTimeout(()=>{document.activeElement!==p&&Q?.classList.remove("focused")},100)});ue?.addEventListener("click",$t);async function $t(){let e=p?.value.trim();!e||H||(p.value="",p.style.height="auto",ue?.classList.remove("show"),Ie?.classList.remove("hidden"),await N(e,"chat"))}async function es(){try{return at=await navigator.mediaDevices.getUserMedia({audio:!0}),T=new MediaRecorder(at),T.ondataavailable=e=>{e.data.size>0&&dt.push(e.data)},T.onstop=is,!0}catch{return c("Mic access denied",!0),!1}}function hn(){at?.getTracks().forEach(e=>e.stop()),at=null,T=null}function yn(){if(!T){es().then(e=>e&&yn());return}dt=[],T.start(),Tt=Date.now(),me="notes",document.body.classList.add("notes-mode"),Q?.classList.add("notes-active"),Mt=setInterval(Qt,1e3),Qt()}function ts(){T?.state==="recording"&&(T.stop(),clearInterval(Mt),Q?.classList.remove("notes-active"))}function Nt(){document.body.classList.remove("notes-mode"),document.body.classList.remove("notes-results"),Q?.classList.remove("notes-active"),bn(),me="chat"}async function ns(){if(!q.transcription&&!q.summary){c("No note to save",!0);return}try{let e=await fetch("/api/notes/save-file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcription:q.transcription,summary:q.summary,timestamp:Date.now()})}),t=await e.json();e.ok?(c("Note saved \u2713"),Nt()):c("Failed to save",!0)}catch{c("Save failed",!0)}}function ss(){q={transcription:"",summary:""},Se&&(Se.textContent=""),Te&&(Te.textContent=""),c("Note deleted"),Nt()}function os(){T?.state==="recording"&&(T.onstop=()=>{c("Recording discarded"),hn()},T.stop(),clearInterval(Mt),dt=[],document.body.classList.remove("notes-mode"),Q?.classList.remove("notes-active"),me="chat")}function Qt(){let e=Math.floor((Date.now()-Tt)/1e3);it&&(it.textContent=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`)}async function is(){let e=new Blob(dt,{type:"audio/webm"}),t=Math.floor((Date.now()-Tt)/1e3);hn(),document.body.classList.add("notes-results"),F&&(F.textContent="Transcribing...",F.style.display="block"),Le&&(Le.style.display="none"),Ce&&(Ce.style.display="none"),q={transcription:"",summary:""};let n=new FileReader;n.onload=()=>as(n.result.split(",")[1],t),n.readAsDataURL(e)}function as(e,t){if(!m||m.readyState!==WebSocket.OPEN){c("Not connected",!0);return}H=!0,m.send(JSON.stringify({type:"voice_note",audio:e,duration:t}))}function bn(){document.body.classList.remove("notes-results"),it&&(it.textContent="0:00"),F&&(F.style.display="block"),Le&&(Le.style.display="none"),Ce&&(Ce.style.display="none"),Se&&(Se.textContent=""),Te&&(Te.textContent=""),q={transcription:"",summary:""}}Mn?.addEventListener("click",()=>{pe&&Ve(),bn(),yn()});Pn?.addEventListener("click",()=>{T?.state==="recording"&&ts()});Dn?.addEventListener("click",os);Hn?.addEventListener("click",ns);Wn?.addEventListener("click",ss);Rn?.addEventListener("click",Nt);var Lt=localStorage.getItem("spark_session_id"),V=0,wt=!1;async function Zt(){if(M==="chatfeed")try{console.log("\u{1F504} Catching up on missed messages since:",V);let e=await fetch(`/api/messages/recent?since=${V}`);if(!e.ok)return;let n=(await e.json()).messages||[];if(n.length===0){console.log("\u{1F504} No missed messages");return}console.log(`\u{1F504} Found ${n.length} missed message(s)`);for(let s of n){if(vt(s.text))continue;oe(s.text);let o=document.createElement("div");o.className=`msg ${s.role==="user"?"user":"bot"}`,s.role==="user"?o.textContent=s.text:o.innerHTML=Y(s.text),a.appendChild(o),s.timestamp>V&&(V=s.timestamp)}ut()}catch(e){console.error("Catch-up failed:",e)}}function St(){let e=Vt.wsUrl;Lt&&(e+=(e.includes("?")?"&":"?")+`session=${Lt}`),console.log("\u{1F50C} Connecting to:",e),De("connecting");try{m=new WebSocket(e),m.onopen=()=>{console.log("\u2705 Chat WebSocket connected"),De("connected"),wt&&Zt(),wt=!1},m.onclose=t=>{console.log("\u{1F50C} Chat WebSocket closed:",t.code,t.reason),De("disconnected"),wt=!0,setTimeout(St,2e3)},m.onerror=t=>{console.error("\u274C Chat WebSocket error:",t),De("disconnected")},document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(console.log("\u{1F441}\uFE0F Page visible, checking WebSocket..."),!m||m.readyState!==WebSocket.OPEN?(console.log("\u{1F504} WebSocket stale, reconnecting..."),St()):Zt())}),m.onmessage=t=>{try{let n=JSON.parse(t.data);console.log("\u{1F4E8} WS received:",n.type,n.content?.slice?.(0,50)||""),ls(n)}catch(n){console.error("\u274C WS message error:",n,t.data?.slice?.(0,100))}}}catch(t){console.error("\u274C Failed to create WebSocket:",t),De("disconnected")}}async function N(e,t){if(!m||m.readyState!==WebSocket.OPEN){c("Not connected",!0);return}if(M==="intro"){if(A)try{await A,console.log("\u{1F4DC} History ready, preloaded:",f?.length||0,"messages")}catch{console.log("History load failed, continuing anyway")}!O&&f&&f.length>0&&!Me&&(console.log("\u{1F4DC} Rendering history before first message"),At()),Z({skipHistory:!0})}H=!0,Ee();let n=document.createElement("div");n.className="msg user",n.textContent=e,a.appendChild(n),a.scrollTop=a.scrollHeight,oe(e),X(),O?(console.log(`\u{1F4E6} Sending to ${O} mode session`),m.send(JSON.stringify({type:"mode_message",sparkMode:O,text:e}))):m.send(JSON.stringify({type:"transcript",text:e,mode:t}))}function ls(e){switch(e.type){case"ready":e.sessionId&&(Lt=e.sessionId,localStorage.setItem("spark_session_id",e.sessionId),console.log("\u{1F4CB} Session:",e.sessionId)),e.pending&&(console.log("\u23F3 Pending request detected - showing loading"),X()),console.log("\u2705 Chat ready");break;case"sync":if(console.log("\u{1F4E1} Sync message:",e.message?.source,e.message?.text?.slice(0,50)),Jt(),e.message&&e.message.text){if(e.message.timestamp&&e.message.timestamp>V&&(V=e.message.timestamp),vt(e.message.text)){console.log("\u{1F4E1} Skipping duplicate sync message (hash match)");break}if(M==="chatfeed"){oe(e.message.text);let t=document.createElement("div");t.className=`msg ${e.message.role==="user"?"user":"bot"}`,e.message.role==="user"?t.textContent=e.message.text:t.innerHTML=Y(e.message.text),e.message.source==="whatsapp"&&(t.title="From WhatsApp"),a.appendChild(t),ut(),e.message.role==="bot"&&G()}else M==="intro"&&e.message.role==="bot"&&c("New message from Spark")}break;case"thinking":console.log("\u{1F914} Server thinking..."),qe&&nt.classList.contains("show")?wn():X();break;case"text":if(console.log("\u2705 Text message received:",e.content?.slice?.(0,100)),document.body.classList.contains("notes-mode")&&Te)e.content&&(F&&(F.style.display="none"),Te.innerHTML=Y(e.content),q.summary=e.content,Ce&&(Ce.style.display="block"));else if(qe&&nt.classList.contains("show"))rt(),e.content&&(ct("bot",e.content),tn.textContent="\u25CF Active",tn.classList.add("active"));else{G(),ke("");let t=a?.querySelector(".msg.system:last-child");t?.textContent==="Transcribing..."&&t.remove(),e.content?(Et(e.content,"bot"),console.log("\u2705 Bot message added to DOM")):console.warn("\u26A0\uFE0F Empty text content received")}break;case"transcription":if(document.body.classList.contains("notes-mode")&&Se)Se.textContent=e.text,q.transcription=e.text,Le&&(Le.style.display="block"),F&&(F.textContent="Summarizing...");else{let t=a?.querySelector(".msg.system:last-child");t?.textContent==="Transcribing..."&&t.remove(),Et("\u{1F4DD} "+e.text,"bot")}break;case"audio":cs(e.data);break;case"done":H=!1,xe=!1,ke(""),Ee(),ot(),Ue(),Jt(),me==="voice"&&!pe&&vn();break;case"error":qe&&nt.classList.contains("show")?(rt(),ct("bot",`Error: ${e.message||"Something went wrong"}`),xe=!1):G(),c(e.message||"Error",!0),H=!1,ke(""),Ee(),ot();break;case"mode_history":console.log(`\u{1F4E6} Mode history received for ${e.mode}:`,e.messages?.length||0,"messages"),e.mode&&e.messages&&(lt[e.mode]=e.messages,O===e.mode&&rn(e.mode));break}}async function cs(e){He||(He=new(window.AudioContext||window.webkitAudioContext));try{let t=Uint8Array.from(atob(e),s=>s.charCodeAt(0)),n=await He.decodeAudioData(t.buffer.slice(0));if(ye)try{ye.stop()}catch{}ye=He.createBufferSource(),ye.buffer=n,ye.connect(He.destination),ye.start(0)}catch(t){console.error("Audio error:",t)}}var tt=document.getElementById("msg-menu"),rs=document.getElementById("menu-copy"),ds=document.getElementById("menu-edit"),us=document.getElementById("menu-delete"),$=null,Pt=null;function ms(e,t,n){$=e,e.classList.add("selected");let s=148,o=60,i=Math.min(t,window.innerWidth-s-10),d=Math.max(n-o-10,10);tt.style.left=i+"px",tt.style.top=d+"px",tt.classList.add("show")}function mt(){tt?.classList.remove("show"),$?.classList.remove("selected"),$=null}a?.addEventListener("touchstart",e=>{let t=e.target.closest(".msg");if(!t||t.classList.contains("system")||t.classList.contains("thinking"))return;let n=e.touches[0];Pt=setTimeout(()=>{e.preventDefault(),ms(t,n.clientX,n.clientY)},500)},{passive:!1});a?.addEventListener("touchend",()=>{clearTimeout(Pt)});a?.addEventListener("touchmove",()=>{clearTimeout(Pt)});document.addEventListener("touchstart",e=>{!e.target.closest("#msg-menu")&&!e.target.closest(".msg")&&mt()});rs?.addEventListener("click",()=>{if(!$)return;let e=$.textContent||$.innerText;navigator.clipboard.writeText(e).then(()=>{c("Copied!")}).catch(()=>{c("Failed to copy",!0)}),mt()});ds?.addEventListener("click",()=>{if(!$)return;let e=$.textContent||$.innerText;p&&(p.value=e,p.style.height="auto",p.style.height=Math.min(p.scrollHeight,120)+"px",ue?.classList.add("show"),p.focus()),mt()});us?.addEventListener("click",()=>{$&&($.remove(),c("Deleted"),mt())});St();Bt();var en=0;document.addEventListener("touchend",e=>{let t=Date.now();t-en<=300&&e.preventDefault(),en=t},{passive:!1});var z=document.getElementById("pc-status");async function de(){try{let t=await(await fetch("/api/nodes/status")).json();z&&(z.classList.toggle("connected",t.connected),z.title=t.connected?`${t.nodeName||"PC"} connected`:"PC disconnected")}catch(e){console.error("PC status check failed:",e),z&&z.classList.remove("connected")}}de();var j=setInterval(de,3e4);document.addEventListener("visibilitychange",()=>{document.hidden?j&&(clearInterval(j),j=null):j||(de(),j=setInterval(de,3e4))});var be=null;z?.addEventListener("click",async()=>{if(be&&(clearInterval(be),be=null),z.classList.contains("connected")){c("PC is already connected");return}c("Waking PC...");try{let t=await(await fetch("/api/nodes/wake",{method:"POST"})).json();if(t.success){c("Wake signal sent! Waiting for PC..."),clearInterval(j);let n=0;be=setInterval(async()=>{n++,await de(),z.classList.contains("connected")?(c("PC connected! \u2705"),clearInterval(be),j=setInterval(de,3e4)):n>=24&&(c("PC did not respond",!0),clearInterval(be),j=setInterval(de,3e4))},5e3)}else c("Wake failed: "+(t.error||"Unknown error"),!0)}catch(e){c("Wake request failed",!0),console.error("WoL error:",e)}});if(window.visualViewport){let e=window.visualViewport.height;window.visualViewport.addEventListener("resize",()=>{let t=e-window.visualViewport.height;document.body.classList.toggle("keyboard-open",t>150)})}document.querySelectorAll(".shortcut").forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.msg;t&&N(t,"chat")})});document.getElementById("articulations-btn")?.addEventListener("click",async()=>{await ln("articulate"),p&&(p.placeholder="Type text to refine..."),p?.focus()});var D={"spark-dev-mode":null,"spark-research-mode":null,"spark-plan-mode":null,"spark-videogen-mode":null},ps={"devteam-btn":"spark-dev-mode","researcher-btn":"spark-research-mode","plan-btn":"spark-plan-mode","videogen-btn":"spark-videogen-mode"},gs={dev:"spark-dev-mode",research:"spark-research-mode",plan:"spark-plan-mode",videogen:"spark-videogen-mode"};async function Ue(){try{let t=await(await fetch("/api/active-sessions")).json();D["spark-dev-mode"]=null,D["spark-research-mode"]=null,D["spark-plan-mode"]=null,D["spark-videogen-mode"]=null;for(let n of t.sessions||[]){let s=n.label||"";s.includes("dev-mode")||n.key?.includes("dev-mode")?D["spark-dev-mode"]=n:s.includes("research-mode")||n.key?.includes("research-mode")?D["spark-research-mode"]=n:s.includes("plan-mode")||n.key?.includes("plan-mode")?D["spark-plan-mode"]=n:(s.includes("videogen-mode")||n.key?.includes("videogen-mode"))&&(D["spark-videogen-mode"]=n)}fs()}catch(e){console.error("Failed to check active sessions:",e)}}function fs(){for(let[e,t]of Object.entries(ps)){let n=document.getElementById(e);if(n){let s=D[t]!==null;n.classList.toggle("session-active",s);let o=n.querySelector(".shortcut-sub");if(o)if(s){let i=o.dataset.originalText||o.textContent;o.dataset.originalText=i,o.textContent="\u25CF Session active"}else o.dataset.originalText&&(o.textContent=o.dataset.originalText)}}}function Dt(e){let t=gs[e]||e;return D[t]}var nt=document.getElementById("session-page"),le=document.getElementById("session-messages"),R=document.getElementById("session-input"),Ht=document.getElementById("session-send-btn"),vs=document.getElementById("session-back-btn"),Fs=document.getElementById("session-icon"),qs=document.getElementById("session-title"),tn=document.getElementById("session-status"),qe=null,xe=!1;function hs(){nt.classList.remove("show"),qe=null,xe=!1}function ct(e,t){let n=le.querySelector(".session-empty-state");n&&n.remove();let s=document.createElement("div");return s.className=`msg ${e}`,e==="bot"?s.innerHTML=Y(t):s.textContent=t,le.appendChild(s),le.scrollTop=le.scrollHeight,s}function wn(){rt();let e=document.createElement("div");e.className="msg bot thinking",e.id="session-thinking-indicator",e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div>',le.appendChild(e),le.scrollTop=le.scrollHeight}function rt(){document.getElementById("session-thinking-indicator")?.remove()}async function kn(){let e=R.value.trim();!e||xe||(R.value="",R.style.height="auto",Ht.classList.remove("active"),xe=!0,ct("user",e),wn(),m&&m.readyState===WebSocket.OPEN?m.send(JSON.stringify({type:"mode_message",sparkMode:qe,text:e})):(rt(),ct("bot","Not connected. Please try again."),xe=!1))}R?.addEventListener("input",()=>{let e=R.value.trim().length>0;Ht?.classList.toggle("active",e),R.style.height="auto",R.style.height=Math.min(R.scrollHeight,120)+"px"});R?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),kn())});Ht?.addEventListener("click",kn);vs?.addEventListener("click",hs);Ue();var We=setInterval(Ue,1e4);document.addEventListener("visibilitychange",()=>{document.hidden?We&&(clearInterval(We),We=null):We||(Ue(),We=setInterval(Ue,1e4))});function Wt({icon:e,title:t,subtitle:n,placeholder:s,submitText:o,onSubmit:i,activeSession:d,onViewSession:y}){let u=document.createElement("div");u.className="bottom-sheet-overlay";let r=document.createElement("div");r.className="bottom-sheet";let Be=d?`
    <button class="bottom-sheet-active-session">
      <span class="active-dot">\u25CF</span>
      View Active Session
    </button>
  `:"";r.innerHTML=`
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-icon">${e}</span>
      <div class="bottom-sheet-titles">
        <h2 class="bottom-sheet-title">${t}</h2>
        <p class="bottom-sheet-subtitle">${n}</p>
      </div>
    </div>
    ${Be}
    <textarea class="bottom-sheet-input" placeholder="${s}" rows="1"></textarea>
    <button class="bottom-sheet-submit">${o}</button>
  `,document.body.appendChild(u),document.body.appendChild(r);let L=r.querySelector(".bottom-sheet-input"),I=r.querySelector(".bottom-sheet-submit"),Ae=r.querySelector(".bottom-sheet-handle"),ee=r.querySelector(".bottom-sheet-active-session");function W(){r.classList.add("closing"),r.classList.remove("visible"),u.classList.remove("visible"),setTimeout(()=>{u.remove(),r.remove()},200)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{u.classList.add("visible"),r.classList.add("visible"),L.focus()})}),u.addEventListener("click",W);let te=0,ne=0,se=!1;function ge(h){let b=h.target;(b===Ae||b===r&&r.scrollTop===0)&&(te=h.touches[0].clientY,ne=te,se=!0,r.style.transition="none")}function pt(h){if(!se)return;ne=h.touches[0].clientY;let b=ne-te;b>0&&(window.innerWidth>=520?r.style.transform=`translateX(-50%) translateY(${b}px)`:r.style.transform=`translateY(${b}px)`)}function B(){if(!se)return;se=!1,r.style.transition="",ne-te>100?W():window.innerWidth>=520?r.style.transform="translateX(-50%) translateY(0)":r.style.transform="translateY(0)"}r.addEventListener("touchstart",ge,{passive:!0}),r.addEventListener("touchmove",pt,{passive:!0}),r.addEventListener("touchend",B);function fe(h){h.key==="Escape"&&(W(),document.removeEventListener("keydown",fe))}document.addEventListener("keydown",fe);function ve(){let h=L.value.trim();if(!h){L.classList.add("error"),setTimeout(()=>L.classList.remove("error"),300);return}W(),i(h)}return I.addEventListener("click",ve),ee&&y&&ee.addEventListener("click",()=>{W(),y(d)}),L.addEventListener("keydown",h=>{h.key==="Enter"&&(h.metaKey||h.ctrlKey)&&(h.preventDefault(),ve())}),L.addEventListener("input",()=>{L.style.height="auto",L.style.height=Math.min(L.scrollHeight,120)+"px"}),{close:W}}function Rt(e){if(!e)return;Z();let t=document.createElement("div");t.className="msg system",t.innerHTML=`
    <strong>Viewing ${e.label||"subagent"} session</strong><br>
    <small style="opacity: 0.7">Session key: ${e.key}</small>
  `,a.appendChild(t),N(`Show me the recent activity from the ${e.label||"subagent"} session (key: ${e.key})`,"chat")}document.getElementById("devteam-btn")?.addEventListener("click",()=>{let e=Dt("spark-dev-mode");Wt({icon:"\u{1F468}\u200D\u{1F4BB}",title:"Dev Mode",subtitle:e?"\u25CF Session active":"Isolated coding session",placeholder:"Describe the task or issue to fix...",submitText:"Start Dev Session",activeSession:e,onViewSession:Rt,onSubmit:t=>N(`/dev ${t}`,"chat")})});document.getElementById("researcher-btn")?.addEventListener("click",()=>{let e=Dt("spark-research-mode");Wt({icon:"\u{1F52C}",title:"Research Mode",subtitle:e?"\u25CF Session active":"Deep dive research",placeholder:"What topic do you want to research?",submitText:"Start Research",activeSession:e,onViewSession:Rt,onSubmit:t=>N(`/research ${t}`,"chat")})});document.getElementById("plan-btn")?.addEventListener("click",()=>{let e=Dt("spark-plan-mode");Wt({icon:"\u{1F4CB}",title:"Plan Mode",subtitle:e?"\u25CF Session active":"Create detailed specs",placeholder:"What do you want to plan?",submitText:"Start Planning",activeSession:e,onViewSession:Rt,onSubmit:t=>N(`/plan ${t}`,"chat")})});document.getElementById("videogen-btn")?.addEventListener("click",()=>{ys()});function ys(){let e=document.createElement("div");e.className="bottom-sheet-overlay";let t=document.createElement("div");t.className="bottom-sheet",t.innerHTML=`
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-icon">\u{1F3AC}</span>
      <div class="bottom-sheet-titles">
        <h2 class="bottom-sheet-title">Video Gen</h2>
        <p class="bottom-sheet-subtitle" id="videogen-subtitle">AI video generation</p>
      </div>
    </div>
    
    <div class="bottom-sheet-row">
      <label class="bottom-sheet-label">Workflow</label>
      <div class="option-selector" id="videogen-workflow">
        <button class="option-pill selected" data-value="text2video">Text \u2192 Video</button>
        <button class="option-pill" data-value="image2video">Image \u2192 Video</button>
        <button class="option-pill" data-value="faceswap">Face Swap</button>
      </div>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-prompt-row">
      <label class="bottom-sheet-label">Prompt</label>
      <textarea class="bottom-sheet-input" id="videogen-prompt" placeholder="Describe the video you want to create..." rows="2"></textarea>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-image-row" style="display:none;">
      <label class="bottom-sheet-label" id="videogen-image-label">Reference Image</label>
      <div class="image-upload-area" id="videogen-upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <div class="upload-text">Tap to upload image</div>
        <div class="upload-hint" id="videogen-image-hint">For image-to-video generation</div>
      </div>
      <input type="file" id="videogen-file-input" accept="image/*" style="display:none">
    </div>
    
    <div class="bottom-sheet-row" id="videogen-video-row" style="display:none;">
      <label class="bottom-sheet-label">Target Video</label>
      <div class="image-upload-area" id="videogen-video-upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
        </div>
        <div class="upload-text">Tap to upload video or paste URL</div>
        <div class="upload-hint">YouTube/video URL or upload file</div>
      </div>
      <input type="file" id="videogen-video-file-input" accept="video/*" style="display:none">
      <input type="text" class="bottom-sheet-input" id="videogen-video-url" placeholder="Or paste YouTube/video URL..." style="margin-top:8px; display:none;">
    </div>
    
    <div class="bottom-sheet-row" id="videogen-aspect-row">
      <label class="bottom-sheet-label">Aspect Ratio</label>
      <div class="option-selector" id="videogen-aspect">
        <button class="option-pill selected" data-value="16:9">16:9</button>
        <button class="option-pill" data-value="9:16">9:16</button>
        <button class="option-pill" data-value="1:1">1:1</button>
      </div>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-duration-row">
      <label class="bottom-sheet-label">Duration</label>
      <div class="option-selector" id="videogen-duration">
        <button class="option-pill selected" data-value="5">5 seconds</button>
        <button class="option-pill" data-value="10">10 seconds</button>
      </div>
    </div>
    
    <button class="bottom-sheet-submit" id="videogen-submit">Generate Video</button>
  `,document.body.appendChild(e),document.body.appendChild(t);let n=t.querySelector("#videogen-subtitle"),s=t.querySelector("#videogen-workflow"),o=t.querySelector("#videogen-prompt-row"),i=t.querySelector("#videogen-prompt"),d=t.querySelector("#videogen-image-row"),y=t.querySelector("#videogen-image-label"),u=t.querySelector("#videogen-image-hint"),r=t.querySelector("#videogen-upload-area"),Be=t.querySelector("#videogen-file-input"),L=t.querySelector("#videogen-video-row"),I=t.querySelector("#videogen-video-upload-area"),Ae=t.querySelector("#videogen-video-file-input"),ee=t.querySelector("#videogen-video-url"),W=t.querySelector("#videogen-aspect-row"),te=t.querySelector("#videogen-aspect"),ne=t.querySelector("#videogen-duration-row"),se=t.querySelector("#videogen-duration"),ge=t.querySelector("#videogen-submit"),pt=t.querySelector(".bottom-sheet-handle"),B="text2video",fe="16:9",ve="5",h=null,b=null,$e=null,Ne=null,U=null;function Ye(){t.classList.add("closing"),t.classList.remove("visible"),e.classList.remove("visible"),setTimeout(()=>{e.remove(),t.remove()},200)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.classList.add("visible"),t.classList.add("visible"),i.focus()})}),e.addEventListener("click",Ye);let _e=0,ze=0,je=!1;function xn(g){let l=g.target;(l===pt||l===t&&t.scrollTop===0)&&(_e=g.touches[0].clientY,ze=_e,je=!0,t.style.transition="none")}function En(g){if(!je)return;ze=g.touches[0].clientY;let l=ze-_e;l>0&&(window.innerWidth>=520?t.style.transform=`translateX(-50%) translateY(${l}px)`:t.style.transform=`translateY(${l}px)`)}function Ln(){if(!je)return;je=!1,t.style.transition="",ze-_e>100?Ye():window.innerWidth>=520?t.style.transform="translateX(-50%) translateY(0)":t.style.transform="translateY(0)"}t.addEventListener("touchstart",xn,{passive:!0}),t.addEventListener("touchmove",En,{passive:!0}),t.addEventListener("touchend",Ln);function qt(g){g.key==="Escape"&&(Ye(),document.removeEventListener("keydown",qt))}document.addEventListener("keydown",qt);function Sn(){switch(o.style.display="block",d.style.display="none",L.style.display="none",W.style.display="block",ne.style.display="block",ee.style.display="none",B){case"text2video":n.textContent="Generate video from text prompt",i.placeholder="Describe the video you want to create...",ge.textContent="Generate Video";break;case"image2video":n.textContent="Animate an image into video",i.placeholder="Describe the motion/action (optional)...",d.style.display="block",y.textContent="Source Image",u.textContent="Image to animate",ge.textContent="Generate Video";break;case"faceswap":n.textContent="Swap face in a video",o.style.display="none",d.style.display="block",L.style.display="block",W.style.display="none",ne.style.display="none",y.textContent="Face Image",u.textContent="Photo with the face to use",ee.style.display="block",ge.textContent="Swap Face";break}}s.addEventListener("click",g=>{let l=g.target.closest(".option-pill");l&&(s.querySelectorAll(".option-pill").forEach(w=>w.classList.remove("selected")),l.classList.add("selected"),B=l.dataset.value,Sn())}),te.addEventListener("click",g=>{let l=g.target.closest(".option-pill");l&&(te.querySelectorAll(".option-pill").forEach(w=>w.classList.remove("selected")),l.classList.add("selected"),fe=l.dataset.value)}),se.addEventListener("click",g=>{let l=g.target.closest(".option-pill");l&&(se.querySelectorAll(".option-pill").forEach(w=>w.classList.remove("selected")),l.classList.add("selected"),ve=l.dataset.value)});function Cn(){h=null,b=null,r.classList.remove("has-image"),r.innerHTML=`
      <div class="upload-icon">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="upload-text">Tap to upload image</div>
      <div class="upload-hint" id="videogen-image-hint">${B==="faceswap"?"Photo with the face to use":"Image to animate"}</div>
    `,Be.value=""}function Ot(){$e=null,Ne=null,U=null,I.classList.remove("has-image"),I.innerHTML=`
      <div class="upload-icon">
        <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
      </div>
      <div class="upload-text">Tap to upload video or paste URL</div>
      <div class="upload-hint">YouTube/video URL or upload file</div>
    `,Ae.value="",ee.value=""}r.addEventListener("click",()=>{h||Be.click()}),Be.addEventListener("change",async g=>{let l=g.target.files?.[0];if(!l)return;h=l;let w=new FileReader;w.onload=gt=>{b=gt.target.result,r.classList.add("has-image"),r.innerHTML=`
        <div class="image-preview-container">
          <img class="image-preview-thumb" src="${b}" alt="Preview">
          <div class="image-preview-info">
            <div class="image-preview-name">${l.name}</div>
            <div class="image-preview-size">${Ge(l.size)}</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-image">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-image")?.addEventListener("click",ft=>{ft.stopPropagation(),Cn()})},w.readAsDataURL(l)}),I.addEventListener("click",()=>{!$e&&!U&&Ae.click()}),Ae.addEventListener("change",async g=>{let l=g.target.files?.[0];if(!l)return;$e=l,U=null;let w=new FileReader;w.onload=gt=>{Ne=gt.target.result,I.classList.add("has-image"),I.innerHTML=`
        <div class="image-preview-container">
          <div class="upload-icon" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--msg-bot);border-radius:8px;">
            <svg viewBox="0 0 24 24" style="width:30px;height:30px;stroke:var(--text-secondary);fill:none;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </div>
          <div class="image-preview-info">
            <div class="image-preview-name">${l.name}</div>
            <div class="image-preview-size">${Ge(l.size)}</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-video">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-video")?.addEventListener("click",ft=>{ft.stopPropagation(),Ot()})},w.readAsDataURL(l)}),ee.addEventListener("input",g=>{let l=g.target.value.trim();l&&(l.includes("youtube.com")||l.includes("youtu.be")||l.includes("http"))&&(U=l,$e=null,Ne=null,I.classList.add("has-image"),I.innerHTML=`
        <div class="image-preview-container">
          <div class="upload-icon" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--msg-bot);border-radius:8px;">
            <svg viewBox="0 0 24 24" style="width:30px;height:30px;stroke:var(--text-secondary);fill:none;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </div>
          <div class="image-preview-info">
            <div class="image-preview-name" style="word-break:break-all;">${l.length>40?l.substring(0,40)+"...":l}</div>
            <div class="image-preview-size">Video URL</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-video">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-video")?.addEventListener("click",w=>{w.stopPropagation(),Ot()}))}),ge.addEventListener("click",()=>{let g=i.value.trim();if(B==="text2video"){if(!g){i.classList.add("error"),setTimeout(()=>i.classList.remove("error"),300);return}}else if(B==="image2video"){if(!b){r.style.borderColor="var(--red)",setTimeout(()=>r.style.borderColor="",300);return}}else if(B==="faceswap"){if(!b){r.style.borderColor="var(--red)",setTimeout(()=>r.style.borderColor="",300);return}if(!Ne&&!U){I.style.borderColor="var(--red)",setTimeout(()=>I.style.borderColor="",300);return}}if(Ye(),Z(),B==="text2video"){let l=`/video --ratio ${fe} --duration ${ve}s ${g}`;N(l,"chat")}else if(B==="image2video"){let l=`/video --ratio ${fe} --duration ${ve}s`;g&&(l+=` ${g}`),bs(l,b)}else if(B==="faceswap"){let l="/faceswap";U&&(l+=` --video-url ${U}`),ws(l,b,Ne,U)}}),i.addEventListener("input",()=>{i.style.height="auto",i.style.height=Math.min(i.scrollHeight,120)+"px"})}function bs(e,t){if(!m||m.readyState!==WebSocket.OPEN){c("Not connected",!0);return}H=!0,Ee();let n=document.createElement("div");n.className="msg user",n.textContent=e+" \u{1F4F7}",a.appendChild(n),a.scrollTop=a.scrollHeight,oe(e),X(),m.send(JSON.stringify({type:"transcript",text:e,image:t,mode:"chat"}))}function ws(e,t,n,s){if(!m||m.readyState!==WebSocket.OPEN){c("Not connected",!0);return}H=!0,Ee();let o=document.createElement("div");o.className="msg user",o.textContent=e+" \u{1F3AD}\u{1F4F7}\u{1F3AC}",a.appendChild(o),a.scrollTop=a.scrollHeight,oe(e),X(),m.send(JSON.stringify({type:"transcript",text:e,image:t,video:n,videoUrl:s,mode:"chat"}))}var ks=N;N=async function(e,t){on?await xs(e):await ks(e,t)};async function xs(e){if(!e.trim())return;M==="intro"&&Z({skipHistory:!0});let t=document.createElement("div");t.className="msg user",t.textContent=e,a.appendChild(t),a.scrollTop=a.scrollHeight,X();try{let s=await(await fetch("/api/articulate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})})).json();if(G(),s.result){let o=document.createElement("div");o.className="msg bot",o.textContent=s.result,a.appendChild(o),a.scrollTop=a.scrollHeight}}catch{G(),c("Failed to refine text",!0)}}document.getElementById("todays-reports-btn")?.addEventListener("click",async()=>{await ln("dailyreports");let e=document.createElement("div");e.className="msg system",e.textContent="Loading today's reports...",a.appendChild(e);try{let n=await(await fetch("/api/reports/today")).json();if(e.remove(),!n.reports?.length){N("Show me today's reports or generate a new briefing if none exist.","chat");return}let s=document.createElement("div");s.className="msg system",s.textContent=`\u{1F4CA} Today's Reports (${n.reports.length})`,a.appendChild(s),n.reports.forEach(o=>{let i=document.createElement("div");i.className="msg bot",i.innerHTML=Y(o.summary),a.appendChild(i)}),a.scrollTop=a.scrollHeight}catch(t){e.textContent="Failed to load reports",console.error("Failed to load reports:",t)}});var Ft=document.getElementById("attachment-preview"),Qe=document.getElementById("attachment-icon"),Es=document.getElementById("attachment-name"),Ls=document.getElementById("attachment-size"),Ss=document.getElementById("remove-attachment-btn"),ce=null;In?.addEventListener("click",()=>kt?.click());kt?.addEventListener("change",e=>{let t=e.target.files?.[0];t&&(ce=t,Es.textContent=t.name,Ls.textContent=Ge(t.size),t.type.startsWith("image/")?(Qe.classList.add("image"),Qe.innerHTML='<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>'):(Qe.classList.remove("image"),Qe.innerHTML='<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>'),Ft?.classList.add("show"),ue?.classList.add("show"),Ie?.classList.add("hidden"),p?.focus(),kt.value="")});Ss?.addEventListener("click",()=>{ce=null,Ft?.classList.remove("show"),p?.value.trim()||(ue?.classList.remove("show"),Ie?.classList.remove("hidden"))});$t=async function(){let e=p?.value.trim()||"";if(!e&&!ce||H)return;let t=e,n=null;if(ce){let s=ce;try{if(s.type.startsWith("image/"))n=await new Promise((o,i)=>{let d=new FileReader;d.onload=()=>o(d.result),d.onerror=i,d.readAsDataURL(s)}),t=e||"What is this image?";else{let o=await new Promise((d,y)=>{let u=new FileReader;u.onload=()=>d(u.result),u.onerror=y,u.readAsText(s)}),i=o.slice(0,2e3)+(o.length>2e3?"...":"");t=e?`${e}

[File: ${s.name}]
${i}`:`[File: ${s.name}]
${i}`}}catch{c("Failed to read file",!0);return}ce=null,Ft?.classList.remove("show")}t&&(p.value="",p.style.height="auto",ue?.classList.remove("show"),Ie?.classList.remove("hidden"),n?Cs(t,n):N(t,"chat"))};function Cs(e,t){if(!m||m.readyState!==WebSocket.OPEN){c("Not connected",!0);return}H=!0;let n=Et(e+" \u{1F4F7}","user",{userInitiated:!0});X(),m.send(JSON.stringify({type:"transcript",text:e,image:t,mode:"chat"}))}
