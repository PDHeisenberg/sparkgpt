var nt={wsUrl:(()=>{let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,s=location.pathname.replace(/\/+$/,"");return s&&s!=="/"?`${t}${s}`:t})(),silenceMs:1500,maxFileSize:10485760};var Ue=new Set,Ds=50;function zt(e){let t=(e||"").trim().slice(0,200),s=0;for(let n=0;n<t.length;n++)s=(s<<5)-s+t.charCodeAt(n),s=s&s;return s.toString(36)}function ae(e){let t=zt(e);if(Ue.add(t),Ue.size>Ds){let s=Ue.values();for(let n=0;n<10;n++)Ue.delete(s.next().value)}}function Lt(e){return Ue.has(zt(e))}function ot(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function J(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^(.*)$/,"<p>$1</p>").replace(/<p><\/p>/g,"")}function ke(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function xt(e){return e?.content?typeof e.content=="string"?e.content:Array.isArray(e.content)&&e.content.find(s=>s.type==="text")?.text||null:null}function Gt(){let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,s=location.pathname.replace(/\/+$/,"");return s&&s!=="/"?`${t}${s}/realtime`:`${t}/realtime`}function Kt(e){let t=new Int16Array(e.length);for(let o=0;o<e.length;o++){let i=Math.max(-1,Math.min(1,e[o]));t[o]=i<0?i*32768:i*32767}let s=new Uint8Array(t.buffer),n="";for(let o=0;o<s.length;o++)n+=String.fromCharCode(s[o]);return btoa(n)}function Xt(e){let t=atob(e),s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);let n=new Int16Array(s.buffer),o=new Float32Array(n.length);for(let i=0;i<n.length;i++)o[i]=n[i]/(n[i]<0?32768:32767);return o}var a=document.getElementById("messages"),gt=document.getElementById("welcome"),p=document.getElementById("text-input"),pe=document.getElementById("send-btn"),He=document.getElementById("voice-btn"),Hs=document.getElementById("notes-btn"),Tt=document.getElementById("status"),On=document.getElementById("timer"),Ct=document.getElementById("toast"),Ps=document.getElementById("upload-btn"),lt=document.getElementById("file-input"),te=document.getElementById("bottom"),re=document.getElementById("spark-status");function _e(e){re&&(re.classList.remove("connected","connecting"),e==="connected"?(re.classList.add("connected"),re.title="Clawdbot Gateway: Connected"):e==="connecting"?(re.classList.add("connecting"),re.title="Clawdbot Gateway: Connecting..."):re.title="Clawdbot Gateway: Disconnected")}var is=document.getElementById("voice-bar"),Fs=document.getElementById("close-voice-btn"),qn=document.getElementById("waveform"),x=document.getElementById("voice-content"),Qt=document.getElementById("voice-status"),Un=document.getElementById("notes-content"),ft=document.getElementById("notes-timer"),_n=document.getElementById("notes-bar"),Ws=document.getElementById("close-notes-btn"),Rs=document.getElementById("delete-notes-btn"),Yn=document.getElementById("notes-recording"),Vn=document.getElementById("notes-results"),R=document.getElementById("notes-status"),Me=document.getElementById("notes-transcription-msg"),Ie=document.getElementById("notes-transcription"),Be=document.getElementById("notes-summary-msg"),$e=document.getElementById("notes-summary"),Os=document.getElementById("notes-save-btn"),qs=document.getElementById("notes-delete-btn"),Us=document.getElementById("notes-back-btn"),O={transcription:"",summary:""},_s=document.getElementById("close-btn"),Ge=document.getElementById("history-btn"),Ys=document.getElementById("theme-btn");function Vs(){let e=localStorage.getItem("theme");e&&document.documentElement.setAttribute("data-theme",e)}Vs();Ys?.addEventListener("click",()=>{let e=document.documentElement.getAttribute("data-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,s;e==="dark"?s="light":e==="light"?s="dark":s=t?"light":"dark",document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s)});var l=null,ge="chat",$="intro",as=!1,fe=!1,Se=0,Mt=5,Y=!1,Ye=null,Ee=null,B=null,bt=[],Ht=null,Pt=null,ht=null,q=null,vt={},dt={},rs={dev:{name:"Dev Mode",icon:"\u{1F468}\u200D\u{1F4BB}",notifyWhatsApp:!0},research:{name:"Research Mode",icon:"\u{1F52C}",notifyWhatsApp:!0},plan:{name:"Plan Mode",icon:"\u{1F4CB}",notifyWhatsApp:!0},articulate:{name:"Articulate Mode",icon:"\u270D\uFE0F",notifyWhatsApp:!1},dailyreports:{name:"Daily Reports",icon:"\u{1F4CA}",notifyWhatsApp:!0},videogen:{name:"Video Gen",icon:"\u{1F3AC}",notifyWhatsApp:!0}};async function js(){try{dt=(await(await fetch("/api/modes")).json()).modes||{},console.log("\u{1F4E6} Loaded mode configs:",Object.keys(dt))}catch(e){console.error("Failed to load mode configs:",e),dt=rs}}function Ft(e){return dt[e]||rs[e]||{name:e,icon:"\u{1F4E6}"}}async function cs(e){let t=Ft(e);console.log(`\u{1F4E6} Entering ${t.name}...`),q=e,he(),ls(),await Js(e),ds(e)}function ls(){let e=document.getElementById("mode-indicator");if(q){let t=Ft(q);e||(e=document.createElement("div"),e.id="mode-indicator",e.className="mode-indicator",document.querySelector(".top-bar")?.appendChild(e)),e.innerHTML=`
      <span class="mode-icon">${t.icon}</span>
      <span class="mode-name">${t.name}</span>
      <button class="mode-exit-btn" onclick="exitMode()">\u2715</button>
    `,e.style.display="flex"}else e&&(e.style.display="none")}async function Js(e){try{if(l&&l.readyState===WebSocket.OPEN)l.send(JSON.stringify({type:"mode_history",sparkMode:e}));else{let s=await(await fetch(`/api/modes/${e}/history`)).json();vt[e]=s.messages||[]}}catch(t){console.error(`Failed to load ${e} history:`,t),vt[e]=[]}}function ds(e){let t=vt[e]||[];if(a.querySelectorAll(".msg, .mode-empty-state").forEach(s=>s.remove()),t.length===0){let s=Ft(e),n=document.createElement("div");n.className="mode-empty-state",n.innerHTML=`
      <div class="mode-empty-icon">${s.icon}</div>
      <div class="mode-empty-title">${s.name}</div>
      <div class="mode-empty-desc">Start a conversation in this mode.</div>
    `,a.appendChild(n)}else for(let s of t){let n=xt(s);n&&addMessage(s.role==="assistant"?"bot":"user",n)}scrollToBottom()}js();var f=null,H=null,Ne=!1;function Wt(e=!1){return H&&!e||(H=fetch("/api/messages/all").then(t=>t.json()).then(t=>{if(f=t.messages||[],console.log(`\u{1F4DC} Pre-loaded ${f.length} messages`),f.length>0){let s=f[f.length-1];s.timestamp&&s.timestamp>U&&(U=s.timestamp,console.log(`\u{1F4DC} Set lastMessageTimestamp to ${U}`))}return f}).catch(t=>(console.error("Failed to preload history:",t),f=[],[]))),H}function Zt(){H=null,Ne=!1,Wt(!0)}function Rt(){Ne||!f||f.length===0||(Ne=!0,f.forEach(e=>{let t=document.createElement("div");t.className=`msg ${e.role==="user"?"user":"bot"}`,e.role==="user"?t.textContent=e.text:t.innerHTML=J(e.text),a.appendChild(t)}),a.scrollTop=a.scrollHeight)}var Te=!1;function us(){if(Te){console.log("showIntroPage blocked - transition in progress");return}Te=!0,console.log("showIntroPage called"),requestAnimationFrame(()=>{$="intro",q=null,ls(),as=!1,p&&(p.placeholder="Talk to me"),document.body.classList.remove("chatfeed-mode"),gt&&(gt.style.display=""),a?.querySelectorAll(".msg").forEach(e=>e.remove()),X(),Ne=!1,Ge&&Ge.classList.remove("hidden"),a&&(a.scrollTop=0,a.style.overflow="hidden"),Te=!1})}function he(e={}){if(Te){console.log("showChatFeedPage blocked - transition in progress");return}Te=!0,console.log("showChatFeedPage called"),requestAnimationFrame(()=>{$="chatfeed",document.body.classList.add("chatfeed-mode"),gt&&(gt.style.display="none"),Ge&&Ge.classList.add("hidden"),a&&(a.style.overflow="auto"),!e.skipHistory&&f&&f.length>0&&Rt(),Te=!1})}Ge?.addEventListener("click",async()=>{if(f===null&&H&&await H,he(),!f||f.length===0){let e=document.createElement("div");e.className="msg system",e.textContent="No chat history yet",a.appendChild(e)}});_s?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("Close button clicked"),us()});var zs=document.getElementById("close-chat-btn");zs?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),document.body.classList.add("slide-out"),setTimeout(()=>{document.body.classList.remove("slide-out"),us()},250)});var ms=50,ps=0,Bt=!1;a?.addEventListener("touchstart",e=>{$==="intro"&&(ps=e.touches[0].clientY,Bt=!1)},{passive:!0});a?.addEventListener("touchmove",e=>{if($!=="intro"||Bt)return;e.touches[0].clientY-ps>=ms&&(Bt=!0,gs())},{passive:!0});a?.addEventListener("wheel",e=>{$==="intro"&&e.deltaY<-ms&&gs()},{passive:!0});async function gs(){V();try{f===null&&H?await Promise.race([H,new Promise((e,t)=>setTimeout(()=>t("timeout"),3e3))]):f===null&&await Promise.race([Wt(!0),new Promise((e,t)=>setTimeout(()=>t("timeout"),3e3))])}catch(e){console.log("History load timeout or error:",e)}if(X(),document.body.classList.add("slide-in"),he(),setTimeout(()=>document.body.classList.remove("slide-in"),400),!f||f.length===0){let e=document.createElement("div");e.className="msg system",e.textContent="No chat history yet",a.appendChild(e)}}function Gs(e=100){if(!a)return!0;let{scrollTop:t,scrollHeight:s,clientHeight:n}=a;return s-t-n<e}function Xe(){Gs()&&(a.scrollTop=a.scrollHeight)}function $t(e,t,s={}){if($==="intro")if(s.userInitiated)f&&f.length>0&&!Ne&&Rt(),he({skipHistory:!0});else return t==="bot"&&d("New message from Spark"),null;ae(e);let n=document.createElement("div");return n.className=`msg ${t}`,t==="bot"?n.innerHTML=J(e):n.textContent=e,a.appendChild(n),t==="user"?a.scrollTop=a.scrollHeight:Xe(),n}function V(){if($==="intro")return;X();let e=document.createElement("div");e.className="msg bot thinking",e.id="thinking-indicator",e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div>',a.appendChild(e),Xe()}function X(){document.getElementById("thinking-indicator")?.remove()}function fs(e){let t=document.getElementById("thinking-indicator");if(!t)return V(),fs(e);t.innerHTML=`
    <div class="thinking-content">
      <span class="thinking-status">${ot(e)}</span>
      <div class="thinking-dots"><span></span><span></span><span></span></div>
    </div>
  `,Xe()}function Ce(e){Tt&&(Tt.textContent=e,Tt.classList.toggle("show",!!e))}function d(e,t=!1){Ct.textContent=e,Ct.className=t?"show error":"show",setTimeout(()=>Ct.className="",3e3)}var M=null,E=null,Je=null,le=null,z=null,Q=[],Z=!1;var ze=null;function Ks(){let e=new(window.AudioContext||window.webkitAudioContext),t=e.sampleRate,s=.3,n=s*t,o=e.createBuffer(1,n,t),i=o.getChannelData(0);for(let c=0;c<n;c++){let v=c/t,m=880,u=Math.exp(-8*v/s);i[c]=u*.2*Math.sin(2*Math.PI*m*v)}return{ctx:e,buffer:o}}function it(){ze||(console.log("\u{1F50A} Thinking sound started"),es(),ze=setInterval(es,2e3))}function es(){let e=null;try{let t=Ks();e=t.ctx;let s=t.buffer,n=e.createBufferSource(),o=e.createGain();n.buffer=s,o.gain.setValueAtTime(.2,e.currentTime),n.connect(o),o.connect(e.destination),n.start(),n.onended=()=>{n.disconnect(),o.disconnect(),e.close().catch(()=>{})}}catch(t){console.error("Thinking sound error:",t),e&&e.state!=="closed"&&e.close().catch(()=>{})}}function F(){ze&&(clearInterval(ze),ze=null,console.log("\u{1F507} Thinking sound stopped"))}var ce=null,h=null;function at(e,t){if(!x)return null;let s=document.createElement("div");return s.className=`voice-msg ${e}`,s.textContent=t,x.appendChild(s),x.scrollTop=x.scrollHeight,s}function C(e){Qt&&(Qt.textContent=e)}async function Xs(){if(!(Z||Q.length===0)){for(Z=!0;Q.length>0;){let e=Q.shift();try{z||(z=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}));let t=Xt(e),s=z.createBuffer(1,t.length,24e3);s.getChannelData(0).set(t);let n=z.createBufferSource();n.buffer=s,n.connect(z.destination),await new Promise(o=>{n.onended=o,n.start()})}catch(t){console.error("Audio playback error:",t)}}await new Promise(e=>setTimeout(e,100)),Z=!1}}var rt=[];async function Qs(){if(!Z){for(;Q.length>0;)rt.push(Q.shift());if(rt.length>0){Z=!0;let e=null;try{let t=rt.join("");rt=[];let s=atob(t),n=new Uint8Array(s.length);for(let m=0;m<s.length;m++)n[m]=s.charCodeAt(m);let o=new Int16Array(n.buffer),i=new Float32Array(o.length);for(let m=0;m<o.length;m++)i[m]=o[m]/(o[m]<0?32768:32767);e=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});let c=e.createBuffer(1,i.length,24e3);c.getChannelData(0).set(i);let v=e.createBufferSource();v.buffer=c,v.connect(e.destination),await new Promise(m=>{v.onended=()=>{e.close().catch(()=>{}),m()},v.start()}),hybridWs&&hybridWs.readyState===WebSocket.OPEN&&(hybridWs.send(JSON.stringify({type:"audio_playback_ended"})),console.log("\u{1F50A} Notified server: playback ended"))}catch(t){console.error("TTS playback error:",t),e&&e.state!=="closed"&&e.close().catch(()=>{}),hybridWs&&hybridWs.readyState===WebSocket.OPEN&&hybridWs.send(JSON.stringify({type:"audio_playback_ended"}))}await new Promise(t=>setTimeout(t,100)),Z=!1}}}function hs(){Q=[],Z=!1,z&&(z.close().catch(()=>{}),z=null)}var ut=null,ue=null;function Zs(){function e(){if(ue){let t=new Uint8Array(ue.frequencyBinCount);ue.getByteFrequencyData(t);let s=0;for(let c=0;c<t.length;c++)s+=t[c];let o=s/t.length/255>.05,i=document.getElementById("voice-bar");i&&i.classList.toggle("speaking",o)}ut=requestAnimationFrame(e)}e()}function en(){ut&&(cancelAnimationFrame(ut),ut=null);let e=document.getElementById("voice-bar");e&&e.classList.remove("speaking")}async function tn(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return d("Microphone not supported in this browser",!0),!1;E=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});try{Je=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:24e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}})}catch(t){return t.name==="NotAllowedError"?d("Microphone permission denied. Please allow access.",!0):t.name==="NotFoundError"?d("No microphone found",!0):d("Microphone error: "+t.message,!0),console.error("Microphone access error:",t),E&&(E.close().catch(()=>{}),E=null),!1}let e=E.createMediaStreamSource(Je);return ue=E.createAnalyser(),ue.fftSize=256,e.connect(ue),Zs(),le=E.createScriptProcessor(4096,1,1),le.onaudioprocess=t=>{if(M&&M.readyState===WebSocket.OPEN){let s=t.inputBuffer.getChannelData(0),n=0;for(let c=0;c<s.length;c++)n+=s[c]*s[c];let o=Math.sqrt(n/s.length);if(Z&&o<.04)return;let i=Kt(s);M.send(JSON.stringify({type:"audio",data:i}))}},e.connect(le),le.connect(E.destination),console.log("\u{1F3A4} Audio capture started"),!0}catch(e){return console.error("Audio capture error:",e),d("Audio initialization failed: "+e.message,!0),E&&(E.close().catch(()=>{}),E=null),!1}}function sn(){en(),ue=null,le&&(le.disconnect(),le=null),Je&&(Je.getTracks().forEach(e=>e.stop()),Je=null),E&&(E.close().catch(()=>{}),E=null),console.log("\u{1F3A4} Audio capture stopped")}function vs(){let e=Gt();console.log("\u{1F517} Connecting to realtime:",e),M=new WebSocket(e),M.onopen=async()=>{Se=0,console.log("\u2705 Realtime connected"),Ce(""),await tn()||Ke()},M.onmessage=t=>{try{let s=JSON.parse(t.data);nn(s)}catch(s){console.error("Failed to parse realtime message:",s)}},M.onclose=()=>{if(console.log("\u{1F50C} Realtime disconnected"),fe&&Se<Mt){let t=Math.min(2e3*Math.pow(2,Se),3e4);Se++,Ce(`Reconnecting (${Se}/${Mt})...`),setTimeout(vs,t)}else Se>=Mt&&(d("Voice connection failed. Please try again.",!0),Ke())},M.onerror=t=>{console.error("Realtime WebSocket error:",t)}}function nn(e){switch(e.type){case"ready":let t=e.mode==="hybrid"?"Hybrid (Claude)":"Direct";console.log(`\u{1F399}\uFE0F Realtime session ready - Mode: ${t}`),C("Listening");break;case"user_speaking":ts(!0),C("Hearing you..."),hs(),F(),ce=null,h=null;break;case"user_stopped":ts(!1),C("Processing..."),it();break;case"interim":case"transcript":if(F(),e.text&&x){if(ce)ce.textContent=e.text;else{let i=document.createElement("div");i.className="voice-msg user",i.textContent=e.text,h&&h.parentNode===x?x.insertBefore(i,h):x.appendChild(i),ce=i}x.scrollTop=x.scrollHeight}it();break;case"processing":let s=e.engine||"Spark Opus",n=e.message||`Checking with ${s}...`;console.log(`\u{1F9E0} ${n}`),C(n),it(),h?(h.textContent=n,h.classList.add("thinking")):(h=at("assistant",n),h.classList.add("thinking"));break;case"text_delta":F(),C("Speaking..."),e.delta&&(h?(h.textContent+=e.delta,h.classList.remove("thinking")):h=at("assistant",e.delta),x&&(x.scrollTop=x.scrollHeight));break;case"text":F(),e.content&&(h?(h.textContent=e.content,h.classList.remove("thinking")):h=at("assistant",e.content));break;case"tts_start":console.log("\u{1F50A} Generating speech..."),C("Speaking..."),F();break;case"audio_chunk":F(),C("Speaking..."),e.data&&(Q.push(e.data),Qs());break;case"audio_delta":F(),C("Speaking..."),e.data&&(Q.push(e.data),Xs());break;case"audio_done":console.log("\u{1F50A} Audio complete");break;case"tool_call":console.log("\u{1F527} Tool call:",e.name);let o=e.name?.replace("get_","").replace("ask_","").replace("_"," ")||"info";C(`Checking ${o}...`),h||(h=at("assistant",`Checking ${o}...`),h.classList.add("thinking")),it();break;case"done":F(),ce=null,h=null,C("Listening");break;case"error":F(),console.error("Realtime error:",e.message),d(e.message||"Voice error",!0),C("Error");break;case"disconnected":F(),fe&&d("Disconnected",!0);break}}function ys(){ge="voice",fe=!0,document.body.classList.add("voice-mode"),te?.classList.add("voice-active"),ce=null,h=null,C("Connecting..."),Ce("Connecting..."),vs()}function Ke(){fe=!1,document.body.classList.remove("voice-mode"),te?.classList.remove("voice-active"),is?.classList.remove("speaking"),ce=null,h=null,sn(),hs(),M&&(M.send(JSON.stringify({type:"stop"})),M.close(),M=null),ge="chat"}function ts(e){is?.classList.toggle("speaking",e)}He?.addEventListener("click",ys);Fs?.addEventListener("click",Ke);p?.addEventListener("input",()=>{let e=p.value.trim().length>0||de;pe?.classList.toggle("show",e),He?.classList.toggle("hidden",e),p&&(p.style.height="auto",p.style.height=Math.min(p.scrollHeight,120)+"px")});p?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Ot())});p?.addEventListener("focus",()=>{fe&&Ke(),ge="chat",te?.classList.add("focused")});p?.addEventListener("blur",()=>{setTimeout(()=>{document.activeElement!==p&&te?.classList.remove("focused")},100)});pe?.addEventListener("click",Ot);async function Ot(){let e=p?.value.trim();!e||Y||(p.value="",p.style.height="auto",pe?.classList.remove("show"),He?.classList.remove("hidden"),await ve(e,"chat"))}async function on(){try{return ht=await navigator.mediaDevices.getUserMedia({audio:!0}),B=new MediaRecorder(ht),B.ondataavailable=e=>{e.data.size>0&&bt.push(e.data)},B.onstop=dn,!0}catch{return d("Mic access denied",!0),!1}}function bs(){ht?.getTracks().forEach(e=>e.stop()),ht=null,B=null}function ws(){if(!B){on().then(e=>e&&ws());return}bt=[],B.start(),Ht=Date.now(),ge="notes",document.body.classList.add("notes-mode"),te?.classList.add("notes-active"),Pt=setInterval(ss,1e3),ss()}function an(){B?.state==="recording"&&(B.stop(),clearInterval(Pt),te?.classList.remove("notes-active"))}function qt(){document.body.classList.remove("notes-mode"),document.body.classList.remove("notes-results"),te?.classList.remove("notes-active"),ks(),ge="chat"}async function rn(){if(!O.transcription&&!O.summary){d("No note to save",!0);return}try{let e=await fetch("/api/notes/save-file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcription:O.transcription,summary:O.summary,timestamp:Date.now()})}),t=await e.json();e.ok?(d("Note saved \u2713"),qt()):d("Failed to save",!0)}catch{d("Save failed",!0)}}function cn(){O={transcription:"",summary:""},Ie&&(Ie.textContent=""),$e&&($e.textContent=""),d("Note deleted"),qt()}function ln(){B?.state==="recording"&&(B.onstop=()=>{d("Recording discarded"),bs()},B.stop(),clearInterval(Pt),bt=[],document.body.classList.remove("notes-mode"),te?.classList.remove("notes-active"),ge="chat")}function ss(){let e=Math.floor((Date.now()-Ht)/1e3);ft&&(ft.textContent=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`)}async function dn(){let e=new Blob(bt,{type:"audio/webm"}),t=Math.floor((Date.now()-Ht)/1e3);bs(),document.body.classList.add("notes-results"),R&&(R.textContent="Transcribing...",R.style.display="block"),Me&&(Me.style.display="none"),Be&&(Be.style.display="none"),O={transcription:"",summary:""};let s=new FileReader;s.onload=()=>un(s.result.split(",")[1],t),s.readAsDataURL(e)}function un(e,t){if(!l||l.readyState!==WebSocket.OPEN){d("Not connected",!0);return}Y=!0,l.send(JSON.stringify({type:"voice_note",audio:e,duration:t}))}function ks(){document.body.classList.remove("notes-results"),ft&&(ft.textContent="0:00"),R&&(R.style.display="block"),Me&&(Me.style.display="none"),Be&&(Be.style.display="none"),Ie&&(Ie.textContent=""),$e&&($e.textContent=""),O={transcription:"",summary:""}}Hs?.addEventListener("click",()=>{fe&&Ke(),ks(),ws()});Ws?.addEventListener("click",()=>{B?.state==="recording"&&an()});Rs?.addEventListener("click",ln);Os?.addEventListener("click",rn);qs?.addEventListener("click",cn);Us?.addEventListener("click",qt);var Nt=localStorage.getItem("spark_session_id"),U=0,It=!1;async function ns(){if($==="chatfeed")try{console.log("\u{1F504} Catching up on missed messages since:",U);let e=await fetch(`/api/messages/recent?since=${U}`);if(!e.ok)return;let s=(await e.json()).messages||[];if(s.length===0){console.log("\u{1F504} No missed messages");return}console.log(`\u{1F504} Found ${s.length} missed message(s)`);for(let n of s){if(Lt(n.text))continue;ae(n.text);let o=document.createElement("div");o.className=`msg ${n.role==="user"?"user":"bot"}`,n.role==="user"?o.textContent=n.text:o.innerHTML=J(n.text),a.appendChild(o),n.timestamp>U&&(U=n.timestamp)}Xe()}catch(e){console.error("Catch-up failed:",e)}}function At(){let e=nt.wsUrl;Nt&&(e+=(e.includes("?")?"&":"?")+`session=${Nt}`),console.log("\u{1F50C} Connecting to:",e),_e("connecting");try{l=new WebSocket(e),l.onopen=()=>{console.log("\u2705 Chat WebSocket connected"),_e("connected"),It&&ns(),It=!1},l.onclose=t=>{console.log("\u{1F50C} Chat WebSocket closed:",t.code,t.reason),_e("disconnected"),It=!0,setTimeout(At,2e3)},l.onerror=t=>{console.error("\u274C Chat WebSocket error:",t),_e("disconnected")},document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(console.log("\u{1F441}\uFE0F Page visible, checking WebSocket..."),!l||l.readyState!==WebSocket.OPEN?(console.log("\u{1F504} WebSocket stale, reconnecting..."),At()):ns())}),l.onmessage=t=>{try{let s=JSON.parse(t.data);console.log("\u{1F4E8} WS received:",s.type,s.content?.slice?.(0,50)||""),mn(s)}catch(s){console.error("\u274C WS message error:",s,t.data?.slice?.(0,100))}}}catch(t){console.error("\u274C Failed to create WebSocket:",t),_e("disconnected")}}async function ve(e,t){if(!l||l.readyState!==WebSocket.OPEN){d("Not connected",!0);return}if($==="intro"){if(H)try{await H,console.log("\u{1F4DC} History ready, preloaded:",f?.length||0,"messages")}catch{console.log("History load failed, continuing anyway")}!q&&f&&f.length>0&&!Ne&&(console.log("\u{1F4DC} Rendering history before first message"),Rt()),he({skipHistory:!0})}Y=!0;let s=document.createElement("div");s.className="msg user",s.textContent=e,a.appendChild(s),a.scrollTop=a.scrollHeight,ae(e),V(),q?(console.log(`\u{1F4E6} Sending to ${q} mode session`),l.send(JSON.stringify({type:"mode_message",sparkMode:q,text:e}))):l.send(JSON.stringify({type:"transcript",text:e,mode:t}))}function mn(e){switch(e.type){case"ready":e.sessionId&&(Nt=e.sessionId,localStorage.setItem("spark_session_id",e.sessionId),console.log("\u{1F4CB} Session:",e.sessionId)),e.pending&&(console.log("\u23F3 Pending request detected - showing loading"),V()),console.log("\u2705 Chat ready");break;case"sync":if(console.log("\u{1F4E1} Sync message:",e.message?.source,e.message?.text?.slice(0,50)),Zt(),e.message&&e.message.text){if(e.message.timestamp&&e.message.timestamp>U&&(U=e.message.timestamp),Lt(e.message.text)){console.log("\u{1F4E1} Skipping duplicate sync message (hash match)");break}if($==="chatfeed"){ae(e.message.text);let t=document.createElement("div");t.className=`msg ${e.message.role==="user"?"user":"bot"}`,e.message.role==="user"?t.textContent=e.message.text:t.innerHTML=J(e.message.text),e.message.source==="whatsapp"&&(t.title="From WhatsApp"),a.appendChild(t),Xe(),e.message.role==="bot"&&X()}else $==="intro"&&e.message.role==="bot"&&d("New message from Spark")}break;case"thinking":console.log("\u{1F914} Server thinking..."),k&&xe.classList.contains("show")?Fe():V();break;case"progress":console.log("\u{1F4CA} Progress:",e.status),k&&xe.classList.contains("show")?Cs(e.status):fs(e.status);break;case"text":if(console.log("\u2705 Text message received:",e.content?.slice?.(0,100)),document.body.classList.contains("notes-mode")&&$e)e.content&&(R&&(R.style.display="none"),$e.innerHTML=J(e.content),O.summary=e.content,Be&&(Be.style.display="block"));else if(k&&xe.classList.contains("show"))yt(),e.content&&ee("bot",e.content);else{X(),Ce("");let t=a?.querySelector(".msg.system:last-child");t?.textContent==="Transcribing..."&&t.remove(),e.content?($t(e.content,"bot"),console.log("\u2705 Bot message added to DOM")):console.warn("\u26A0\uFE0F Empty text content received")}break;case"transcription":if(document.body.classList.contains("notes-mode")&&Ie)Ie.textContent=e.text,O.transcription=e.text,Me&&(Me.style.display="block"),R&&(R.textContent="Summarizing...");else{let t=a?.querySelector(".msg.system:last-child");t?.textContent==="Transcribing..."&&t.remove(),$t("\u{1F4DD} "+e.text,"bot")}break;case"audio":pn(e.data);break;case"done":Y=!1,_=!1,Ce(""),Ae(),Es(),Zt(),ge==="voice"&&!fe&&ys();break;case"error":k&&xe.classList.contains("show")?(yt(),ee("bot",`Error: ${e.message||"Something went wrong"}`),_=!1):X(),d(e.message||"Error",!0),Y=!1,Ce("");break;case"mode_history":console.log(`\u{1F4E6} Mode history received for ${e.mode}:`,e.messages?.length||0,"messages"),e.mode&&e.messages&&(vt[e.mode]=e.messages,q===e.mode&&ds(e.mode));break}}async function pn(e){Ye||(Ye=new(window.AudioContext||window.webkitAudioContext));try{let t=Uint8Array.from(atob(e),n=>n.charCodeAt(0)),s=await Ye.decodeAudioData(t.buffer.slice(0));if(Ee)try{Ee.stop()}catch{}Ee=Ye.createBufferSource(),Ee.buffer=s,Ee.connect(Ye.destination),Ee.start(0)}catch(t){console.error("Audio error:",t)}}var mt=document.getElementById("msg-menu"),gn=document.getElementById("menu-copy"),fn=document.getElementById("menu-edit"),hn=document.getElementById("menu-delete"),P=null,Pe=null;function Ss(e,t,s){P=e,e.classList.add("selected");let n=148,o=60,i=Math.min(t,window.innerWidth-n-10),c=Math.max(s-o-10,10);mt.style.left=i+"px",mt.style.top=c+"px",mt.classList.add("show")}function wt(){mt?.classList.remove("show"),P?.classList.remove("selected"),P=null}a?.addEventListener("touchstart",e=>{let t=e.target.closest(".msg");if(!t||t.classList.contains("system")||t.classList.contains("thinking"))return;let s=e.touches[0];Pe=setTimeout(()=>{e.preventDefault(),Ss(t,s.clientX,s.clientY)},500)},{passive:!1});a?.addEventListener("touchend",()=>{clearTimeout(Pe)});a?.addEventListener("touchmove",()=>{clearTimeout(Pe)});document.addEventListener("touchstart",e=>{!e.target.closest("#msg-menu")&&!e.target.closest(".msg")&&wt()});gn?.addEventListener("click",()=>{if(!P)return;let e=P.textContent||P.innerText;navigator.clipboard.writeText(e).then(()=>{d("Copied!")}).catch(()=>{d("Failed to copy",!0)}),wt()});fn?.addEventListener("click",()=>{if(!P)return;let e=P.textContent||P.innerText;p&&(p.value=e,p.style.height="auto",p.style.height=Math.min(p.scrollHeight,120)+"px",pe?.classList.add("show"),p.focus()),wt()});hn?.addEventListener("click",()=>{P&&(P.remove(),d("Deleted"),wt())});At();Wt();var os=0;document.addEventListener("touchend",e=>{let t=Date.now();t-os<=300&&e.preventDefault(),os=t},{passive:!1});var G=document.getElementById("pc-status");async function me(){try{let t=await(await fetch("/api/nodes/status")).json();G&&(G.classList.toggle("connected",t.connected),G.title=t.connected?`${t.nodeName||"PC"} connected`:"PC disconnected")}catch(e){console.error("PC status check failed:",e),G&&G.classList.remove("connected")}}me();var K=setInterval(me,3e4);document.addEventListener("visibilitychange",()=>{document.hidden?K&&(clearInterval(K),K=null):K||(me(),K=setInterval(me,3e4))});var Le=null;G?.addEventListener("click",async()=>{if(Le&&(clearInterval(Le),Le=null),G.classList.contains("connected")){d("PC is already connected");return}d("Waking PC...");try{let t=await(await fetch("/api/nodes/wake",{method:"POST"})).json();if(t.success){d("Wake signal sent! Waiting for PC..."),clearInterval(K);let s=0;Le=setInterval(async()=>{s++,await me(),G.classList.contains("connected")?(d("PC connected! \u2705"),clearInterval(Le),K=setInterval(me,3e4)):s>=24&&(d("PC did not respond",!0),clearInterval(Le),K=setInterval(me,3e4))},5e3)}else d("Wake failed: "+(t.error||"Unknown error"),!0)}catch(e){d("Wake request failed",!0),console.error("WoL error:",e)}});if(window.visualViewport){let e=window.visualViewport.height;window.visualViewport.addEventListener("resize",()=>{let t=e-window.visualViewport.height;document.body.classList.toggle("keyboard-open",t>150)})}document.querySelectorAll(".shortcut").forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.msg;t&&ve(t,"chat")})});document.getElementById("articulations-btn")?.addEventListener("click",async()=>{await cs("articulate"),p&&(p.placeholder="Type text to refine..."),p?.focus()});var D={"spark-dev-mode":null,"spark-research-mode":null,"spark-plan-mode":null,"spark-videogen-mode":null},vn={"devteam-btn":"spark-dev-mode","researcher-btn":"spark-research-mode","plan-btn":"spark-plan-mode","videogen-btn":"spark-videogen-mode"},yn={dev:"spark-dev-mode",research:"spark-research-mode",plan:"spark-plan-mode",videogen:"spark-videogen-mode"};async function Ae(){try{let s=(await(await fetch("/api/mode-sessions")).json()).sessions||{};D["spark-dev-mode"]=null,D["spark-research-mode"]=null,D["spark-plan-mode"]=null,D["spark-videogen-mode"]=null;let n={dev:"spark-dev-mode",research:"spark-research-mode",plan:"spark-plan-mode",videogen:"spark-videogen-mode"};for(let[o,i]of Object.entries(s)){let c=n[o];c&&i.exists&&(D[c]={key:i.sessionId,label:i.label,active:i.active,exists:i.exists,lastUpdated:i.lastUpdated})}bn(),Es()}catch(e){console.error("Failed to check active sessions:",e)}}function bn(){for(let[e,t]of Object.entries(vn)){let s=document.getElementById(e);if(s){let n=D[t]!==null;s.classList.toggle("session-active",n);let o=s.querySelector(".shortcut-sub");if(o)if(n){let i=o.dataset.originalText||o.textContent;o.dataset.originalText=i,o.textContent="\u25CF Session active"}else o.dataset.originalText&&(o.textContent=o.dataset.originalText)}}}function Ut(e){let t=yn[e]||e;return D[t]}var xe=document.getElementById("session-page"),y=document.getElementById("session-messages"),I=document.getElementById("session-input"),_t=document.getElementById("session-send-btn"),wn=document.getElementById("session-back-btn"),k=null,L=null,_=!1,Qe={dev:{name:"Dev Mode",icon:"\u{1F468}\u200D\u{1F4BB}",sessionKey:"spark-dev-mode",placeholder:"Describe what you want to build or fix...",emptyTitle:"Dev Mode",emptyDesc:"Start a coding session. Describe what you want to build or fix."},research:{name:"Research Mode",icon:"\u{1F52C}",sessionKey:"spark-research-mode",placeholder:"What would you like to research?",emptyTitle:"Research Mode",emptyDesc:"Start a deep research session. Ask about any topic."},plan:{name:"Plan Mode",icon:"\u{1F4CB}",sessionKey:"spark-plan-mode",placeholder:"What do you want to plan?",emptyTitle:"Plan Mode",emptyDesc:"Start planning. Describe your project or feature."},videogen:{name:"Video Gen",icon:"\u{1F3AC}",sessionKey:"spark-videogen-mode",placeholder:"Describe the video you want to create...",emptyTitle:"Video Gen",emptyDesc:"Generate AI videos. Describe what you want to create."}};function Es(){let e={};for(let[t,s]of Object.entries(Qe)){let n=s.sessionKey;D[n]&&(e[t]={label:n,lastActive:Date.now(),hasHistory:!0})}localStorage.setItem("sparkgpt-active-sessions",JSON.stringify(e))}function kn(){try{let e=JSON.parse(localStorage.getItem("sparkgpt-active-sessions")||"{}"),t=Date.now()-1440*60*1e3;for(let[s,n]of Object.entries(e))n.lastActive<t&&delete e[s];return localStorage.setItem("sparkgpt-active-sessions",JSON.stringify(e)),e}catch{return{}}}var pt=null;function Sn(){Ls(),pt=setInterval(async()=>{k&&Ae()},15e3)}function Ls(){pt&&(clearInterval(pt),pt=null)}async function De(e,t){let s=Qe[e];if(!s){console.error("Unknown session mode:",e);return}if(k=e,I.placeholder=s.placeholder,y.innerHTML="",t)L=t;else try{let o=await(await fetch(`/api/modes/${e}/sessions`)).json();o.sessions&&o.sessions.length>0?L=o.sessions[0].id:L=(await(await fetch(`/api/modes/${e}/sessions`,{method:"POST",headers:{"Content-Type":"application/json"}})).json()).id}catch(n){console.error("Failed to resolve session ID:",n),L=null}En(e),xe.classList.add("show"),await xs(e,s),Sn(),setTimeout(()=>I.focus(),100)}function En(e){let t=document.getElementById("session-header-title");if(t){let s=Qe[e];t.textContent=s?`${s.icon} ${s.name}`:e}}function Ln(){xe.classList.remove("show"),k=null,L=null,_=!1,Ls(),document.getElementById("session-history-panel")?.classList.remove("show")}async function xs(e,t){try{let s;L?s=`/api/modes/${e}/sessions/${L}/history?limit=50`:s=`/api/modes/${e}/history?limit=50`;let i=(await(await fetch(s)).json()).messages||[];if(i.length===0)y.innerHTML=`
        <div class="session-empty-state">
          <div class="session-empty-icon">${t.icon}</div>
          <div class="session-empty-title">${t.emptyTitle}</div>
          <div class="session-empty-desc">${t.emptyDesc}</div>
        </div>
      `;else{for(let c of i){let v=xt(c);v&&ee(c.role==="assistant"?"bot":"user",v,c.timestamp)}y.scrollTop=y.scrollHeight}}catch(s){console.error("Failed to load session history:",s),y.innerHTML=`
      <div class="session-empty-state">
        <div class="session-empty-icon">${t.icon}</div>
        <div class="session-empty-title">${t.emptyTitle}</div>
        <div class="session-empty-desc">${t.emptyDesc}</div>
      </div>
    `}}function ee(e,t,s){let n=y.querySelector(".session-empty-state");n&&n.remove();let o=document.createElement("div");if(o.className=`msg ${e}`,e==="bot"?o.innerHTML=J(t):o.textContent=t,s){let i=document.createElement("span");i.className="msg-time",i.textContent=Ts(s),o.appendChild(i)}return y.appendChild(o),y.scrollTop=y.scrollHeight,o}function Ts(e){if(!e)return"";let t=Date.now(),s=typeof e=="number"?e:new Date(e).getTime();if(isNaN(s))return"";let n=Math.floor((t-s)/1e3);if(n<60)return"just now";let o=Math.floor(n/60);if(o<60)return`${o}m ago`;let i=Math.floor(o/60);if(i<24)return`${i}h ago`;let c=Math.floor(i/24);return c===1?"yesterday":c<7?`${c}d ago`:new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function Fe(){yt();let e=document.createElement("div");e.className="msg bot thinking",e.id="session-thinking-indicator",e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div>',y.appendChild(e),y.scrollTop=y.scrollHeight}function yt(){document.getElementById("session-thinking-indicator")?.remove()}function Cs(e){let t=document.getElementById("session-thinking-indicator");if(!t)return Fe(),Cs(e);t.innerHTML=`
    <div class="thinking-content">
      <span class="thinking-status">${ot(e)}</span>
      <div class="thinking-dots"><span></span><span></span><span></span></div>
    </div>
  `,y&&(y.scrollTop=y.scrollHeight)}async function Ms(){let e=I.value.trim();!e||_||(I.value="",I.style.height="auto",_t.classList.remove("active"),_=!0,ee("user",e),Fe(),l&&l.readyState===WebSocket.OPEN?l.send(JSON.stringify({type:"mode_message",sparkMode:k,sessionId:L,text:e})):(yt(),ee("bot","Not connected. Please try again."),_=!1))}I?.addEventListener("input",()=>{let e=I.value.trim().length>0;_t?.classList.toggle("active",e),I.style.height="auto",I.style.height=Math.min(I.scrollHeight,120)+"px"});I?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Ms())});_t?.addEventListener("click",Ms);wn?.addEventListener("click",Ln);document.getElementById("session-new-btn")?.addEventListener("click",async()=>{if(!k||y.querySelectorAll(".msg").length>0&&!confirm("Start a new session? Current session will be saved."))return;try{let n=await(await fetch(`/api/modes/${k}/sessions`,{method:"POST",headers:{"Content-Type":"application/json"}})).json();L=n.id,console.log("Created new session:",n.id)}catch(s){console.error("Failed to create new session:",s)}y.innerHTML="";let t=Qe[k];t&&(y.innerHTML=`
      <div class="session-empty-state">
        <div class="session-empty-icon">${t.icon}</div>
        <div class="session-empty-title">${t.emptyTitle}</div>
        <div class="session-empty-desc">${t.emptyDesc}</div>
      </div>
    `),I?.focus()});var Dt=document.getElementById("session-history-panel"),Ve=document.getElementById("session-history-list");document.getElementById("session-history-btn")?.addEventListener("click",async()=>{if(k){Dt?.classList.add("show"),Ve.innerHTML='<div class="session-history-empty">Loading...</div>';try{let s=(await(await fetch(`/api/modes/${k}/sessions`)).json()).sessions||[];if(s.length===0){Ve.innerHTML='<div class="session-history-empty">No sessions yet</div>';return}Ve.innerHTML="";for(let n of s){let o=document.createElement("div");o.className="session-history-entry",n.id===L&&o.classList.add("active");let i=n.title||"Untitled",c=Ts(n.createdAt),v=n.messageCount?`${n.messageCount} msgs`:"";o.innerHTML=`
        <div class="session-history-entry-title">${ot(i)}</div>
        <div class="session-history-entry-meta">
          <span>${c}</span>
          ${v?`<span>\xB7 ${v}</span>`:""}
        </div>
      `,o.addEventListener("click",()=>{Dt?.classList.remove("show"),L=n.id,y.innerHTML="";let m=Qe[k];m&&xs(k,m)}),Ve.appendChild(o)}}catch(e){console.error("Failed to load sessions:",e),Ve.innerHTML='<div class="session-history-empty">Failed to load sessions</div>'}}});document.getElementById("session-history-close")?.addEventListener("click",()=>{Dt?.classList.remove("show")});y?.addEventListener("touchstart",e=>{let t=e.target.closest(".msg");if(!t||t.classList.contains("system")||t.classList.contains("thinking"))return;let s=e.touches[0];Pe=setTimeout(()=>{e.preventDefault(),Ss(t,s.clientX,s.clientY)},500)},{passive:!1});y?.addEventListener("touchend",()=>{clearTimeout(Pe)});y?.addEventListener("touchmove",()=>{clearTimeout(Pe)});kn();Ae();var je=setInterval(Ae,1e4);document.addEventListener("visibilitychange",()=>{document.hidden?je&&(clearInterval(je),je=null):je||(Ae(),je=setInterval(Ae,1e4))});function Yt({icon:e,title:t,subtitle:s,placeholder:n,submitText:o,onSubmit:i,activeSession:c,onViewSession:v}){let m=document.createElement("div");m.className="bottom-sheet-overlay";let u=document.createElement("div");u.className="bottom-sheet";let We=c?`
    <button class="bottom-sheet-active-session">
      <span class="active-dot">\u25CF</span>
      View Active Session
    </button>
  `:"";u.innerHTML=`
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-icon">${e}</span>
      <div class="bottom-sheet-titles">
        <h2 class="bottom-sheet-title">${t}</h2>
        <p class="bottom-sheet-subtitle">${s}</p>
      </div>
    </div>
    ${We}
    <textarea class="bottom-sheet-input" placeholder="${n}" rows="1"></textarea>
    <button class="bottom-sheet-submit">${o}</button>
  `,document.body.appendChild(m),document.body.appendChild(u);let T=u.querySelector(".bottom-sheet-input"),N=u.querySelector(".bottom-sheet-submit"),Re=u.querySelector(".bottom-sheet-handle"),se=u.querySelector(".bottom-sheet-active-session");function W(){u.classList.add("closing"),u.classList.remove("visible"),m.classList.remove("visible"),setTimeout(()=>{m.remove(),u.remove()},200)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{m.classList.add("visible"),u.classList.add("visible"),T.focus()})}),m.addEventListener("click",W);let ne=0,oe=0,ie=!1;function ye(b){let w=b.target;(w===Re||w===u&&u.scrollTop===0)&&(ne=b.touches[0].clientY,oe=ne,ie=!0,u.style.transition="none")}function kt(b){if(!ie)return;oe=b.touches[0].clientY;let w=oe-ne;w>0&&(window.innerWidth>=520?u.style.transform=`translateX(-50%) translateY(${w}px)`:u.style.transform=`translateY(${w}px)`)}function A(){if(!ie)return;ie=!1,u.style.transition="",oe-ne>100?W():window.innerWidth>=520?u.style.transform="translateX(-50%) translateY(0)":u.style.transform="translateY(0)"}u.addEventListener("touchstart",ye,{passive:!0}),u.addEventListener("touchmove",kt,{passive:!0}),u.addEventListener("touchend",A);function be(b){b.key==="Escape"&&(W(),document.removeEventListener("keydown",be))}document.addEventListener("keydown",be);function we(){let b=T.value.trim();if(!b){T.classList.add("error"),setTimeout(()=>T.classList.remove("error"),300);return}W(),i(b)}return N.addEventListener("click",we),se&&v&&se.addEventListener("click",()=>{W(),v(c)}),T.addEventListener("keydown",b=>{b.key==="Enter"&&(b.metaKey||b.ctrlKey)&&(b.preventDefault(),we())}),T.addEventListener("input",()=>{T.style.height="auto",T.style.height=Math.min(T.scrollHeight,120)+"px"}),{close:W}}document.getElementById("devteam-btn")?.addEventListener("click",()=>{let e=Ut("dev"),t=JSON.parse(localStorage.getItem("sparkgpt-active-sessions")||"{}");e||D["spark-dev-mode"]||t.dev?De("dev"):Yt({icon:"\u{1F468}\u200D\u{1F4BB}",title:"Dev Mode",subtitle:"Senior engineer \u2014 reads code, writes tests, commits",placeholder:"Describe the task or issue to fix...",submitText:"Start Dev Session",onSubmit:async s=>{await De("dev"),l&&l.readyState===WebSocket.OPEN&&(ee("user",s),Fe(),_=!0,l.send(JSON.stringify({type:"mode_message",sparkMode:"dev",sessionId:L,text:s})))}})});document.getElementById("researcher-btn")?.addEventListener("click",()=>{let e=Ut("research"),t=JSON.parse(localStorage.getItem("sparkgpt-active-sessions")||"{}");e||D["spark-research-mode"]||t.research?De("research"):Yt({icon:"\u{1F52C}",title:"Research Mode",subtitle:"Deep research with sources and analysis",placeholder:"What topic do you want to research?",submitText:"Start Research",onSubmit:async s=>{await De("research"),l&&l.readyState===WebSocket.OPEN&&(ee("user",s),Fe(),_=!0,l.send(JSON.stringify({type:"mode_message",sparkMode:"research",sessionId:L,text:s})))}})});document.getElementById("plan-btn")?.addEventListener("click",()=>{let e=Ut("plan"),t=JSON.parse(localStorage.getItem("sparkgpt-active-sessions")||"{}");e||D["spark-plan-mode"]||t.plan?De("plan"):Yt({icon:"\u{1F4CB}",title:"Plan Mode",subtitle:"Technical specs with phases and risks",placeholder:"What do you want to plan?",submitText:"Start Planning",onSubmit:async s=>{await De("plan"),l&&l.readyState===WebSocket.OPEN&&(ee("user",s),Fe(),_=!0,l.send(JSON.stringify({type:"mode_message",sparkMode:"plan",sessionId:L,text:s})))}})});document.getElementById("videogen-btn")?.addEventListener("click",()=>{xn()});function xn(){let e=document.createElement("div");e.className="bottom-sheet-overlay";let t=document.createElement("div");t.className="bottom-sheet",t.innerHTML=`
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-icon">\u{1F3AC}</span>
      <div class="bottom-sheet-titles">
        <h2 class="bottom-sheet-title">Video Gen</h2>
        <p class="bottom-sheet-subtitle" id="videogen-subtitle">AI video generation</p>
      </div>
    </div>
    
    <div class="bottom-sheet-row">
      <label class="bottom-sheet-label">Workflow</label>
      <div class="option-selector" id="videogen-workflow">
        <button class="option-pill selected" data-value="text2video">Text \u2192 Video</button>
        <button class="option-pill" data-value="image2video">Image \u2192 Video</button>
        <button class="option-pill" data-value="faceswap">Face Swap</button>
      </div>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-prompt-row">
      <label class="bottom-sheet-label">Prompt</label>
      <textarea class="bottom-sheet-input" id="videogen-prompt" placeholder="Describe the video you want to create..." rows="2"></textarea>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-image-row" style="display:none;">
      <label class="bottom-sheet-label" id="videogen-image-label">Reference Image</label>
      <div class="image-upload-area" id="videogen-upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <div class="upload-text">Tap to upload image</div>
        <div class="upload-hint" id="videogen-image-hint">For image-to-video generation</div>
      </div>
      <input type="file" id="videogen-file-input" accept="image/*" style="display:none">
    </div>
    
    <div class="bottom-sheet-row" id="videogen-video-row" style="display:none;">
      <label class="bottom-sheet-label">Target Video</label>
      <div class="image-upload-area" id="videogen-video-upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
        </div>
        <div class="upload-text">Tap to upload video or paste URL</div>
        <div class="upload-hint">YouTube/video URL or upload file</div>
      </div>
      <input type="file" id="videogen-video-file-input" accept="video/*" style="display:none">
      <input type="text" class="bottom-sheet-input" id="videogen-video-url" placeholder="Or paste YouTube/video URL..." style="margin-top:8px; display:none;">
    </div>
    
    <div class="bottom-sheet-row" id="videogen-aspect-row">
      <label class="bottom-sheet-label">Aspect Ratio</label>
      <div class="option-selector" id="videogen-aspect">
        <button class="option-pill selected" data-value="16:9">16:9</button>
        <button class="option-pill" data-value="9:16">9:16</button>
        <button class="option-pill" data-value="1:1">1:1</button>
      </div>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-duration-row">
      <label class="bottom-sheet-label">Duration</label>
      <div class="option-selector" id="videogen-duration">
        <button class="option-pill selected" data-value="5">5 seconds</button>
        <button class="option-pill" data-value="10">10 seconds</button>
      </div>
    </div>
    
    <button class="bottom-sheet-submit" id="videogen-submit">Generate Video</button>
  `,document.body.appendChild(e),document.body.appendChild(t);let s=t.querySelector("#videogen-subtitle"),n=t.querySelector("#videogen-workflow"),o=t.querySelector("#videogen-prompt-row"),i=t.querySelector("#videogen-prompt"),c=t.querySelector("#videogen-image-row"),v=t.querySelector("#videogen-image-label"),m=t.querySelector("#videogen-image-hint"),u=t.querySelector("#videogen-upload-area"),We=t.querySelector("#videogen-file-input"),T=t.querySelector("#videogen-video-row"),N=t.querySelector("#videogen-video-upload-area"),Re=t.querySelector("#videogen-video-file-input"),se=t.querySelector("#videogen-video-url"),W=t.querySelector("#videogen-aspect-row"),ne=t.querySelector("#videogen-aspect"),oe=t.querySelector("#videogen-duration-row"),ie=t.querySelector("#videogen-duration"),ye=t.querySelector("#videogen-submit"),kt=t.querySelector(".bottom-sheet-handle"),A="text2video",be="16:9",we="5",b=null,w=null,Oe=null,qe=null,j=null;function Ze(){t.classList.add("closing"),t.classList.remove("visible"),e.classList.remove("visible"),setTimeout(()=>{e.remove(),t.remove()},200)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.classList.add("visible"),t.classList.add("visible"),i.focus()})}),e.addEventListener("click",Ze);let et=0,tt=0,st=!1;function Is(g){let r=g.target;(r===kt||r===t&&t.scrollTop===0)&&(et=g.touches[0].clientY,tt=et,st=!0,t.style.transition="none")}function Bs(g){if(!st)return;tt=g.touches[0].clientY;let r=tt-et;r>0&&(window.innerWidth>=520?t.style.transform=`translateX(-50%) translateY(${r}px)`:t.style.transform=`translateY(${r}px)`)}function $s(){if(!st)return;st=!1,t.style.transition="",tt-et>100?Ze():window.innerWidth>=520?t.style.transform="translateX(-50%) translateY(0)":t.style.transform="translateY(0)"}t.addEventListener("touchstart",Is,{passive:!0}),t.addEventListener("touchmove",Bs,{passive:!0}),t.addEventListener("touchend",$s);function jt(g){g.key==="Escape"&&(Ze(),document.removeEventListener("keydown",jt))}document.addEventListener("keydown",jt);function Ns(){switch(o.style.display="block",c.style.display="none",T.style.display="none",W.style.display="block",oe.style.display="block",se.style.display="none",A){case"text2video":s.textContent="Generate video from text prompt",i.placeholder="Describe the video you want to create...",ye.textContent="Generate Video";break;case"image2video":s.textContent="Animate an image into video",i.placeholder="Describe the motion/action (optional)...",c.style.display="block",v.textContent="Source Image",m.textContent="Image to animate",ye.textContent="Generate Video";break;case"faceswap":s.textContent="Swap face in a video",o.style.display="none",c.style.display="block",T.style.display="block",W.style.display="none",oe.style.display="none",v.textContent="Face Image",m.textContent="Photo with the face to use",se.style.display="block",ye.textContent="Swap Face";break}}n.addEventListener("click",g=>{let r=g.target.closest(".option-pill");r&&(n.querySelectorAll(".option-pill").forEach(S=>S.classList.remove("selected")),r.classList.add("selected"),A=r.dataset.value,Ns())}),ne.addEventListener("click",g=>{let r=g.target.closest(".option-pill");r&&(ne.querySelectorAll(".option-pill").forEach(S=>S.classList.remove("selected")),r.classList.add("selected"),be=r.dataset.value)}),ie.addEventListener("click",g=>{let r=g.target.closest(".option-pill");r&&(ie.querySelectorAll(".option-pill").forEach(S=>S.classList.remove("selected")),r.classList.add("selected"),we=r.dataset.value)});function As(){b=null,w=null,u.classList.remove("has-image"),u.innerHTML=`
      <div class="upload-icon">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="upload-text">Tap to upload image</div>
      <div class="upload-hint" id="videogen-image-hint">${A==="faceswap"?"Photo with the face to use":"Image to animate"}</div>
    `,We.value=""}function Jt(){Oe=null,qe=null,j=null,N.classList.remove("has-image"),N.innerHTML=`
      <div class="upload-icon">
        <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
      </div>
      <div class="upload-text">Tap to upload video or paste URL</div>
      <div class="upload-hint">YouTube/video URL or upload file</div>
    `,Re.value="",se.value=""}u.addEventListener("click",()=>{b||We.click()}),We.addEventListener("change",async g=>{let r=g.target.files?.[0];if(!r)return;b=r;let S=new FileReader;S.onload=St=>{w=St.target.result,u.classList.add("has-image"),u.innerHTML=`
        <div class="image-preview-container">
          <img class="image-preview-thumb" src="${w}" alt="Preview">
          <div class="image-preview-info">
            <div class="image-preview-name">${r.name}</div>
            <div class="image-preview-size">${ke(r.size)}</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-image">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-image")?.addEventListener("click",Et=>{Et.stopPropagation(),As()})},S.readAsDataURL(r)}),N.addEventListener("click",()=>{!Oe&&!j&&Re.click()}),Re.addEventListener("change",async g=>{let r=g.target.files?.[0];if(!r)return;Oe=r,j=null;let S=new FileReader;S.onload=St=>{qe=St.target.result,N.classList.add("has-image"),N.innerHTML=`
        <div class="image-preview-container">
          <div class="upload-icon" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--msg-bot);border-radius:8px;">
            <svg viewBox="0 0 24 24" style="width:30px;height:30px;stroke:var(--text-secondary);fill:none;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </div>
          <div class="image-preview-info">
            <div class="image-preview-name">${r.name}</div>
            <div class="image-preview-size">${ke(r.size)}</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-video">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-video")?.addEventListener("click",Et=>{Et.stopPropagation(),Jt()})},S.readAsDataURL(r)}),se.addEventListener("input",g=>{let r=g.target.value.trim();r&&(r.includes("youtube.com")||r.includes("youtu.be")||r.includes("http"))&&(j=r,Oe=null,qe=null,N.classList.add("has-image"),N.innerHTML=`
        <div class="image-preview-container">
          <div class="upload-icon" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--msg-bot);border-radius:8px;">
            <svg viewBox="0 0 24 24" style="width:30px;height:30px;stroke:var(--text-secondary);fill:none;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </div>
          <div class="image-preview-info">
            <div class="image-preview-name" style="word-break:break-all;">${r.length>40?r.substring(0,40)+"...":r}</div>
            <div class="image-preview-size">Video URL</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-video">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-video")?.addEventListener("click",S=>{S.stopPropagation(),Jt()}))}),ye.addEventListener("click",()=>{let g=i.value.trim();if(A==="text2video"){if(!g){i.classList.add("error"),setTimeout(()=>i.classList.remove("error"),300);return}}else if(A==="image2video"){if(!w){u.style.borderColor="var(--red)",setTimeout(()=>u.style.borderColor="",300);return}}else if(A==="faceswap"){if(!w){u.style.borderColor="var(--red)",setTimeout(()=>u.style.borderColor="",300);return}if(!qe&&!j){N.style.borderColor="var(--red)",setTimeout(()=>N.style.borderColor="",300);return}}if(Ze(),he(),A==="text2video"){let r=`/video --ratio ${be} --duration ${we}s ${g}`;ve(r,"chat")}else if(A==="image2video"){let r=`/video --ratio ${be} --duration ${we}s`;g&&(r+=` ${g}`),Tn(r,w)}else if(A==="faceswap"){let r="/faceswap";j&&(r+=` --video-url ${j}`),Cn(r,w,qe,j)}}),i.addEventListener("input",()=>{i.style.height="auto",i.style.height=Math.min(i.scrollHeight,120)+"px"})}function Tn(e,t){if(!l||l.readyState!==WebSocket.OPEN){d("Not connected",!0);return}Y=!0;let s=document.createElement("div");s.className="msg user",s.textContent=e+" \u{1F4F7}",a.appendChild(s),a.scrollTop=a.scrollHeight,ae(e),V(),l.send(JSON.stringify({type:"transcript",text:e,image:t,mode:"chat"}))}function Cn(e,t,s,n){if(!l||l.readyState!==WebSocket.OPEN){d("Not connected",!0);return}Y=!0;let o=document.createElement("div");o.className="msg user",o.textContent=e+" \u{1F3AD}\u{1F4F7}\u{1F3AC}",a.appendChild(o),a.scrollTop=a.scrollHeight,ae(e),V(),l.send(JSON.stringify({type:"transcript",text:e,image:t,video:s,videoUrl:n,mode:"chat"}))}var Mn=ve;ve=async function(e,t){as?await In(e):await Mn(e,t)};async function In(e){if(!e.trim())return;$==="intro"&&he({skipHistory:!0});let t=document.createElement("div");t.className="msg user",t.textContent=e,a.appendChild(t),a.scrollTop=a.scrollHeight,V();try{let n=await(await fetch("/api/articulate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})})).json();if(X(),n.result){let o=document.createElement("div");o.className="msg bot",o.textContent=n.result,a.appendChild(o),a.scrollTop=a.scrollHeight}}catch{X(),d("Failed to refine text",!0)}}document.getElementById("todays-reports-btn")?.addEventListener("click",async()=>{await cs("dailyreports");let e=document.createElement("div");e.className="msg system",e.textContent="Loading today's reports...",a.appendChild(e);try{let s=await(await fetch("/api/reports/today")).json();if(e.remove(),!s.reports?.length){ve("Show me today's reports or generate a new briefing if none exist.","chat");return}let n=document.createElement("div");n.className="msg system",n.textContent=`\u{1F4CA} Today's Reports (${s.reports.length})`,a.appendChild(n),s.reports.forEach(o=>{let i=document.createElement("div");i.className="msg bot",i.innerHTML=J(o.summary),a.appendChild(i)}),a.scrollTop=a.scrollHeight}catch(t){e.textContent="Failed to load reports",console.error("Failed to load reports:",t)}});var Vt=document.getElementById("attachment-preview"),ct=document.getElementById("attachment-icon"),Bn=document.getElementById("attachment-name"),$n=document.getElementById("attachment-size"),Nn=document.getElementById("remove-attachment-btn"),de=null;Ps?.addEventListener("click",()=>lt?.click());lt?.addEventListener("change",e=>{let t=e.target.files?.[0];if(t){if(t.size>nt.maxFileSize){d(`File too large (${ke(t.size)}). Maximum size is ${ke(nt.maxFileSize)}.`,!0),lt.value="";return}de=t,Bn.textContent=t.name,$n.textContent=ke(t.size),t.type.startsWith("image/")?(ct.classList.add("image"),ct.innerHTML='<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>'):(ct.classList.remove("image"),ct.innerHTML='<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>'),Vt?.classList.add("show"),pe?.classList.add("show"),He?.classList.add("hidden"),p?.focus(),lt.value=""}});Nn?.addEventListener("click",()=>{de=null,Vt?.classList.remove("show"),p?.value.trim()||(pe?.classList.remove("show"),He?.classList.remove("hidden"))});Ot=async function(){let e=p?.value.trim()||"";if(!e&&!de||Y)return;let t=e,s=null;if(de){let n=de;try{if(n.type.startsWith("image/"))s=await new Promise((o,i)=>{let c=new FileReader;c.onload=()=>o(c.result),c.onerror=i,c.readAsDataURL(n)}),t=e||"What is this image?";else{let o=await new Promise((c,v)=>{let m=new FileReader;m.onload=()=>c(m.result),m.onerror=v,m.readAsText(n)}),i=o.slice(0,2e3)+(o.length>2e3?"...":"");t=e?`${e}

[File: ${n.name}]
${i}`:`[File: ${n.name}]
${i}`}}catch{d("Failed to read file",!0);return}de=null,Vt?.classList.remove("show")}t&&(p.value="",p.style.height="auto",pe?.classList.remove("show"),He?.classList.remove("hidden"),s?An(t,s):ve(t,"chat"))};function An(e,t){if(!l||l.readyState!==WebSocket.OPEN){d("Not connected",!0);return}Y=!0;let s=$t(e+" \u{1F4F7}","user",{userInitiated:!0});V(),l.send(JSON.stringify({type:"transcript",text:e,image:t,mode:"chat"}))}
