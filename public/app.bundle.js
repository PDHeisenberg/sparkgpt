var Ie={wsUrl:(()=>{let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,s=location.pathname.replace(/\/+$/,"");return s&&s!=="/"?`${t}${s}`:t})(),silenceMs:1500,maxFileSize:10485760};var Xe=new Set,Qs=50;function is(e){let t=(e||"").trim().slice(0,200),s=0;for(let n=0;n<t.length;n++)s=(s<<5)-s+t.charCodeAt(n),s=s&s;return s.toString(36)}function de(e){let t=is(e);if(Xe.add(t),Xe.size>Qs){let s=Xe.values();for(let n=0;n<10;n++)Xe.delete(s.next().value)}}function Ft(e){return Xe.has(is(e))}function ft(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function ue(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^(.*)$/,"<p>$1</p>").replace(/<p><\/p>/g,"")}function V(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function Rt(e){return e?.content?typeof e.content=="string"?e.content:Array.isArray(e.content)&&e.content.find(s=>s.type==="text")?.text||null:null}function as(){let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,s=location.pathname.replace(/\/+$/,"");return s&&s!=="/"?`${t}${s}/realtime`:`${t}/realtime`}function cs(e){let t=new Int16Array(e.length);for(let o=0;o<e.length;o++){let i=Math.max(-1,Math.min(1,e[o]));t[o]=i<0?i*32768:i*32767}let s=new Uint8Array(t.buffer),n="";for(let o=0;o<s.length;o++)n+=String.fromCharCode(s[o]);return btoa(n)}function rs(e){let t=atob(e),s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);let n=new Int16Array(s.buffer),o=new Float32Array(n.length);for(let i=0;i<n.length;i++)o[i]=n[i]/(n[i]<0?32768:32767);return o}var S=null,k=null,Qe=null,me=null,Ze=[],ht=!1,et=()=>{},vt=()=>{},Zs=()=>{};function ds({onStatus:e,onMessage:t,onStop:s}){e&&(et=e),t&&(vt=t),s&&(Zs=s)}function en(){let t=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}`,s=location.pathname.replace(/\/+$/,"");return s&&s!=="/"?`${t}${s}/elevenlabs-realtime`:`${t}/elevenlabs-realtime`}async function us(){console.log("\u{1F399}\uFE0F Starting ElevenLabs voice mode");try{return await nn()?(tn(),!0):!1}catch(e){return console.error("Failed to start ElevenLabs voice:",e),!1}}function tn(){let e=en();console.log("\u{1F517} Connecting to ElevenLabs WebSocket:",e),S=new WebSocket(e),S.onopen=()=>{console.log("\u2705 ElevenLabs WebSocket connected"),et("Starting...")},S.onmessage=t=>{try{let s=JSON.parse(t.data);sn(s)}catch(s){console.error("Failed to parse ElevenLabs message:",s)}},S.onclose=t=>{console.log("\u{1F50C} ElevenLabs WebSocket closed:",t.code)},S.onerror=t=>{console.error("\u274C ElevenLabs WebSocket error:",t)}}function sn(e){switch(e.type){case"ready":et("Listening");break;case"transcript":e.text&&vt("user",e.text,e.final);break;case"text":case"agent_response":let t=e.content||e.text;t&&(vt("assistant",t,!0),et("Speaking..."));break;case"audio_delta":case"audio":let s=e.data||e.audio_base_64;s&&(Ze.push(s),an());break;case"interruption":console.log("\u26A1 User interruption detected"),ms();break;case"tool_call":et("Checking..."),vt("assistant","Checking...",!1);break;case"conversation_ended":case"session_ended":console.log("\u{1F3C1} ElevenLabs conversation ended");break;case"error":console.error("\u274C ElevenLabs error:",e.message);break}}async function nn(){try{Qe=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}}),k=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3});let e=k.createMediaStreamSource(Qe);try{await k.audioWorklet.addModule("/audio-processor.js"),me=new AudioWorkletNode(k,"audio-processor"),me.port.onmessage=t=>{let{audioData:s}=t.data;if(S&&S.readyState===WebSocket.OPEN){let n=ls(s);S.send(JSON.stringify({type:"audio",data:n}))}},e.connect(me),me.connect(k.destination)}catch{console.warn("AudioWorklet not available, falling back to ScriptProcessor");let s=k.createScriptProcessor(4096,1,1);s.onaudioprocess=n=>{let o=n.inputBuffer.getChannelData(0);if(S&&S.readyState===WebSocket.OPEN){let i=ls(o);S.send(JSON.stringify({type:"audio",data:i}))}},e.connect(s),s.connect(k.destination)}return!0}catch(e){return console.error("ElevenLabs audio capture error:",e),!1}}function ls(e){let t=new Int16Array(e.length);for(let o=0;o<e.length;o++){let i=Math.max(-1,Math.min(1,e[o]));t[o]=i<0?i*32768:i*32767}let s=new Uint8Array(t.buffer),n="";for(let o=0;o<s.length;o++)n+=String.fromCharCode(s[o]);return btoa(n)}function on(e){let t=atob(e),s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);let n=new Int16Array(s.buffer),o=new Float32Array(n.length);for(let i=0;i<n.length;i++)o[i]=n[i]/(n[i]<0?32768:32767);return o}async function an(){if(!(ht||Ze.length===0)){for(ht=!0;Ze.length>0;){let e=Ze.shift();try{(!k||k.state==="closed")&&(k=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3}));let t=on(e),s=k.createBuffer(1,t.length,16e3);s.getChannelData(0).set(t);let n=k.createBufferSource();n.buffer=s,n.connect(k.destination),await new Promise(o=>{n.onended=o,n.start()})}catch(t){console.error("ElevenLabs audio playback error:",t)}}ht=!1}}function ms(){Ze=[],ht=!1}function ps(){if(console.log("\u{1F50C} Stopping ElevenLabs voice mode"),Qe&&(Qe.getTracks().forEach(e=>e.stop()),Qe=null),me&&(me.disconnect(),me=null),k&&k.state!=="closed"&&(k.close().catch(()=>{}),k=null),ms(),S){try{S.send(JSON.stringify({type:"end"}))}catch{}S.close(),S=null}}var Es=localStorage.getItem("voiceMode")||"elevenlabs",r=document.getElementById("messages"),Tt=document.getElementById("welcome"),f=document.getElementById("text-input"),Ee=document.getElementById("send-btn"),Ue=document.getElementById("voice-btn"),cn=document.getElementById("notes-btn"),Ot=document.getElementById("status"),vo=document.getElementById("timer"),qt=document.getElementById("toast"),rn=document.getElementById("upload-btn"),kt=document.getElementById("file-input"),ie=document.getElementById("bottom"),pe=document.getElementById("spark-status"),ge=document.getElementById("session-status-indicator");function tt(e){pe&&(pe.classList.remove("connected","connecting"),e==="connected"?(pe.classList.add("connected"),pe.title="Clawdbot Gateway: Connected"):e==="connecting"?(pe.classList.add("connecting"),pe.title="Clawdbot Gateway: Connecting..."):pe.title="Clawdbot Gateway: Disconnected"),ge&&(ge.classList.remove("connected","connecting"),e==="connected"?(ge.classList.add("connected"),ge.title="Connected"):e==="connecting"?(ge.classList.add("connecting"),ge.title="Connecting..."):ge.title="Disconnected")}var Ss=document.getElementById("voice-bar"),ln=document.getElementById("close-voice-btn"),yo=document.getElementById("waveform"),I=document.getElementById("voice-content"),gs=document.getElementById("voice-status"),bo=document.getElementById("notes-content"),Mt=document.getElementById("notes-timer"),wo=document.getElementById("notes-bar"),dn=document.getElementById("close-notes-btn"),un=document.getElementById("delete-notes-btn"),ko=document.getElementById("notes-recording"),Lo=document.getElementById("notes-results"),Y=document.getElementById("notes-status"),Pe=document.getElementById("notes-transcription-msg"),He=document.getElementById("notes-transcription"),We=document.getElementById("notes-summary-msg"),Fe=document.getElementById("notes-summary"),mn=document.getElementById("notes-save-btn"),pn=document.getElementById("notes-delete-btn"),gn=document.getElementById("notes-back-btn"),j={transcription:"",summary:""},fn=document.getElementById("close-btn"),rt=document.getElementById("history-btn"),hn=document.getElementById("theme-btn");function vn(){let e=localStorage.getItem("theme");e&&document.documentElement.setAttribute("data-theme",e)}vn();hn?.addEventListener("click",()=>{let e=document.documentElement.getAttribute("data-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,s;e==="dark"?s="light":e==="light"?s="dark":s=t?"light":"dark",document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s)});var m=null,Se="chat",$="intro",xs=!1,xe=!1,Be=0,Ut=5,q=!1,st=null,Ae=null,N=null,Nt=[],Jt=null,Gt=null,It=null,Z=null,Cs={},Lt={},Ts={dev:{name:"Dev Mode",icon:"\u{1F468}\u200D\u{1F4BB}",notifyWhatsApp:!0},research:{name:"Research Mode",icon:"\u{1F52C}",notifyWhatsApp:!0},plan:{name:"Plan Mode",icon:"\u{1F4CB}",notifyWhatsApp:!0},articulate:{name:"Articulate Mode",icon:"\u270D\uFE0F",notifyWhatsApp:!1},dailyreports:{name:"Daily Reports",icon:"\u{1F4CA}",notifyWhatsApp:!0},videogen:{name:"Video Gen",icon:"\u{1F3AC}",notifyWhatsApp:!0}};async function yn(){try{Lt=(await(await fetch("/api/modes")).json()).modes||{},console.log("\u{1F4E6} Loaded mode configs:",Object.keys(Lt))}catch(e){console.error("Failed to load mode configs:",e),Lt=Ts}}function Ms(e){return Lt[e]||Ts[e]||{name:e,icon:"\u{1F4E6}"}}function bn(){let e=document.getElementById("mode-indicator");if(Z){let t=Ms(Z);e||(e=document.createElement("div"),e.id="mode-indicator",e.className="mode-indicator",document.querySelector(".top-bar")?.appendChild(e)),e.innerHTML=`
      <span class="mode-icon">${t.icon}</span>
      <span class="mode-name">${t.name}</span>
      <button class="mode-exit-btn" onclick="exitMode()">\u2715</button>
    `,e.style.display="flex"}else e&&(e.style.display="none")}function wn(e){let t=Cs[e]||[];if(r.querySelectorAll(".msg, .mode-empty-state").forEach(s=>s.remove()),t.length===0){let s=Ms(e),n=document.createElement("div");n.className="mode-empty-state",n.innerHTML=`
      <div class="mode-empty-icon">${s.icon}</div>
      <div class="mode-empty-title">${s.name}</div>
      <div class="mode-empty-desc">Start a conversation in this mode.</div>
    `,r.appendChild(n)}else for(let s of t){let n=Rt(s);n&&addMessage(s.role==="assistant"?"bot":"user",n)}scrollToBottom()}yn();var v=null,W=null,Re=!1;function Kt(e=!1){return W&&!e||(W=fetch("/api/messages/all").then(t=>t.json()).then(t=>{if(v=t.messages||[],console.log(`\u{1F4DC} Pre-loaded ${v.length} messages`),v.length>0){let s=v[v.length-1];s.timestamp&&s.timestamp>z&&(z=s.timestamp,console.log(`\u{1F4DC} Set lastMessageTimestamp to ${z}`))}return v}).catch(t=>(console.error("Failed to preload history:",t),v=[],[]))),W}function fs(){W=null,Re=!1,Kt(!0)}function Xt(){Re||!v||v.length===0||(Re=!0,v.forEach(e=>{let t=document.createElement("div");if(t.className=`msg ${e.role==="user"?"user":"bot"}`,e.role==="user"?t.textContent=e.text:t.innerHTML=ue(e.text),e.timestamp){let s=document.createElement("span");s.className="msg-time",s.textContent=Dt(e.timestamp),t.appendChild(s)}r.appendChild(t)}),r.scrollTop=r.scrollHeight)}var De=!1;function Is(){if(De){console.log("showIntroPage blocked - transition in progress");return}De=!0,console.log("showIntroPage called"),requestAnimationFrame(()=>{$="intro",Z=null,bn(),xs=!1,f&&(f.placeholder="Talk to me"),document.body.classList.remove("chatfeed-mode"),Tt&&(Tt.style.display=""),r?.querySelectorAll(".msg").forEach(e=>e.remove()),ee(),Re=!1,rt&&rt.classList.remove("hidden"),r&&(r.scrollTop=0,r.style.overflow="hidden"),De=!1})}function _e(e={}){if(De){console.log("showChatFeedPage blocked - transition in progress");return}De=!0,console.log("showChatFeedPage called"),requestAnimationFrame(()=>{$="chatfeed",document.body.classList.add("chatfeed-mode"),Tt&&(Tt.style.display="none"),rt&&rt.classList.add("hidden"),r&&(r.style.overflow="auto"),!e.skipHistory&&v&&v.length>0&&Xt(),De=!1})}rt?.addEventListener("click",async()=>{if(v===null&&W&&await W,_e(),!v||v.length===0){let e=document.createElement("div");e.className="msg system",e.textContent="No chat history yet",r.appendChild(e)}});fn?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("Close button clicked"),Is()});var kn=document.getElementById("close-chat-btn");kn?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),document.body.classList.add("slide-out"),setTimeout(()=>{document.body.classList.remove("slide-out"),Is()},250)});var Bs=50,As=0,Vt=!1;r?.addEventListener("touchstart",e=>{$==="intro"&&(As=e.touches[0].clientY,Vt=!1)},{passive:!0});r?.addEventListener("touchmove",e=>{if($!=="intro"||Vt)return;e.touches[0].clientY-As>=Bs&&(Vt=!0,Ns())},{passive:!0});r?.addEventListener("wheel",e=>{$==="intro"&&e.deltaY<-Bs&&Ns()},{passive:!0});async function Ns(){U();try{v===null&&W?await Promise.race([W,new Promise((e,t)=>setTimeout(()=>t("timeout"),3e3))]):v===null&&await Promise.race([Kt(!0),new Promise((e,t)=>setTimeout(()=>t("timeout"),3e3))])}catch(e){console.log("History load timeout or error:",e)}if(ee(),document.body.classList.add("slide-in"),_e(),setTimeout(()=>document.body.classList.remove("slide-in"),400),!v||v.length===0){let e=document.createElement("div");e.className="msg system",e.textContent="No chat history yet",r.appendChild(e)}}function $s(e=100){if(!r)return!0;let{scrollTop:t,scrollHeight:s,clientHeight:n}=r;return s-t-n<e}function lt(){$s()&&(r.scrollTop=r.scrollHeight)}function Bt(e,t,s={}){if($==="intro")if(s.userInitiated)v&&v.length>0&&!Re&&Xt(),_e({skipHistory:!0});else return t==="bot"&&u("New message received"),null;de(e);let n=document.createElement("div");n.className=`msg ${t}`,t==="bot"?n.innerHTML=ue(e):n.textContent=e;let o=s.timestamp;if(o){let i=document.createElement("span");i.className="msg-time",i.textContent=Dt(o),n.appendChild(i)}return r.appendChild(n),t==="user"?r.scrollTop=r.scrollHeight:lt(),n}function U(){if($==="intro")return;ee();let e=document.createElement("div");e.className="msg bot thinking",e.id="thinking-indicator",e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div>',r.appendChild(e),lt()}function ee(){document.getElementById("thinking-indicator")?.remove()}function Ds(e){let t=document.getElementById("thinking-indicator");if(!t)return U(),Ds(e);t.innerHTML=`
    <div class="thinking-content">
      <span class="thinking-status">${ft(e)}</span>
      <div class="thinking-dots"><span></span><span></span><span></span></div>
    </div>
  `,lt()}function we(e){Ot&&(Ot.textContent=e,Ot.classList.toggle("show",!!e))}function u(e,t=!1){qt.textContent=e,qt.className=t?"show error":"show",setTimeout(()=>qt.className="",3e3)}var A=null,C=null,at=null,he=null,K=null,te=[],se=!1;var ct=null;function Ln(){let e=new(window.AudioContext||window.webkitAudioContext),t=e.sampleRate,s=.3,n=s*t,o=e.createBuffer(1,n,t),i=o.getChannelData(0);for(let a=0;a<n;a++){let p=a/t,l=880,d=Math.exp(-8*p/s);i[a]=d*.2*Math.sin(2*Math.PI*l*p)}return{ctx:e,buffer:o}}function yt(){ct||(console.log("\u{1F50A} Thinking sound started"),hs(),ct=setInterval(hs,2e3))}function hs(){let e=null;try{let t=Ln();e=t.ctx;let s=t.buffer,n=e.createBufferSource(),o=e.createGain();n.buffer=s,o.gain.setValueAtTime(.2,e.currentTime),n.connect(o),o.connect(e.destination),n.start(),n.onended=()=>{n.disconnect(),o.disconnect(),e.close().catch(()=>{})}}catch(t){console.error("Thinking sound error:",t),e&&e.state!=="closed"&&e.close().catch(()=>{})}}function O(){ct&&(clearInterval(ct),ct=null,console.log("\u{1F507} Thinking sound stopped"))}var H=null,g=null;function $e(e,t){if(!I)return null;let s=document.createElement("div");return s.className=`voice-msg ${e}`,s.textContent=t,I.appendChild(s),I.scrollTop=I.scrollHeight,s}function M(e){gs&&(gs.textContent=e)}async function En(){if(!(se||te.length===0)){for(se=!0;te.length>0;){let e=te.shift();try{K||(K=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}));let t=rs(e),s=K.createBuffer(1,t.length,24e3);s.getChannelData(0).set(t);let n=K.createBufferSource();n.buffer=s,n.connect(K.destination),await new Promise(o=>{n.onended=o,n.start()})}catch(t){console.error("Audio playback error:",t)}}await new Promise(e=>setTimeout(e,100)),se=!1}}var bt=[];async function Sn(){if(!se){for(;te.length>0;)bt.push(te.shift());if(bt.length>0){se=!0;let e=null;try{let t=bt.join("");bt=[];let s=atob(t),n=new Uint8Array(s.length);for(let l=0;l<s.length;l++)n[l]=s.charCodeAt(l);let o=new Int16Array(n.buffer),i=new Float32Array(o.length);for(let l=0;l<o.length;l++)i[l]=o[l]/(o[l]<0?32768:32767);e=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});let a=e.createBuffer(1,i.length,24e3);a.getChannelData(0).set(i);let p=e.createBufferSource();p.buffer=a,p.connect(e.destination),await new Promise(l=>{p.onended=()=>{e.close().catch(()=>{}),l()},p.start()}),hybridWs&&hybridWs.readyState===WebSocket.OPEN&&(hybridWs.send(JSON.stringify({type:"audio_playback_ended"})),console.log("\u{1F50A} Notified server: playback ended"))}catch(t){console.error("TTS playback error:",t),e&&e.state!=="closed"&&e.close().catch(()=>{}),hybridWs&&hybridWs.readyState===WebSocket.OPEN&&hybridWs.send(JSON.stringify({type:"audio_playback_ended"}))}await new Promise(t=>setTimeout(t,100)),se=!1}}}function Ps(){te=[],se=!1,K&&(K.close().catch(()=>{}),K=null)}var Et=null,ke=null;function xn(){function e(){if(ke){let t=new Uint8Array(ke.frequencyBinCount);ke.getByteFrequencyData(t);let s=0;for(let a=0;a<t.length;a++)s+=t[a];let o=s/t.length/255>.05,i=document.getElementById("voice-bar");i&&i.classList.toggle("speaking",o)}Et=requestAnimationFrame(e)}e()}function Cn(){Et&&(cancelAnimationFrame(Et),Et=null);let e=document.getElementById("voice-bar");e&&e.classList.remove("speaking")}async function Tn(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return u("Microphone not supported in this browser",!0),!1;C=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});try{at=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:24e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}})}catch(t){return t.name==="NotAllowedError"?u("Microphone permission denied. Please allow access.",!0):t.name==="NotFoundError"?u("No microphone found",!0):u("Microphone error: "+t.message,!0),console.error("Microphone access error:",t),C&&(C.close().catch(()=>{}),C=null),!1}let e=C.createMediaStreamSource(at);return ke=C.createAnalyser(),ke.fftSize=256,e.connect(ke),xn(),he=C.createScriptProcessor(4096,1,1),he.onaudioprocess=t=>{if(A&&A.readyState===WebSocket.OPEN){let s=t.inputBuffer.getChannelData(0),n=0;for(let a=0;a<s.length;a++)n+=s[a]*s[a];let o=Math.sqrt(n/s.length);if(se&&o<.04)return;let i=cs(s);A.send(JSON.stringify({type:"audio",data:i}))}},e.connect(he),he.connect(C.destination),console.log("\u{1F3A4} Audio capture started"),!0}catch(e){return console.error("Audio capture error:",e),u("Audio initialization failed: "+e.message,!0),C&&(C.close().catch(()=>{}),C=null),!1}}function Mn(){Cn(),ke=null,he&&(he.disconnect(),he=null),at&&(at.getTracks().forEach(e=>e.stop()),at=null),C&&(C.close().catch(()=>{}),C=null),console.log("\u{1F3A4} Audio capture stopped")}function Hs(){let e=as();console.log("\u{1F517} Connecting to realtime:",e),A=new WebSocket(e),A.onopen=async()=>{Be=0,console.log("\u2705 Realtime connected"),we(""),await Tn()||Oe()},A.onmessage=t=>{try{let s=JSON.parse(t.data);In(s)}catch(s){console.error("Failed to parse realtime message:",s)}},A.onclose=()=>{if(console.log("\u{1F50C} Realtime disconnected"),xe&&Be<Ut){let t=Math.min(2e3*Math.pow(2,Be),3e4);Be++,we(`Reconnecting (${Be}/${Ut})...`),setTimeout(Hs,t)}else Be>=Ut&&(u("Voice connection failed. Please try again.",!0),Oe())},A.onerror=t=>{console.error("Realtime WebSocket error:",t)}}function In(e){switch(e.type){case"ready":let t=e.mode==="hybrid"?"Hybrid (Claude)":"Direct";console.log(`\u{1F399}\uFE0F Realtime session ready - Mode: ${t}`),M("Listening");break;case"user_speaking":vs(!0),M("Hearing you..."),Ps(),O(),H=null,g=null;break;case"user_stopped":vs(!1),M("Processing..."),yt();break;case"interim":case"transcript":if(O(),e.text&&I){if(H)H.textContent=e.text;else{let i=document.createElement("div");i.className="voice-msg user",i.textContent=e.text,g&&g.parentNode===I?I.insertBefore(i,g):I.appendChild(i),H=i}I.scrollTop=I.scrollHeight}yt();break;case"processing":let s=e.engine||"Claude Opus",n=e.message||`Checking with ${s}...`;console.log(`\u{1F9E0} ${n}`),M(n),yt(),g?(g.textContent=n,g.classList.add("thinking")):(g=$e("assistant",n),g.classList.add("thinking"));break;case"text_delta":O(),M("Speaking..."),e.delta&&(g?(g.textContent+=e.delta,g.classList.remove("thinking")):g=$e("assistant",e.delta),I&&(I.scrollTop=I.scrollHeight));break;case"text":O(),e.content&&(g?(g.textContent=e.content,g.classList.remove("thinking")):g=$e("assistant",e.content));break;case"tts_start":console.log("\u{1F50A} Generating speech..."),M("Speaking..."),O();break;case"audio_chunk":O(),M("Speaking..."),e.data&&(te.push(e.data),Sn());break;case"audio_delta":O(),M("Speaking..."),e.data&&(te.push(e.data),En());break;case"audio_done":console.log("\u{1F50A} Audio complete");break;case"tool_call":console.log("\u{1F527} Tool call:",e.name);let o=e.name?.replace("get_","").replace("ask_","").replace("_"," ")||"info";M(`Checking ${o}...`),g||(g=$e("assistant",`Checking ${o}...`),g.classList.add("thinking")),yt();break;case"done":O(),H=null,g=null,M("Listening");break;case"error":O(),console.error("Realtime error:",e.message),u(e.message||"Voice error",!0),M("Error");break;case"disconnected":O(),xe&&u("Disconnected",!0);break}}function Ws(){Se="voice",xe=!0,document.body.classList.add("voice-mode"),ie?.classList.add("voice-active"),H=null,g=null,M("Connecting..."),we("Connecting..."),Es==="elevenlabs"?(ds({onStatus:e=>{M(e),we(e)},onMessage:(e,t,s)=>{e==="user"?(H?H.textContent=t:H=$e("user",t),s&&(H=null)):(g?g.textContent=t:g=$e("assistant",t),s&&(g=null))},onStop:()=>Oe()}),us()):Hs()}function Oe(){xe=!1,document.body.classList.remove("voice-mode"),ie?.classList.remove("voice-active"),Ss?.classList.remove("speaking"),H=null,g=null,Es==="elevenlabs"?ps():(Mn(),Ps(),A&&(A.send(JSON.stringify({type:"stop"})),A.close(),A=null)),Se="chat"}function vs(e){Ss?.classList.toggle("speaking",e)}Ue?.addEventListener("click",Ws);ln?.addEventListener("click",Oe);f?.addEventListener("input",()=>{let e=f.value.trim().length>0||be;Ee?.classList.toggle("show",e),Ue?.classList.toggle("hidden",e),f&&(f.style.height="auto",f.style.height=Math.min(f.scrollHeight,120)+"px")});f?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Qt())});f?.addEventListener("focus",()=>{xe&&Oe(),Se="chat",ie?.classList.add("focused")});f?.addEventListener("blur",()=>{setTimeout(()=>{document.activeElement!==f&&ie?.classList.remove("focused")},100)});Ee?.addEventListener("click",()=>Qt());async function Qt(){let e=f?.value.trim();!e||q||(f.value="",f.style.height="auto",Ee?.classList.remove("show"),Ue?.classList.remove("hidden"),await Ve(e,"chat"))}async function Bn(){try{return It=await navigator.mediaDevices.getUserMedia({audio:!0}),N=new MediaRecorder(It),N.ondataavailable=e=>{e.data.size>0&&Nt.push(e.data)},N.onstop=Pn,!0}catch{return u("Mic access denied",!0),!1}}function Fs(){It?.getTracks().forEach(e=>e.stop()),It=null,N=null}function Rs(){if(!N){Bn().then(e=>e&&Rs());return}Nt=[],N.start(),Jt=Date.now(),Se="notes",document.body.classList.add("notes-mode"),ie?.classList.add("notes-active"),Gt=setInterval(ys,1e3),ys()}function An(){N?.state==="recording"&&(N.stop(),clearInterval(Gt),ie?.classList.remove("notes-active"))}function Zt(){document.body.classList.remove("notes-mode"),document.body.classList.remove("notes-results"),ie?.classList.remove("notes-active"),Os(),Se="chat"}async function Nn(){if(!j.transcription&&!j.summary){u("No note to save",!0);return}try{let e=await fetch("/api/notes/save-file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcription:j.transcription,summary:j.summary,timestamp:Date.now()})}),t=await e.json();e.ok?(u("Note saved \u2713"),Zt()):u("Failed to save",!0)}catch{u("Save failed",!0)}}function $n(){j={transcription:"",summary:""},He&&(He.textContent=""),Fe&&(Fe.textContent=""),u("Note deleted"),Zt()}function Dn(){N?.state==="recording"&&(N.onstop=()=>{u("Recording discarded"),Fs()},N.stop(),clearInterval(Gt),Nt=[],document.body.classList.remove("notes-mode"),ie?.classList.remove("notes-active"),Se="chat")}function ys(){let e=Math.floor((Date.now()-Jt)/1e3);Mt&&(Mt.textContent=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`)}async function Pn(){let e=new Blob(Nt,{type:"audio/webm"}),t=Math.floor((Date.now()-Jt)/1e3);Fs(),document.body.classList.add("notes-results"),Y&&(Y.textContent="Transcribing...",Y.style.display="block"),Pe&&(Pe.style.display="none"),We&&(We.style.display="none"),j={transcription:"",summary:""};let s=new FileReader;s.onload=()=>Hn(s.result.split(",")[1],t),s.readAsDataURL(e)}function Hn(e,t){if(!m||m.readyState!==WebSocket.OPEN){u("Not connected",!0);return}q=!0,m.send(JSON.stringify({type:"voice_note",audio:e,duration:t}))}function Os(){document.body.classList.remove("notes-results"),Mt&&(Mt.textContent="0:00"),Y&&(Y.style.display="block"),Pe&&(Pe.style.display="none"),We&&(We.style.display="none"),He&&(He.textContent=""),Fe&&(Fe.textContent=""),j={transcription:"",summary:""}}cn?.addEventListener("click",()=>{xe&&Oe(),Os(),Rs()});dn?.addEventListener("click",()=>{N?.state==="recording"&&An()});un?.addEventListener("click",Dn);mn?.addEventListener("click",Nn);pn?.addEventListener("click",$n);gn?.addEventListener("click",Zt);var Yt=localStorage.getItem("spark_session_id"),z=0,_t=!1;async function bs(){if($==="chatfeed")try{console.log("\u{1F504} Catching up on missed messages since:",z);let e=await fetch(`/api/messages/recent?since=${z}`);if(!e.ok)return;let s=(await e.json()).messages||[];if(s.length===0){console.log("\u{1F504} No missed messages");return}console.log(`\u{1F504} Found ${s.length} missed message(s)`);for(let n of s){if(Ft(n.text))continue;de(n.text);let o=document.createElement("div");o.className=`msg ${n.role==="user"?"user":"bot"}`,n.role==="user"?o.textContent=n.text:o.innerHTML=ue(n.text),r.appendChild(o),n.timestamp>z&&(z=n.timestamp)}lt()}catch(e){console.error("Catch-up failed:",e)}}function jt(){let e=Ie.wsUrl;Yt&&(e+=(e.includes("?")?"&":"?")+`session=${Yt}`),console.log("\u{1F50C} Connecting to:",e),tt("connecting");try{m=new WebSocket(e),m.onopen=()=>{console.log("\u2705 Chat WebSocket connected"),tt("connected"),_t&&bs(),_t=!1},m.onclose=t=>{console.log("\u{1F50C} Chat WebSocket closed:",t.code,t.reason),tt("disconnected"),_t=!0,setTimeout(jt,2e3)},m.onerror=t=>{console.error("\u274C Chat WebSocket error:",t),tt("disconnected")},document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(console.log("\u{1F441}\uFE0F Page visible, checking WebSocket..."),!m||m.readyState!==WebSocket.OPEN?(console.log("\u{1F504} WebSocket stale, reconnecting..."),jt()):bs())}),m.onmessage=t=>{try{let s=JSON.parse(t.data);console.log("\u{1F4E8} WS received:",s.type,s.content?.slice?.(0,50)||""),Wn(s)}catch(s){console.error("\u274C WS message error:",s,t.data?.slice?.(0,100))}}}catch(t){console.error("\u274C Failed to create WebSocket:",t),tt("disconnected")}}async function Ve(e,t){if(!m||m.readyState!==WebSocket.OPEN){u("Not connected",!0);return}if($==="intro"){if(W)try{await W,console.log("\u{1F4DC} History ready, preloaded:",v?.length||0,"messages")}catch{console.log("History load failed, continuing anyway")}!Z&&v&&v.length>0&&!Re&&(console.log("\u{1F4DC} Rendering history before first message"),Xt()),_e({skipHistory:!0})}q=!0;let s=document.createElement("div");s.className="msg user",s.textContent=e,r.appendChild(s),r.scrollTop=r.scrollHeight,de(e),U(),Z?(console.log(`\u{1F4E6} Sending to ${Z} mode session`),m.send(JSON.stringify({type:"mode_message",sparkMode:Z,text:e}))):m.send(JSON.stringify({type:"transcript",text:e,mode:t}))}function Wn(e){switch(e.type){case"ready":e.sessionId&&(Yt=e.sessionId,localStorage.setItem("spark_session_id",e.sessionId),console.log("\u{1F4CB} Session:",e.sessionId)),e.pending&&(console.log("\u23F3 Pending request detected - showing loading"),U()),console.log("\u2705 Chat ready");break;case"sync":if(console.log("\u{1F4E1} Sync message:",e.message?.source,e.message?.text?.slice(0,50)),fs(),e.message&&e.message.text){if(e.message.timestamp&&e.message.timestamp>z&&(z=e.message.timestamp),Ft(e.message.text)){console.log("\u{1F4E1} Skipping duplicate sync message (hash match)");break}if($==="chatfeed"){de(e.message.text);let t=document.createElement("div");t.className=`msg ${e.message.role==="user"?"user":"bot"}`,e.message.role==="user"?t.textContent=e.message.text:t.innerHTML=ue(e.message.text),e.message.source==="whatsapp"&&(t.title="From WhatsApp"),r.appendChild(t),lt(),e.message.role==="bot"&&ee()}else $==="intro"&&e.message.role==="bot"&&u("New message received")}break;case"thinking":console.log("\u{1F914} Server thinking..."),L&&ve.classList.contains("show")?je():U();break;case"progress":console.log("\u{1F4CA} Progress:",e.status),L&&ve.classList.contains("show")?Ys(e.status):Ds(e.status);break;case"text":if(console.log("\u2705 Text message received:",e.content?.slice?.(0,100)),document.body.classList.contains("notes-mode")&&Fe)e.content&&(Y&&(Y.style.display="none"),Fe.innerHTML=ue(e.content),j.summary=e.content,We&&(We.style.display="block"));else if(L&&ve.classList.contains("show"))At(),e.content&&R("bot",e.content);else{ee(),we("");let t=r?.querySelector(".msg.system:last-child");t?.textContent==="Transcribing..."&&t.remove(),e.content?(Bt(e.content,"bot"),console.log("\u2705 Bot message added to DOM")):console.warn("\u26A0\uFE0F Empty text content received")}break;case"transcription":if(document.body.classList.contains("notes-mode")&&He)He.textContent=e.text,j.transcription=e.text,Pe&&(Pe.style.display="block"),Y&&(Y.textContent="Summarizing...");else{let t=r?.querySelector(".msg.system:last-child");t?.textContent==="Transcribing..."&&t.remove(),Bt("\u{1F4DD} "+e.text,"bot")}break;case"audio":Fn(e.data);break;case"done":q=!1,J=!1,we(""),qe(),Us(),fs(),Se==="voice"&&!xe&&Ws();break;case"error":L&&ve.classList.contains("show")?(At(),R("bot",`Error: ${e.message||"Something went wrong"}`),J=!1):ee(),u(e.message||"Error",!0),q=!1,we("");break;case"mode_history":console.log(`\u{1F4E6} Mode history received for ${e.mode}:`,e.messages?.length||0,"messages"),e.mode&&e.messages&&(Cs[e.mode]=e.messages,Z===e.mode&&wn(e.mode));break}}async function Fn(e){st||(st=new(window.AudioContext||window.webkitAudioContext));try{let t=Uint8Array.from(atob(e),n=>n.charCodeAt(0)),s=await st.decodeAudioData(t.buffer.slice(0));if(Ae)try{Ae.stop()}catch{}Ae=st.createBufferSource(),Ae.buffer=s,Ae.connect(st.destination),Ae.start(0)}catch(t){console.error("Audio error:",t)}}var St=document.getElementById("msg-menu"),Rn=document.getElementById("menu-copy"),On=document.getElementById("menu-edit"),qn=document.getElementById("menu-delete"),F=null,Ye=null;function qs(e,t,s){F=e,e.classList.add("selected");let n=148,o=60,i=Math.min(t,window.innerWidth-n-10),a=Math.max(s-o-10,10);St.style.left=i+"px",St.style.top=a+"px",St.classList.add("show")}function $t(){St?.classList.remove("show"),F?.classList.remove("selected"),F=null}r?.addEventListener("touchstart",e=>{let t=e.target.closest(".msg");if(!t||t.classList.contains("system")||t.classList.contains("thinking"))return;let s=e.touches[0];Ye=setTimeout(()=>{e.preventDefault(),qs(t,s.clientX,s.clientY)},500)},{passive:!1});r?.addEventListener("touchend",()=>{clearTimeout(Ye)});r?.addEventListener("touchmove",()=>{clearTimeout(Ye)});document.addEventListener("touchstart",e=>{!e.target.closest("#msg-menu")&&!e.target.closest(".msg")&&$t()});Rn?.addEventListener("click",()=>{if(!F)return;let e=F.textContent||F.innerText;navigator.clipboard.writeText(e).then(()=>{u("Copied!")}).catch(()=>{u("Failed to copy",!0)}),$t()});On?.addEventListener("click",()=>{if(!F)return;let e=F.textContent||F.innerText;L&&ve?.classList.contains("show")?b&&(b.value=e,b.style.height="auto",b.style.height=Math.min(b.scrollHeight,120)+"px",ne?.classList.add("active"),b.focus()):f&&(f.value=e,f.style.height="auto",f.style.height=Math.min(f.scrollHeight,120)+"px",Ee?.classList.add("show"),f.focus()),$t()});qn?.addEventListener("click",()=>{F&&(F.remove(),u("Deleted"),$t())});jt();Kt();var ws=0;document.addEventListener("touchend",e=>{let t=Date.now();t-ws<=300&&e.preventDefault(),ws=t},{passive:!1});var X=document.getElementById("pc-status");async function Le(){try{let t=await(await fetch("/api/nodes/status")).json();X&&(X.classList.toggle("connected",t.connected),X.title=t.connected?`${t.nodeName||"PC"} connected`:"PC disconnected")}catch(e){console.error("PC status check failed:",e),X&&X.classList.remove("connected")}}Le();var Q=setInterval(Le,3e4);document.addEventListener("visibilitychange",()=>{document.hidden?Q&&(clearInterval(Q),Q=null):Q||(Le(),Q=setInterval(Le,3e4))});var Ne=null;X?.addEventListener("click",async()=>{if(Ne&&(clearInterval(Ne),Ne=null),X.classList.contains("connected")){u("PC is already connected");return}u("Waking PC...");try{let t=await(await fetch("/api/nodes/wake",{method:"POST"})).json();if(t.success){u("Wake signal sent! Waiting for PC..."),clearInterval(Q);let s=0;Ne=setInterval(async()=>{s++,await Le(),X.classList.contains("connected")?(u("PC connected! \u2705"),clearInterval(Ne),Q=setInterval(Le,3e4)):s>=24&&(u("PC did not respond",!0),clearInterval(Ne),Q=setInterval(Le,3e4))},5e3)}else u("Wake failed: "+(t.error||"Unknown error"),!0)}catch(e){u("Wake request failed",!0),console.error("WoL error:",e)}});if(window.visualViewport){let e=window.visualViewport.height;window.visualViewport.addEventListener("resize",()=>{let t=e-window.visualViewport.height;document.body.classList.toggle("keyboard-open",t>150)})}document.querySelectorAll(".shortcut").forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.msg;t&&Ve(t,"chat")})});document.getElementById("articulations-btn")?.addEventListener("click",async()=>{oe("articulate")});var fe={"spark-dev-mode":null,"spark-research-mode":null,"spark-plan-mode":null,"spark-videogen-mode":null,"spark-articulate-mode":null,"spark-dailyreports-mode":null},Un={"devteam-btn":"spark-dev-mode","researcher-btn":"spark-research-mode","plan-btn":"spark-plan-mode","videogen-btn":"spark-videogen-mode","articulations-btn":"spark-articulate-mode","todays-reports-btn":"spark-dailyreports-mode"};async function qe(){try{let s=(await(await fetch("/api/mode-sessions")).json()).sessions||{};fe["spark-dev-mode"]=null,fe["spark-research-mode"]=null,fe["spark-plan-mode"]=null,fe["spark-videogen-mode"]=null;let n={dev:"spark-dev-mode",research:"spark-research-mode",plan:"spark-plan-mode",videogen:"spark-videogen-mode"};for(let[o,i]of Object.entries(s)){let a=n[o];a&&i.active&&(fe[a]={key:i.sessionId,label:i.label,active:i.active,exists:i.exists,lastUpdated:i.lastUpdated})}_n(),Us()}catch(e){console.error("Failed to check active sessions:",e)}}function _n(){for(let[e,t]of Object.entries(Un)){let s=document.getElementById(e);if(s){let n=fe[t]!==null;s.classList.toggle("session-active",n);let o=s.querySelector(".shortcut-sub");if(o)if(n){let i=o.dataset.originalText||o.textContent;o.dataset.originalText=i,o.textContent="\u25CF Session active"}else o.dataset.originalText&&(o.textContent=o.dataset.originalText)}}}var ve=document.getElementById("session-page"),y=document.getElementById("session-messages"),b=document.getElementById("session-input"),ne=document.getElementById("session-send-btn"),Vn=document.getElementById("session-back-btn"),L=null,T=null,J=!1,dt={dev:{name:"Dev Mode",icon:"\u{1F468}\u200D\u{1F4BB}",sessionKey:"spark-dev-mode",placeholder:"Describe what you want to build or fix...",emptyTitle:"Dev Mode",emptyDesc:"Start a coding session. Describe what you want to build or fix."},research:{name:"Research Mode",icon:"\u{1F52C}",sessionKey:"spark-research-mode",placeholder:"What would you like to research?",emptyTitle:"Research Mode",emptyDesc:"Start a deep research session. Ask about any topic."},plan:{name:"Plan Mode",icon:"\u{1F4CB}",sessionKey:"spark-plan-mode",placeholder:"What do you want to plan?",emptyTitle:"Plan Mode",emptyDesc:"Start planning. Describe your project or feature."},videogen:{name:"Video Gen",icon:"\u{1F3AC}",sessionKey:"spark-videogen-mode",placeholder:"Describe the video you want to create...",emptyTitle:"Video Gen",emptyDesc:"Generate AI videos. Describe what you want to create."},articulate:{name:"Articulate",icon:"\u{1F4AC}",sessionKey:"spark-articulate-mode",placeholder:"Type text to refine...",emptyTitle:"Articulate",emptyDesc:"Refine and improve your text. Paste content to polish."},dailyreports:{name:"Daily Reports",icon:"\u{1F4CA}",sessionKey:"spark-dailyreports-mode",placeholder:"Ask about your portfolio or generate a briefing...",emptyTitle:"Daily Reports",emptyDesc:"View portfolio updates and generate market briefings."}};function Us(){let e={};for(let[t,s]of Object.entries(dt)){let n=s.sessionKey;fe[n]&&(e[t]={label:n,lastActive:Date.now(),hasHistory:!0})}localStorage.setItem("clawchat-active-sessions",JSON.stringify(e))}function Yn(){try{let e=JSON.parse(localStorage.getItem("clawchat-active-sessions")||"{}"),t=Date.now()-1440*60*1e3;for(let[s,n]of Object.entries(e))n.lastActive<t&&delete e[s];return localStorage.setItem("clawchat-active-sessions",JSON.stringify(e)),e}catch{return{}}}var xt=null;function jn(){_s(),xt=setInterval(async()=>{L&&qe()},15e3)}function _s(){xt&&(clearInterval(xt),xt=null)}async function oe(e,t){let s=dt[e];if(!s){console.error("Unknown session mode:",e);return}if(L=e,b.placeholder=s.placeholder,y.innerHTML="",t)T=t;else try{let o=await(await fetch(`/api/modes/${e}/sessions`)).json();o.sessions&&o.sessions.length>0?T=o.sessions[0].id:T=(await(await fetch(`/api/modes/${e}/sessions`,{method:"POST",headers:{"Content-Type":"application/json"}})).json()).id}catch(n){console.error("Failed to resolve session ID:",n),T=null}zn(e),ve.classList.add("show"),await Vs(e,s),jn(),setTimeout(()=>b.focus(),100)}function zn(e){let t=document.getElementById("session-header-title");if(t){let s=dt[e];t.textContent=s?`${s.icon} ${s.name}`:e}}function Jn(){ve.classList.remove("show"),L=null,T=null,J=!1,_s(),document.getElementById("session-history-panel")?.classList.remove("show")}async function Vs(e,t){try{let s;T?s=`/api/modes/${e}/sessions/${T}/history?limit=50`:s=`/api/modes/${e}/history?limit=50`;let i=(await(await fetch(s)).json()).messages||[];if(i.length===0)y.innerHTML=`
        <div class="session-empty-state">
          <div class="session-empty-icon">${t.icon}</div>
          <div class="session-empty-title">${t.emptyTitle}</div>
          <div class="session-empty-desc">${t.emptyDesc}</div>
        </div>
      `;else{for(let a of i){let p=Rt(a);p&&R(a.role==="assistant"?"bot":"user",p,a.timestamp)}y.scrollTop=y.scrollHeight}}catch(s){console.error("Failed to load session history:",s),y.innerHTML=`
      <div class="session-empty-state">
        <div class="session-empty-icon">${t.icon}</div>
        <div class="session-empty-title">${t.emptyTitle}</div>
        <div class="session-empty-desc">${t.emptyDesc}</div>
      </div>
    `}}function R(e,t,s){let n=y.querySelector(".session-empty-state");n&&n.remove();let o=$s(y),i=document.createElement("div");if(i.className=`msg ${e}`,e==="bot"?i.innerHTML=ue(t):i.textContent=t,s){let a=document.createElement("span");a.className="msg-time",a.textContent=Dt(s),i.appendChild(a)}return y.appendChild(i),(e==="user"||o)&&(y.scrollTop=y.scrollHeight),i}function Dt(e){if(!e)return"";let t=Date.now(),s=typeof e=="number"?e:new Date(e).getTime();if(isNaN(s))return"";let n=Math.floor((t-s)/1e3);if(n<60)return"just now";let o=Math.floor(n/60);if(o<60)return`${o}m ago`;let i=Math.floor(o/60);if(i<24)return`${i}h ago`;let a=Math.floor(i/24);return a===1?"yesterday":a<7?`${a}d ago`:new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function je(){At();let e=document.createElement("div");e.className="msg bot thinking",e.id="session-thinking-indicator",e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div>',y.appendChild(e),y.scrollTop=y.scrollHeight}function At(){document.getElementById("session-thinking-indicator")?.remove()}function Ys(e){let t=document.getElementById("session-thinking-indicator");if(!t)return je(),Ys(e);t.innerHTML=`
    <div class="thinking-content">
      <span class="thinking-status">${ft(e)}</span>
      <div class="thinking-dots"><span></span><span></span><span></span></div>
    </div>
  `,y&&(y.scrollTop=y.scrollHeight)}async function js(){let e=b.value.trim();if(!e&&!ye||J)return;let t=e,s=null,n=null;if(ye){let i=ye;try{if(i.type.startsWith("image/"))s=await new Promise((a,p)=>{let l=new FileReader;l.onload=()=>a(l.result),l.onerror=p,l.readAsDataURL(i)}),t=e||"What is this image?";else{let a=await new Promise((p,l)=>{let d=new FileReader;d.onload=()=>p(d.result),d.onerror=l,d.readAsDataURL(i)});n={filename:i.name,dataUrl:a},t=e||`Parse this file: ${i.name}`}}catch{u("Failed to read file",!0);return}ye=null,es?.classList.remove("show")}if(!t)return;b.value="",b.style.height="auto",ne.classList.remove("active"),ne.classList.remove("show"),J=!0;let o=n?t+` \u{1F4C4} ${n.filename}`:s?t+" \u{1F4F7}":t;if(R("user",o),je(),m&&m.readyState===WebSocket.OPEN){let i={type:"mode_message",sparkMode:L,sessionId:T,text:t};s&&(i.image=s),n&&(i.file=n),m.send(JSON.stringify(i))}else At(),R("bot","Not connected. Please try again."),J=!1}b?.addEventListener("input",()=>{let e=b.value.trim().length>0||ye;ne?.classList.toggle("show",e),ne?.classList.toggle("active",e),b.style.height="auto",b.style.height=Math.min(b.scrollHeight,120)+"px"});b?.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),js())});ne?.addEventListener("click",js);Vn?.addEventListener("click",Jn);document.getElementById("session-new-btn")?.addEventListener("click",async()=>{if(!L||y.querySelectorAll(".msg").length>0&&!confirm("Start a new session? Current session will be saved."))return;try{let n=await(await fetch(`/api/modes/${L}/sessions`,{method:"POST",headers:{"Content-Type":"application/json"}})).json();T=n.id,console.log("Created new session:",n.id)}catch(s){console.error("Failed to create new session:",s)}y.innerHTML="";let t=dt[L];t&&(y.innerHTML=`
      <div class="session-empty-state">
        <div class="session-empty-icon">${t.icon}</div>
        <div class="session-empty-title">${t.emptyTitle}</div>
        <div class="session-empty-desc">${t.emptyDesc}</div>
      </div>
    `),b?.focus()});var Gn=document.getElementById("session-upload-btn"),Ct=document.getElementById("session-file-input"),es=document.getElementById("session-attachment-preview"),nt=document.getElementById("session-attachment-icon"),ks=document.getElementById("session-attachment-name"),Ls=document.getElementById("session-attachment-size"),Kn=document.getElementById("session-remove-attachment-btn"),ye=null;Gn?.addEventListener("click",()=>Ct?.click());Ct?.addEventListener("change",e=>{let t=e.target.files?.[0];if(t){if(t.size>Ie.maxFileSize){u(`File too large (${V(t.size)}). Maximum size is ${V(Ie.maxFileSize)}.`,!0),Ct.value="";return}ye=t,ks&&(ks.textContent=t.name),Ls&&(Ls.textContent=V(t.size)),nt&&(t.type.startsWith("image/")?(nt.classList.add("image"),nt.innerHTML='<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>'):(nt.classList.remove("image"),nt.innerHTML='<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>')),es?.classList.add("show"),ne?.classList.add("show"),b?.focus(),Ct.value=""}});Kn?.addEventListener("click",()=>{ye=null,es?.classList.remove("show"),b?.value.trim()||ne?.classList.remove("show")});var zt=document.getElementById("session-history-panel"),ot=document.getElementById("session-history-list");document.getElementById("session-history-btn")?.addEventListener("click",async()=>{if(L){zt?.classList.add("show"),ot.innerHTML='<div class="session-history-empty">Loading...</div>';try{let s=(await(await fetch(`/api/modes/${L}/sessions`)).json()).sessions||[];if(s.length===0){ot.innerHTML='<div class="session-history-empty">No sessions yet</div>';return}ot.innerHTML="";for(let n of s){let o=document.createElement("div");o.className="session-history-entry",n.id===T&&o.classList.add("active");let i=n.title||"Untitled",a=Dt(n.createdAt),p=n.messageCount?`${n.messageCount} msgs`:"";o.innerHTML=`
        <div class="session-history-entry-title">${ft(i)}</div>
        <div class="session-history-entry-meta">
          <span>${a}</span>
          ${p?`<span>\xB7 ${p}</span>`:""}
        </div>
      `,o.addEventListener("click",()=>{zt?.classList.remove("show"),T=n.id,y.innerHTML="";let l=dt[L];l&&Vs(L,l)}),ot.appendChild(o)}}catch(e){console.error("Failed to load sessions:",e),ot.innerHTML='<div class="session-history-empty">Failed to load sessions</div>'}}});document.getElementById("session-history-close")?.addEventListener("click",()=>{zt?.classList.remove("show")});y?.addEventListener("touchstart",e=>{let t=e.target.closest(".msg");if(!t||t.classList.contains("system")||t.classList.contains("thinking"))return;let s=e.touches[0];Ye=setTimeout(()=>{e.preventDefault(),qs(t,s.clientX,s.clientY)},500)},{passive:!1});y?.addEventListener("touchend",()=>{clearTimeout(Ye)});y?.addEventListener("touchmove",()=>{clearTimeout(Ye)});Yn();qe();var it=setInterval(qe,1e4);document.addEventListener("visibilitychange",()=>{document.hidden?it&&(clearInterval(it),it=null):it||(qe(),it=setInterval(qe,1e4))});function ts({icon:e,title:t,subtitle:s,placeholder:n,submitText:o,onSubmit:i,activeSession:a,onViewSession:p}){let l=document.createElement("div");l.className="bottom-sheet-overlay";let d=document.createElement("div");d.className="bottom-sheet";let ze=a?`
    <button class="bottom-sheet-active-session">
      <span class="active-dot">\u25CF</span>
      View Active Session
    </button>
  `:"";d.innerHTML=`
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-icon">${e}</span>
      <div class="bottom-sheet-titles">
        <h2 class="bottom-sheet-title">${t}</h2>
        <p class="bottom-sheet-subtitle">${s}</p>
      </div>
    </div>
    ${ze}
    <textarea class="bottom-sheet-input" placeholder="${n}" rows="1"></textarea>
    <button class="bottom-sheet-submit">${o}</button>
  `,document.body.appendChild(l),document.body.appendChild(d);let B=d.querySelector(".bottom-sheet-input"),D=d.querySelector(".bottom-sheet-submit"),Je=d.querySelector(".bottom-sheet-handle"),ae=d.querySelector(".bottom-sheet-active-session");function _(){d.classList.add("closing"),d.classList.remove("visible"),l.classList.remove("visible"),setTimeout(()=>{l.remove(),d.remove()},200)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.add("visible"),d.classList.add("visible"),B.focus()})}),l.addEventListener("click",_);let ce=0,re=0,le=!1;function Ce(w){let E=w.target;(E===Je||E===d&&d.scrollTop===0)&&(ce=w.touches[0].clientY,re=ce,le=!0,d.style.transition="none")}function Pt(w){if(!le)return;re=w.touches[0].clientY;let E=re-ce;E>0&&(window.innerWidth>=520?d.style.transform=`translateX(-50%) translateY(${E}px)`:d.style.transform=`translateY(${E}px)`)}function P(){if(!le)return;le=!1,d.style.transition="",re-ce>100?_():window.innerWidth>=520?d.style.transform="translateX(-50%) translateY(0)":d.style.transform="translateY(0)"}d.addEventListener("touchstart",Ce,{passive:!0}),d.addEventListener("touchmove",Pt,{passive:!0}),d.addEventListener("touchend",P);function Te(w){w.key==="Escape"&&(_(),document.removeEventListener("keydown",Te))}document.addEventListener("keydown",Te);function Me(){let w=B.value.trim();if(!w){B.classList.add("error"),setTimeout(()=>B.classList.remove("error"),300);return}_(),i(w)}return D.addEventListener("click",Me),ae&&p&&ae.addEventListener("click",()=>{_(),p(a)}),B.addEventListener("keydown",w=>{w.key==="Enter"&&(w.metaKey||w.ctrlKey)&&(w.preventDefault(),Me())}),B.addEventListener("input",()=>{B.style.height="auto",B.style.height=Math.min(B.scrollHeight,120)+"px"}),{close:_}}document.getElementById("devteam-btn")?.addEventListener("click",async()=>{let e=!1;try{let s=await(await fetch("/api/modes/dev/sessions")).json();e=s.sessions&&s.sessions.length>0}catch{}e?oe("dev"):ts({icon:"\u{1F468}\u200D\u{1F4BB}",title:"Dev Mode",subtitle:"Senior engineer \u2014 reads code, writes tests, commits",placeholder:"Describe the task or issue to fix...",submitText:"Start Dev Session",onSubmit:async t=>{await oe("dev"),m&&m.readyState===WebSocket.OPEN&&(R("user",t),je(),J=!0,m.send(JSON.stringify({type:"mode_message",sparkMode:"dev",sessionId:T,text:t})))}})});document.getElementById("researcher-btn")?.addEventListener("click",async()=>{let e=!1;try{let s=await(await fetch("/api/modes/research/sessions")).json();e=s.sessions&&s.sessions.length>0}catch{}e?oe("research"):ts({icon:"\u{1F52C}",title:"Research Mode",subtitle:"Deep research with sources and analysis",placeholder:"What topic do you want to research?",submitText:"Start Research",onSubmit:async t=>{await oe("research"),m&&m.readyState===WebSocket.OPEN&&(R("user",t),je(),J=!0,m.send(JSON.stringify({type:"mode_message",sparkMode:"research",sessionId:T,text:t})))}})});document.getElementById("plan-btn")?.addEventListener("click",async()=>{let e=!1;try{let s=await(await fetch("/api/modes/plan/sessions")).json();e=s.sessions&&s.sessions.length>0}catch{}e?oe("plan"):ts({icon:"\u{1F4CB}",title:"Plan Mode",subtitle:"Technical specs with phases and risks",placeholder:"What do you want to plan?",submitText:"Start Planning",onSubmit:async t=>{await oe("plan"),m&&m.readyState===WebSocket.OPEN&&(R("user",t),je(),J=!0,m.send(JSON.stringify({type:"mode_message",sparkMode:"plan",sessionId:T,text:t})))}})});document.getElementById("videogen-btn")?.addEventListener("click",()=>{Xn()});function Xn(){let e=document.createElement("div");e.className="bottom-sheet-overlay";let t=document.createElement("div");t.className="bottom-sheet",t.innerHTML=`
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-icon">\u{1F3AC}</span>
      <div class="bottom-sheet-titles">
        <h2 class="bottom-sheet-title">Video Gen</h2>
        <p class="bottom-sheet-subtitle" id="videogen-subtitle">AI video generation</p>
      </div>
    </div>
    
    <div class="bottom-sheet-row">
      <label class="bottom-sheet-label">Workflow</label>
      <div class="option-selector" id="videogen-workflow">
        <button class="option-pill selected" data-value="text2video">Text \u2192 Video</button>
        <button class="option-pill" data-value="image2video">Image \u2192 Video</button>
        <button class="option-pill" data-value="faceswap">Face Swap</button>
      </div>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-prompt-row">
      <label class="bottom-sheet-label">Prompt</label>
      <textarea class="bottom-sheet-input" id="videogen-prompt" placeholder="Describe the video you want to create..." rows="2"></textarea>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-image-row" style="display:none;">
      <label class="bottom-sheet-label" id="videogen-image-label">Reference Image</label>
      <div class="image-upload-area" id="videogen-upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <div class="upload-text">Tap to upload image</div>
        <div class="upload-hint" id="videogen-image-hint">For image-to-video generation</div>
      </div>
      <input type="file" id="videogen-file-input" accept="image/*" style="display:none">
    </div>
    
    <div class="bottom-sheet-row" id="videogen-video-row" style="display:none;">
      <label class="bottom-sheet-label">Target Video</label>
      <div class="image-upload-area" id="videogen-video-upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
        </div>
        <div class="upload-text">Tap to upload video or paste URL</div>
        <div class="upload-hint">YouTube/video URL or upload file</div>
      </div>
      <input type="file" id="videogen-video-file-input" accept="video/*" style="display:none">
      <input type="text" class="bottom-sheet-input" id="videogen-video-url" placeholder="Or paste YouTube/video URL..." style="margin-top:8px; display:none;">
    </div>
    
    <div class="bottom-sheet-row" id="videogen-aspect-row">
      <label class="bottom-sheet-label">Aspect Ratio</label>
      <div class="option-selector" id="videogen-aspect">
        <button class="option-pill selected" data-value="16:9">16:9</button>
        <button class="option-pill" data-value="9:16">9:16</button>
        <button class="option-pill" data-value="1:1">1:1</button>
      </div>
    </div>
    
    <div class="bottom-sheet-row" id="videogen-duration-row">
      <label class="bottom-sheet-label">Duration</label>
      <div class="option-selector" id="videogen-duration">
        <button class="option-pill selected" data-value="5">5 seconds</button>
        <button class="option-pill" data-value="10">10 seconds</button>
      </div>
    </div>
    
    <button class="bottom-sheet-submit" id="videogen-submit">Generate Video</button>
  `,document.body.appendChild(e),document.body.appendChild(t);let s=t.querySelector("#videogen-subtitle"),n=t.querySelector("#videogen-workflow"),o=t.querySelector("#videogen-prompt-row"),i=t.querySelector("#videogen-prompt"),a=t.querySelector("#videogen-image-row"),p=t.querySelector("#videogen-image-label"),l=t.querySelector("#videogen-image-hint"),d=t.querySelector("#videogen-upload-area"),ze=t.querySelector("#videogen-file-input"),B=t.querySelector("#videogen-video-row"),D=t.querySelector("#videogen-video-upload-area"),Je=t.querySelector("#videogen-video-file-input"),ae=t.querySelector("#videogen-video-url"),_=t.querySelector("#videogen-aspect-row"),ce=t.querySelector("#videogen-aspect"),re=t.querySelector("#videogen-duration-row"),le=t.querySelector("#videogen-duration"),Ce=t.querySelector("#videogen-submit"),Pt=t.querySelector(".bottom-sheet-handle"),P="text2video",Te="16:9",Me="5",w=null,E=null,Ge=null,Ke=null,G=null;function ut(){t.classList.add("closing"),t.classList.remove("visible"),e.classList.remove("visible"),setTimeout(()=>{e.remove(),t.remove()},200)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.classList.add("visible"),t.classList.add("visible"),i.focus()})}),e.addEventListener("click",ut);let mt=0,pt=0,gt=!1;function zs(h){let c=h.target;(c===Pt||c===t&&t.scrollTop===0)&&(mt=h.touches[0].clientY,pt=mt,gt=!0,t.style.transition="none")}function Js(h){if(!gt)return;pt=h.touches[0].clientY;let c=pt-mt;c>0&&(window.innerWidth>=520?t.style.transform=`translateX(-50%) translateY(${c}px)`:t.style.transform=`translateY(${c}px)`)}function Gs(){if(!gt)return;gt=!1,t.style.transition="",pt-mt>100?ut():window.innerWidth>=520?t.style.transform="translateX(-50%) translateY(0)":t.style.transform="translateY(0)"}t.addEventListener("touchstart",zs,{passive:!0}),t.addEventListener("touchmove",Js,{passive:!0}),t.addEventListener("touchend",Gs);function ns(h){h.key==="Escape"&&(ut(),document.removeEventListener("keydown",ns))}document.addEventListener("keydown",ns);function Ks(){switch(o.style.display="block",a.style.display="none",B.style.display="none",_.style.display="block",re.style.display="block",ae.style.display="none",P){case"text2video":s.textContent="Generate video from text prompt",i.placeholder="Describe the video you want to create...",Ce.textContent="Generate Video";break;case"image2video":s.textContent="Animate an image into video",i.placeholder="Describe the motion/action (optional)...",a.style.display="block",p.textContent="Source Image",l.textContent="Image to animate",Ce.textContent="Generate Video";break;case"faceswap":s.textContent="Swap face in a video",o.style.display="none",a.style.display="block",B.style.display="block",_.style.display="none",re.style.display="none",p.textContent="Face Image",l.textContent="Photo with the face to use",ae.style.display="block",Ce.textContent="Swap Face";break}}n.addEventListener("click",h=>{let c=h.target.closest(".option-pill");c&&(n.querySelectorAll(".option-pill").forEach(x=>x.classList.remove("selected")),c.classList.add("selected"),P=c.dataset.value,Ks())}),ce.addEventListener("click",h=>{let c=h.target.closest(".option-pill");c&&(ce.querySelectorAll(".option-pill").forEach(x=>x.classList.remove("selected")),c.classList.add("selected"),Te=c.dataset.value)}),le.addEventListener("click",h=>{let c=h.target.closest(".option-pill");c&&(le.querySelectorAll(".option-pill").forEach(x=>x.classList.remove("selected")),c.classList.add("selected"),Me=c.dataset.value)});function Xs(){w=null,E=null,d.classList.remove("has-image"),d.innerHTML=`
      <div class="upload-icon">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="upload-text">Tap to upload image</div>
      <div class="upload-hint" id="videogen-image-hint">${P==="faceswap"?"Photo with the face to use":"Image to animate"}</div>
    `,ze.value=""}function os(){Ge=null,Ke=null,G=null,D.classList.remove("has-image"),D.innerHTML=`
      <div class="upload-icon">
        <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
      </div>
      <div class="upload-text">Tap to upload video or paste URL</div>
      <div class="upload-hint">YouTube/video URL or upload file</div>
    `,Je.value="",ae.value=""}d.addEventListener("click",()=>{w||ze.click()}),ze.addEventListener("change",async h=>{let c=h.target.files?.[0];if(!c)return;w=c;let x=new FileReader;x.onload=Ht=>{E=Ht.target.result,d.classList.add("has-image"),d.innerHTML=`
        <div class="image-preview-container">
          <img class="image-preview-thumb" src="${E}" alt="Preview">
          <div class="image-preview-info">
            <div class="image-preview-name">${c.name}</div>
            <div class="image-preview-size">${V(c.size)}</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-image">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-image")?.addEventListener("click",Wt=>{Wt.stopPropagation(),Xs()})},x.readAsDataURL(c)}),D.addEventListener("click",()=>{!Ge&&!G&&Je.click()}),Je.addEventListener("change",async h=>{let c=h.target.files?.[0];if(!c)return;Ge=c,G=null;let x=new FileReader;x.onload=Ht=>{Ke=Ht.target.result,D.classList.add("has-image"),D.innerHTML=`
        <div class="image-preview-container">
          <div class="upload-icon" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--msg-bot);border-radius:8px;">
            <svg viewBox="0 0 24 24" style="width:30px;height:30px;stroke:var(--text-secondary);fill:none;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </div>
          <div class="image-preview-info">
            <div class="image-preview-name">${c.name}</div>
            <div class="image-preview-size">${V(c.size)}</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-video">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-video")?.addEventListener("click",Wt=>{Wt.stopPropagation(),os()})},x.readAsDataURL(c)}),ae.addEventListener("input",h=>{let c=h.target.value.trim();c&&(c.includes("youtube.com")||c.includes("youtu.be")||c.includes("http"))&&(G=c,Ge=null,Ke=null,D.classList.add("has-image"),D.innerHTML=`
        <div class="image-preview-container">
          <div class="upload-icon" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--msg-bot);border-radius:8px;">
            <svg viewBox="0 0 24 24" style="width:30px;height:30px;stroke:var(--text-secondary);fill:none;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </div>
          <div class="image-preview-info">
            <div class="image-preview-name" style="word-break:break-all;">${c.length>40?c.substring(0,40)+"...":c}</div>
            <div class="image-preview-size">Video URL</div>
          </div>
          <button class="image-remove-btn" id="videogen-remove-video">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `,t.querySelector("#videogen-remove-video")?.addEventListener("click",x=>{x.stopPropagation(),os()}))}),Ce.addEventListener("click",()=>{let h=i.value.trim();if(P==="text2video"){if(!h){i.classList.add("error"),setTimeout(()=>i.classList.remove("error"),300);return}}else if(P==="image2video"){if(!E){d.style.borderColor="var(--red)",setTimeout(()=>d.style.borderColor="",300);return}}else if(P==="faceswap"){if(!E){d.style.borderColor="var(--red)",setTimeout(()=>d.style.borderColor="",300);return}if(!Ke&&!G){D.style.borderColor="var(--red)",setTimeout(()=>D.style.borderColor="",300);return}}if(ut(),_e(),P==="text2video"){let c=`/video --ratio ${Te} --duration ${Me}s ${h}`;Ve(c,"chat")}else if(P==="image2video"){let c=`/video --ratio ${Te} --duration ${Me}s`;h&&(c+=` ${h}`),Qn(c,E)}else if(P==="faceswap"){let c="/faceswap";G&&(c+=` --video-url ${G}`),Zn(c,E,Ke,G)}}),i.addEventListener("input",()=>{i.style.height="auto",i.style.height=Math.min(i.scrollHeight,120)+"px"})}function Qn(e,t){if(!m||m.readyState!==WebSocket.OPEN){u("Not connected",!0);return}q=!0;let s=document.createElement("div");s.className="msg user",s.textContent=e+" \u{1F4F7}",r.appendChild(s),r.scrollTop=r.scrollHeight,de(e),U(),m.send(JSON.stringify({type:"transcript",text:e,image:t,mode:"chat"}))}function Zn(e,t,s,n){if(!m||m.readyState!==WebSocket.OPEN){u("Not connected",!0);return}q=!0;let o=document.createElement("div");o.className="msg user",o.textContent=e+" \u{1F3AD}\u{1F4F7}\u{1F3AC}",r.appendChild(o),r.scrollTop=r.scrollHeight,de(e),U(),m.send(JSON.stringify({type:"transcript",text:e,image:t,video:s,videoUrl:n,mode:"chat"}))}var eo=Ve;Ve=async function(e,t){xs?await to(e):await eo(e,t)};async function to(e){if(!e.trim())return;$==="intro"&&_e({skipHistory:!0});let t=document.createElement("div");t.className="msg user",t.textContent=e,r.appendChild(t),r.scrollTop=r.scrollHeight,U();try{let n=await(await fetch("/api/articulate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})})).json();if(ee(),n.result){let o=document.createElement("div");o.className="msg bot",o.textContent=n.result,r.appendChild(o),r.scrollTop=r.scrollHeight}}catch{ee(),u("Failed to refine text",!0)}}document.getElementById("todays-reports-btn")?.addEventListener("click",async()=>{oe("dailyreports");let e=document.createElement("div");e.className="msg system",e.textContent="Loading today's reports...",y.appendChild(e);try{let s=await(await fetch("/api/reports/today")).json();if(e.remove(),!s.reports?.length){R("bot","No reports found for today. Ask me to generate a market briefing!");return}R("system",`\u{1F4CA} Today's Reports (${s.reports.length})`),s.reports.forEach(n=>{R("bot",n.summary)})}catch(t){e.textContent="Failed to load reports",console.error("Failed to load reports:",t)}});var ss=document.getElementById("attachment-preview"),wt=document.getElementById("attachment-icon"),so=document.getElementById("attachment-name"),no=document.getElementById("attachment-size"),oo=document.getElementById("remove-attachment-btn"),be=null;rn?.addEventListener("click",()=>kt?.click());kt?.addEventListener("change",e=>{let t=e.target.files?.[0];if(t){if(t.size>Ie.maxFileSize){u(`File too large (${V(t.size)}). Maximum size is ${V(Ie.maxFileSize)}.`,!0),kt.value="";return}be=t,so.textContent=t.name,no.textContent=V(t.size),t.type.startsWith("image/")?(wt.classList.add("image"),wt.innerHTML='<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>'):(wt.classList.remove("image"),wt.innerHTML='<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>'),ss?.classList.add("show"),Ee?.classList.add("show"),Ue?.classList.add("hidden"),f?.focus(),kt.value=""}});oo?.addEventListener("click",()=>{be=null,ss?.classList.remove("show"),f?.value.trim()||(Ee?.classList.remove("show"),Ue?.classList.remove("hidden"))});Qt=async function(){let e=f?.value.trim()||"";if(!e&&!be||q)return;let t=e,s=null,n=null;if(be){let o=be;try{if(o.type.startsWith("image/"))s=await new Promise((i,a)=>{let p=new FileReader;p.onload=()=>i(p.result),p.onerror=a,p.readAsDataURL(o)}),t=e||"What is this image?";else{let i=await new Promise((a,p)=>{let l=new FileReader;l.onload=()=>a(l.result),l.onerror=p,l.readAsDataURL(o)});n={filename:o.name,dataUrl:i},t=e||`Parse this file: ${o.name}`}}catch{u("Failed to read file",!0);return}be=null,ss?.classList.remove("show")}t&&(f.value="",f.style.height="auto",Ee?.classList.remove("show"),Ue?.classList.remove("hidden"),s?io(t,s):n?ao(t,n):Ve(t,"chat"))};function io(e,t){if(!m||m.readyState!==WebSocket.OPEN){u("Not connected",!0);return}q=!0;let s=Bt(e+" \u{1F4F7}","user",{userInitiated:!0});U(),m.send(JSON.stringify({type:"transcript",text:e,image:t,mode:"chat"}))}function ao(e,t){if(!m||m.readyState!==WebSocket.OPEN){u("Not connected",!0);return}q=!0;let s=Bt(e+` \u{1F4C4} ${t.filename}`,"user",{userInitiated:!0});U(),m.send(JSON.stringify({type:"transcript",text:e,file:t,mode:"chat"}))}
